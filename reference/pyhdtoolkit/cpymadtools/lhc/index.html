
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.0">
    
    
      
        <title>Lhc - PyhDToolkit</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:300,400,400i,700%7CFira+Code&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu Mono";--md-code-font-family:"Fira Code"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <script>function __prefix(e){return new URL("../../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-pyhdtoolkitcpymadtoolslhc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="PyhDToolkit" class="md-header__button md-logo" aria-label="PyhDToolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyhDToolkit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lhc
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/fsoubelet/PyhDToolkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PyhDToolkit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="PyhDToolkit" class="md-nav__button md-logo" aria-label="PyhDToolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PyhDToolkit
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/fsoubelet/PyhDToolkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PyhDToolkit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/About_PyhDToolkit/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Pyhdtoolkit
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pyhdtoolkit" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Pyhdtoolkit
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_2" type="checkbox" id="__nav_4_1_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_2">
          Cpymadtools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cpymadtools" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpymadtools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        Constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../correctors/" class="md-nav__link">
        Correctors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../generators/" class="md-nav__link">
        Generators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Lhc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Lhc
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply_lhc_colinearity_knob" class="md-nav__link">
    apply_lhc_colinearity_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply_lhc_coupling_knob" class="md-nav__link">
    apply_lhc_coupling_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply_lhc_rigidity_waist_shift_knob" class="md-nav__link">
    apply_lhc_rigidity_waist_shift_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deactivate_lhc_arc_sextupoles" class="md-nav__link">
    deactivate_lhc_arc_sextupoles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install_ac_dipole_as_kicker" class="md-nav__link">
    install_ac_dipole_as_kicker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install_ac_dipole_as_matrix" class="md-nav__link">
    install_ac_dipole_as_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_lhc_beams" class="md-nav__link">
    make_lhc_beams
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_lhc_thin" class="md-nav__link">
    make_lhc_thin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_sixtrack_output" class="md-nav__link">
    make_sixtrack_output
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#match_no_coupling_through_ripkens" class="md-nav__link">
    match_no_coupling_through_ripkens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#power_landau_octupoles" class="md-nav__link">
    power_landau_octupoles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re_cycle_sequence" class="md-nav__link">
    re_cycle_sequence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_lhc_bump_flags" class="md-nav__link">
    reset_lhc_bump_flags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vary_independent_ir_quadrupoles" class="md-nav__link">
    vary_independent_ir_quadrupoles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../matching/" class="md-nav__link">
        Matching
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../orbit/" class="md-nav__link">
        Orbit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parameters/" class="md-nav__link">
        Parameters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../plotters/" class="md-nav__link">
        Plotters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ptc/" class="md-nav__link">
        Ptc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../special/" class="md-nav__link">
        Special
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../track/" class="md-nav__link">
        Track
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tune/" class="md-nav__link">
        Tune
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../twiss/" class="md-nav__link">
        Twiss
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_3" type="checkbox" id="__nav_4_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_3">
          Maths
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Maths" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_3">
          <span class="md-nav__icon md-icon"></span>
          Maths
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/nonconvex_phase_sync/" class="md-nav__link">
        Nonconvex Phase Sync
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/stats_fitting/" class="md-nav__link">
        Stats Fitting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_4" type="checkbox" id="__nav_4_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_4">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Models" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_4">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/beam/" class="md-nav__link">
        Beam
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/htc/" class="md-nav__link">
        Htc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/madx/" class="md-nav__link">
        Madx
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_5" type="checkbox" id="__nav_4_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_5">
          Optics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Optics" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_5">
          <span class="md-nav__icon md-icon"></span>
          Optics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/beam/" class="md-nav__link">
        Beam
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/ripken/" class="md-nav__link">
        Ripken
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/twiss/" class="md-nav__link">
        Twiss
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_6" type="checkbox" id="__nav_4_1_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_6">
          Plotting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plotting" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_6">
          <span class="md-nav__icon md-icon"></span>
          Plotting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plotting/helpers/" class="md-nav__link">
        Helpers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plotting/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_7" type="checkbox" id="__nav_4_1_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_7">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_7">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/cmdline/" class="md-nav__link">
        Cmdline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/contexts/" class="md-nav__link">
        Contexts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/defaults/" class="md-nav__link">
        Defaults
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/executors/" class="md-nav__link">
        Executors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/htc_monitor/" class="md-nav__link">
        Htc Monitor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/operations/" class="md-nav__link">
        Operations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/printutil/" class="md-nav__link">
        Printutil
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply_lhc_colinearity_knob" class="md-nav__link">
    apply_lhc_colinearity_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply_lhc_coupling_knob" class="md-nav__link">
    apply_lhc_coupling_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply_lhc_rigidity_waist_shift_knob" class="md-nav__link">
    apply_lhc_rigidity_waist_shift_knob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deactivate_lhc_arc_sextupoles" class="md-nav__link">
    deactivate_lhc_arc_sextupoles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install_ac_dipole_as_kicker" class="md-nav__link">
    install_ac_dipole_as_kicker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install_ac_dipole_as_matrix" class="md-nav__link">
    install_ac_dipole_as_matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_lhc_beams" class="md-nav__link">
    make_lhc_beams
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_lhc_thin" class="md-nav__link">
    make_lhc_thin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_sixtrack_output" class="md-nav__link">
    make_sixtrack_output
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#match_no_coupling_through_ripkens" class="md-nav__link">
    match_no_coupling_through_ripkens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#power_landau_octupoles" class="md-nav__link">
    power_landau_octupoles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re_cycle_sequence" class="md-nav__link">
    re_cycle_sequence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset_lhc_bump_flags" class="md-nav__link">
    reset_lhc_bump_flags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vary_independent_ir_quadrupoles" class="md-nav__link">
    vary_independent_ir_quadrupoles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/fsoubelet/PyhDToolkit/edit/main/reference/pyhdtoolkit/cpymadtools/lhc.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="module-pyhdtoolkitcpymadtoolslhc">Module pyhdtoolkit.cpymadtools.lhc</h1>
<p>Module cpymadtools.special</p>
<hr />
<p>Created on 2020.02.03</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Module cpymadtools.special</span>

<span class="sd">--------------------------</span>

<span class="sd">Created on 2020.02.03</span>

<span class="sd">:author: Felix Soubelet (felix.soubelet@cern.ch)</span>

<span class="sd">A module with functions to perform MAD-X actions with a cpymad.madx.Madx object, that are specific to LHC</span>

<span class="sd">and HLLHC machines.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">cpymad.madx</span> <span class="kn">import</span> <span class="n">Madx</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">pyhdtoolkit.cpymadtools.constants</span> <span class="kn">import</span> <span class="p">(</span>

    <span class="n">LHC_ANGLE_FLAGS</span><span class="p">,</span>

    <span class="n">LHC_CROSSING_ANGLE_FLAGS</span><span class="p">,</span>

    <span class="n">LHC_EXPERIMENT_STATE_FLAGS</span><span class="p">,</span>

    <span class="n">LHC_IP2_SPECIAL_FLAG</span><span class="p">,</span>

    <span class="n">LHC_IP_OFFSET_FLAGS</span><span class="p">,</span>

    <span class="n">LHC_PARALLEL_SEPARATION_FLAGS</span><span class="p">,</span>

<span class="p">)</span>

<span class="c1"># ----- Setup Utlites ----- #</span>

<span class="k">def</span> <span class="nf">make_lhc_beams</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">7000</span><span class="p">,</span> <span class="n">emittance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.75e-6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Define beams with default configuratons for `LHCB1` and `LHCB2` sequences.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        energy (float): beam energy in GeV. Defaults to 6500.</span>

<span class="sd">        emittance (float): emittance in meters, which will be used to calculate geometric emittance,</span>

<span class="sd">            then fed to the BEAM command.</span>

<span class="sd">    Keyword Args:</span>

<span class="sd">        Any keyword argument that can be given to the MAD-X BEAM command.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Making default beams for &#39;lhcb1&#39; and &#39;lhbc2&#39; sequences&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;NRJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;brho&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">clight</span>

    <span class="n">geometric_emit</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;geometric_emit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emittance</span> <span class="o">/</span> <span class="p">(</span><span class="n">energy</span> <span class="o">/</span> <span class="mf">0.938</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Defining beam for sequence &#39;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">beam</span><span class="p">(</span>

            <span class="n">sequence</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

            <span class="n">particle</span><span class="o">=</span><span class="s2">&quot;proton&quot;</span><span class="p">,</span>

            <span class="n">bv</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

            <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>

            <span class="n">npart</span><span class="o">=</span><span class="mf">1.15e11</span><span class="p">,</span>

            <span class="n">ex</span><span class="o">=</span><span class="n">geometric_emit</span><span class="p">,</span>

            <span class="n">ey</span><span class="o">=</span><span class="n">geometric_emit</span><span class="p">,</span>

            <span class="n">sige</span><span class="o">=</span><span class="mf">4.5e-4</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

<span class="k">def</span> <span class="nf">power_landau_octupoles</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">mo_current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">defective_arc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Power the Landau octupoles in the (HL)LHC.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        mo_current (float): MO powering in Amps.</span>

<span class="sd">        beam (int): beam to use.</span>

<span class="sd">        defective_arc: If set to `True`, the KOD in Arc 56 are powered for less Imax.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">brho</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">nrj</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">clight</span>  <span class="c1"># clight is MAD-X constant</span>

    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">madx_error</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>

            <span class="s2">&quot;The global MAD-X variable &#39;NRJ&#39; should have been set in the optics files but is not defined.&quot;</span>

        <span class="p">)</span>

        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;No &#39;NRJ&#39; variable found in scripts&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">madx_error</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Powering Landau Octupoles, beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">nrj</span><span class="si">}</span><span class="s2"> GeV with </span><span class="si">{</span><span class="n">mo_current</span><span class="si">}</span><span class="s2"> A.&quot;</span><span class="p">)</span>

    <span class="n">strength</span> <span class="o">=</span> <span class="n">mo_current</span> <span class="o">/</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Imax_MO</span> <span class="o">*</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Kmax_MO</span> <span class="o">/</span> <span class="n">brho</span>

    <span class="n">beam</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">beam</span>

    <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">_all_lhc_arcs</span><span class="p">(</span><span class="n">beam</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="s2">&quot;FD&quot;</span><span class="p">:</span>

            <span class="n">octupole</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KO</span><span class="si">{</span><span class="n">fd</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">arc</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Powering element &#39;</span><span class="si">{</span><span class="n">octupole</span><span class="si">}</span><span class="s2">&#39; at </span><span class="si">{</span><span class="n">strength</span><span class="si">}</span><span class="s2"> Amps&quot;</span><span class="p">)</span>

            <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">octupole</span><span class="p">]</span> <span class="o">=</span> <span class="n">strength</span>

    <span class="k">if</span> <span class="n">defective_arc</span> <span class="ow">and</span> <span class="p">(</span><span class="n">beam</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;KOD.A56B1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strength</span> <span class="o">*</span> <span class="mf">4.65</span> <span class="o">/</span> <span class="mi">6</span>  <span class="c1"># defective MO group</span>

<span class="k">def</span> <span class="nf">deactivate_lhc_arc_sextupoles</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Deactivate all arc sextupoles in the (HL)LHC.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        beam (int): beam to use.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># KSF1 and KSD2 - Strong sextupoles of sectors 81/12/45/56</span>

    <span class="c1"># KSF2 and KSD1 - Weak sextupoles of sectors 81/12/45/56</span>

    <span class="c1"># Rest: Weak sextupoles in sectors 78/23/34/67</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deactivating all arc sextupoles for beam </span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">beam</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">beam</span>

    <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">_all_lhc_arcs</span><span class="p">(</span><span class="n">beam</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="s2">&quot;FD&quot;</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>

                <span class="n">sextupole</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KS</span><span class="si">{</span><span class="n">fd</span><span class="si">}{</span><span class="n">i</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">arc</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;De-powering element &#39;</span><span class="si">{</span><span class="n">sextupole</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">sextupole</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">def</span> <span class="nf">apply_lhc_colinearity_knob</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">colinearity_knob_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ir</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Applies the LHC colinearity knob. If you don&#39;t know what this is, you should not be using this</span>

<span class="sd">    function.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        colinearity_knob_value (float): Units of the colinearity knob to apply. Defaults to 0 so users</span>

<span class="sd">            don&#39;t mess up local coupling by mistake. This should be a positive integer, normally between 1</span>

<span class="sd">            and 10.</span>

<span class="sd">        ir (int): The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</span>

<span class="sd">            Classically 1 or 5.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Colinearity knob with a unit setting of </span><span class="si">{</span><span class="n">colinearity_knob_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span>

    <span class="n">knob_variables</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KQSX3.R</span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;KQSX3.L</span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># MQSX IP coupling correctors</span>

    <span class="n">right_knob</span><span class="p">,</span> <span class="n">left_knob</span> <span class="o">=</span> <span class="n">knob_variables</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span> <span class="o">=</span> <span class="n">colinearity_knob_value</span> <span class="o">*</span> <span class="mf">1e-4</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set &#39;</span><span class="si">{</span><span class="n">right_knob</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">colinearity_knob_value</span> <span class="o">*</span> <span class="mf">1e-4</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set &#39;</span><span class="si">{</span><span class="n">left_knob</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_lhc_rigidity_waist_shift_knob</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">rigidty_waist_shift_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ir</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Applies the LHC rigidity waist shift knob, moving the waist left or right of IP. If you don&#39;t know what</span>

<span class="sd">    this is, you should not be using this function. The waist shift is done by unbalancing the</span>

<span class="sd">    triplet powering knob of the left and right-hand sides of the IP.</span>

<span class="sd">    Warning: Applying the shift will modify your tunes and most likely flip them, making a subsequent</span>

<span class="sd">    matching impossible if your lattice has coupling. To avoid this, match to tunes split further apart</span>

<span class="sd">    before applying the waist shift knob, and then match to the desired working point. For instance for</span>

<span class="sd">    the LHC, matching to (62.27, 60.36) before applying and afterwards rematching to (62.31, 60.32) usually</span>

<span class="sd">    works well.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        rigidty_waist_shift_value (float): Units of the rigidity waist shift knob (positive values only).</span>

<span class="sd">        ir (int): The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</span>

<span class="sd">            Classically 1 or 5.</span>

<span class="sd">        side (str): Which side of the IP to move the waist to, determines a sign in the calculation.</span>

<span class="sd">            Defaults to &#39;left&#39;, which means s_waist &lt; s_ip (and setting it to &#39;right&#39; would move the waist</span>

<span class="sd">            to s_waist &gt; s_ip).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying Rigidity Waist Shift knob with a unit setting of </span><span class="si">{</span><span class="n">rigidty_waist_shift_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span>

    <span class="n">right_knob</span><span class="p">,</span> <span class="n">left_knob</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;kqx.r</span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;kqx.l</span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># IP triplet default knob (no trims)</span>

    <span class="n">current_right_knob</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span>

    <span class="n">current_left_knob</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rigidty_waist_shift_value</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_right_knob</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rigidty_waist_shift_value</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_left_knob</span>

    <span class="k">elif</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rigidty_waist_shift_value</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_right_knob</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rigidty_waist_shift_value</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_left_knob</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Given side &#39;</span><span class="si">{</span><span class="n">side</span><span class="si">}</span><span class="s2">&#39; invalid, only &#39;left&#39; and &#39;right&#39; are accepted values.&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for parameter &#39;side&#39;.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set &#39;</span><span class="si">{</span><span class="n">right_knob</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">right_knob</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set &#39;</span><span class="si">{</span><span class="n">left_knob</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">left_knob</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_lhc_coupling_knob</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">coupling_knob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">telescopic_squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Applies the LHC coupling knob to reach the desired C- value.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        coupling_knob (float): Desired value for the Cminus, typically a few units of 1E-3. Defaults to 0</span>

<span class="sd">        so users don&#39;t mess up coupling by mistake</span>

<span class="sd">        beam (int): beam to apply the knob to, defaults to beam 1.</span>

<span class="sd">        telescopic_squeeze (bool): if set to True, uses the knobs for Telescopic Squeeze configuration.</span>

<span class="sd">            Defaults to `True`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Applying coupling knob&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;_sq&quot;</span> <span class="k">if</span> <span class="n">telescopic_squeeze</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="n">knob_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CMRS.b</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Knob &#39;</span><span class="si">{</span><span class="n">knob_name</span><span class="si">}</span><span class="s2">&#39; is </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">knob_name</span><span class="p">]</span><span class="si">}</span><span class="s2"> before implementation&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">knob_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coupling_knob</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set &#39;</span><span class="si">{</span><span class="n">knob_name</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">knob_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">install_ac_dipole_as_kicker</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

    <span class="n">deltaqx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>

    <span class="n">deltaqy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>

    <span class="n">sigma_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>

    <span class="n">sigma_y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>

    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

    <span class="n">start_turn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>

    <span class="n">ramp_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>

    <span class="n">top_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6600</span><span class="p">,</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Installs an AC dipole for (HL)LHC BEAM 1 OR 2 ONLY.</span>

<span class="sd">    The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in</span>

<span class="sd">    MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a</span>

<span class="sd">    kicker element so that its effect can be seen on particle orbit in tracking. It DOES NOT affect TWISS</span>

<span class="sd">    functions. See https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002 (part III).</span>

<span class="sd">    This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or</span>

<span class="sd">    `make_lhc_beams` function), matched to your desired working point and made a TWISS.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        deltaqx (float): the deltaQx (horizontal tune excitation) used by the AC dipole.</span>

<span class="sd">        deltaqy (float): the deltaQy (vertical tune excitation) used by the AC dipole.</span>

<span class="sd">        sigma_x (float): the horizontal amplitude to drive the beam to, in bunch sigma.</span>

<span class="sd">        sigma_y (float): the vertical amplitude to drive the beam to, in bunch sigma.</span>

<span class="sd">        beam (int): the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</span>

<span class="sd">        start_turn (int): the turn at which to start ramping up the AC dipole. Defaults to 100.</span>

<span class="sd">        ramp_turns (int): the number of turns to use for the ramp-up and the ramp-down of the AC dipole.</span>

<span class="sd">            This number is important in order to preserve the adiabaticity of the cycle. Defaults to 2000</span>

<span class="sd">            as in the LHC.</span>

<span class="sd">        top_turns (int): the number of turns to drive the beam for. Defaults to 6600 as in the LHC.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This AC Dipole is implemented as a kicker and will not affect TWISS functions!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;This routine should be done after &#39;match&#39;, &#39;twiss&#39; and &#39;makethin&#39; for the appropriate beam&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">top_turns</span> <span class="o">&gt;</span> <span class="mi">6600</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="sa">f</span><span class="s2">&quot;Configuring the AC Dipole for </span><span class="si">{</span><span class="n">top_turns</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> of driving is fine for MAD-X but is &quot;</span>

            <span class="s2">&quot;higher than what the device can do in the (HL)LHC! Beware.&quot;</span>

        <span class="p">)</span>

    <span class="n">ramp1</span><span class="p">,</span> <span class="n">ramp2</span> <span class="o">=</span> <span class="n">start_turn</span><span class="p">,</span> <span class="n">start_turn</span> <span class="o">+</span> <span class="n">ramp_turns</span>

    <span class="n">ramp3</span> <span class="o">=</span> <span class="n">ramp2</span> <span class="o">+</span> <span class="n">top_turns</span>

    <span class="n">ramp4</span> <span class="o">=</span> <span class="n">ramp3</span> <span class="o">+</span> <span class="n">ramp_turns</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving tunes from internal tables&quot;</span><span class="p">)</span>

    <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">summ</span><span class="o">.</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">summ</span><span class="o">.</span><span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved values are q1 = </span><span class="si">{</span><span class="n">q1</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, q2 = </span><span class="si">{</span><span class="n">q2</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">q1_dipole</span><span class="p">,</span> <span class="n">q2_dipole</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">deltaqx</span><span class="p">,</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">deltaqy</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Querying BETX and BETY at AC Dipole location&quot;</span><span class="p">)</span>

    <span class="c1"># All below is done as model_creator macros with `.input()` calls</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pbeam = beam%lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">-&gt;pc;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;betxac = table(twiss, MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, BEAM, betx);&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;betyac = table(twiss, MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, BEAM, bety);&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Calculating AC Dipole voltage values&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;voltx = 0.042 * pbeam * ABS(</span><span class="si">{</span><span class="n">deltaqx</span><span class="si">}</span><span class="s2">) / SQRT(180.0 * betxac) * </span><span class="si">{</span><span class="n">sigma_x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;volty = 0.042 * pbeam * ABS(</span><span class="si">{</span><span class="n">deltaqy</span><span class="si">}</span><span class="s2">) / SQRT(177.0 * betyac) * </span><span class="si">{</span><span class="n">sigma_y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining kicker elements for transverse planes&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;MKACH.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">: hacdipole, l=0, freq:=</span><span class="si">{</span><span class="n">q1_dipole</span><span class="si">}</span><span class="s2">, lag=0, volt=voltx, ramp1=</span><span class="si">{</span><span class="n">ramp1</span><span class="si">}</span><span class="s2">, &quot;</span>

        <span class="sa">f</span><span class="s2">&quot;ramp2=</span><span class="si">{</span><span class="n">ramp2</span><span class="si">}</span><span class="s2">, ramp3=</span><span class="si">{</span><span class="n">ramp3</span><span class="si">}</span><span class="s2">, ramp4=</span><span class="si">{</span><span class="n">ramp4</span><span class="si">}</span><span class="s2">;&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;MKACV.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">: vacdipole, l=0, freq:=</span><span class="si">{</span><span class="n">q2_dipole</span><span class="si">}</span><span class="s2">, lag=0, volt=volty, ramp1=</span><span class="si">{</span><span class="n">ramp1</span><span class="si">}</span><span class="s2">, &quot;</span>

        <span class="sa">f</span><span class="s2">&quot;ramp2=</span><span class="si">{</span><span class="n">ramp2</span><span class="si">}</span><span class="s2">, ramp3=</span><span class="si">{</span><span class="n">ramp3</span><span class="si">}</span><span class="s2">, ramp4=</span><span class="si">{</span><span class="n">ramp4</span><span class="si">}</span><span class="s2">;&quot;</span>

    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;Installing AC Dipole kicker with driven tunes of Qx_D = </span><span class="si">{</span><span class="n">q1_dipole</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">  |  Qy_D = </span><span class="si">{</span><span class="n">q2_dipole</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">flatten</span><span class="p">()</span>

    <span class="c1"># The kicker version is meant for a thin lattice and is installed a right at MKQA.6L4.B[12] (at=0)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKACH.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKACV.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">endedit</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;Sequence LHCB</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> is now re-used for changes to take effect. Beware that this will reset it, &quot;</span>

        <span class="s2">&quot;remove errors etc.&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">install_ac_dipole_as_matrix</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">deltaqx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">deltaqy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Installs an AC dipole as a matrix element for (HL)LHC BEAM 1 OR 2 ONLY.</span>

<span class="sd">    The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in</span>

<span class="sd">    MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a</span>

<span class="sd">    matrix element so that its effect can be seen on the TWISS functions. It DOES NOT affect tracking.</span>

<span class="sd">    See https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002 (part III).</span>

<span class="sd">    This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or</span>

<span class="sd">    `make_lhc_beams` function), matched to your desired working point and made a TWISS.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        deltaqx (float): the deltaQx (horizontal tune excitation) used by the AC dipole.</span>

<span class="sd">        deltaqy (float): the deltaQy (vertical tune excitation) used by the AC dipole.</span>

<span class="sd">        beam (int): the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This AC Dipole is implemented as a matrix and will not affect particle tracking!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;This routine should be done after &#39;match&#39;, &#39;twiss&#39; and &#39;makethin&#39; for the appropriate beam.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving tunes from internal tables&quot;</span><span class="p">)</span>

    <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">summ</span><span class="o">.</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">summ</span><span class="o">.</span><span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved values are q1 = </span><span class="si">{</span><span class="n">q1</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, q2 = </span><span class="si">{</span><span class="n">q2</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">q1_dipole</span><span class="p">,</span> <span class="n">q2_dipole</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">deltaqx</span><span class="p">,</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">deltaqy</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Querying BETX and BETY at AC Dipole location&quot;</span><span class="p">)</span>

    <span class="c1"># All below is done as model_creator macros with `.input()` calls</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;betxac = table(twiss, MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, BEAM, betx);&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;betyac = table(twiss, MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, BEAM, bety);&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Calculating AC Dipole matrix terms&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hacmap21 = 2 * (cos(2*pi*</span><span class="si">{</span><span class="n">q1_dipole</span><span class="si">}</span><span class="s2">) - cos(2*pi*</span><span class="si">{</span><span class="n">q1</span><span class="si">}</span><span class="s2">)) / (betxac * sin(2*pi*</span><span class="si">{</span><span class="n">q1</span><span class="si">}</span><span class="s2">));&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vacmap43 = 2 * (cos(2*pi*</span><span class="si">{</span><span class="n">q2_dipole</span><span class="si">}</span><span class="s2">) - cos(2*pi*</span><span class="si">{</span><span class="n">q2</span><span class="si">}</span><span class="s2">)) / (betyac * sin(2*pi*</span><span class="si">{</span><span class="n">q2</span><span class="si">}</span><span class="s2">));&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining matrix elements for transverse planes&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hacmap: matrix, l=0, rm21=hacmap21;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vacmap: matrix, l=0, rm43=vacmap43;&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;Installing AC Dipole matrix with driven tunes of Qx_D = </span><span class="si">{</span><span class="n">q1_dipole</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">  |  Qy_D = </span><span class="si">{</span><span class="n">q2_dipole</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">flatten</span><span class="p">()</span>

    <span class="c1"># The matrix version is meant for a thick lattice and is installed a little after MKQA.6L4.B[12]</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="s2">&quot;hacmap&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s2">&quot;1.583 / 2&quot;</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="s2">&quot;vacmap&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s2">&quot;1.583 / 2&quot;</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MKQA.6L4.B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">endedit</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

        <span class="sa">f</span><span class="s2">&quot;Sequence LHCB</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> is now re-used for changes to take effect. Beware that this will reset it, &quot;</span>

        <span class="s2">&quot;remove errors etc.&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lhcb</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vary_independent_ir_quadrupoles</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">quad_numbers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span> <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Send the `vary` commands for the desired quadrupoles in the IRs. The independent quadrupoles for which</span>

<span class="sd">    this is implemented are Q4 to Q13 included. This is useful to setup some specific matching involving</span>

<span class="sd">    these elements.</span>

<span class="sd">    It is necessary to have defined a &#39;brho&#39; variable when creating your beams.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        quad_numbers (Sequence[int]): quadrupoles to be varied, by number (aka position from IP).</span>

<span class="sd">        ip (int): the IP around which to apply the instructions. Defaults to 1.</span>

<span class="sd">        sides (Sequence[str]): the sides of IP to act on. Should be `R` for right and `L` for left.</span>

<span class="sd">            Defaults to both sides of the IP.</span>

<span class="sd">        beam (int): the beam for which to apply the instructions. Defaults to 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span>

        <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">)</span>

        <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">quad</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">quad_numbers</span><span class="p">)</span>

    <span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either the IP number of the side provided are invalid, not applying any error.&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;quad_numbers&#39;, &#39;ip&#39;, &#39;sides&#39; argument&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing a knob involving quadrupoles </span><span class="si">{</span><span class="n">quad_numbers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Each quad has a specific power circuit used for their k1 boundaries</span>

    <span class="n">power_circuits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;mqy&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;mqm&quot;</span><span class="p">,</span>

        <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;mqm&quot;</span><span class="p">,</span>

        <span class="mi">10</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">11</span><span class="p">:</span> <span class="s2">&quot;mqtli&quot;</span><span class="p">,</span>

        <span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;mqt&quot;</span><span class="p">,</span>

        <span class="mi">13</span><span class="p">:</span> <span class="s2">&quot;mqt&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">quad_numbers</span><span class="p">:</span>

        <span class="n">circuit</span> <span class="o">=</span> <span class="n">power_circuits</span><span class="p">[</span><span class="n">quad</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending vary command for Q</span><span class="si">{</span><span class="n">quad</span><span class="si">}{</span><span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span>

                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;kq</span><span class="si">{</span><span class="s1">&#39;t&#39;</span> <span class="k">if</span> <span class="n">quad</span> <span class="o">&gt;=</span> <span class="mi">11</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="s1">&#39;l&#39;</span> <span class="k">if</span> <span class="n">quad</span> <span class="o">==</span> <span class="mi">11</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">quad</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">}</span><span class="s2">b</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

                <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>

                <span class="n">lower</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">circuit</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">quad</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">quad</span><span class="si">}{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">}</span><span class="s2">.b</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">-&gt;kmax/brho&quot;</span><span class="p">,</span>

                <span class="n">upper</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;+</span><span class="si">{</span><span class="n">circuit</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">quad</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">quad</span><span class="si">}{</span><span class="n">side</span><span class="si">}{</span><span class="n">ip</span><span class="si">}</span><span class="s2">.b</span><span class="si">{</span><span class="n">beam</span><span class="si">}</span><span class="s2">-&gt;kmax/brho&quot;</span><span class="p">,</span>

            <span class="p">)</span>

<span class="k">def</span> <span class="nf">reset_lhc_bump_flags</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Resets all LHC IP bump flags to 0.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Resetting all LHC IP bump flags&quot;</span><span class="p">)</span>

    <span class="n">ALL_BUMPS</span> <span class="o">=</span> <span class="p">(</span>

        <span class="n">LHC_ANGLE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_CROSSING_ANGLE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_EXPERIMENT_STATE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_IP2_SPECIAL_FLAG</span>

        <span class="o">+</span> <span class="n">LHC_IP_OFFSET_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_PARALLEL_SEPARATION_FLAGS</span>

    <span class="p">)</span>

    <span class="k">with</span> <span class="n">madx</span><span class="o">.</span><span class="n">batch</span><span class="p">():</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">bump</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">bump</span> <span class="ow">in</span> <span class="n">ALL_BUMPS</span><span class="p">})</span>

<span class="c1"># ----- Output Utilities ----- #</span>

<span class="k">def</span> <span class="nf">make_sixtrack_output</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    INITIAL IMPLEMENTATION CREDITS GO TO JOSCHUA DILLY (@JoschD).</span>

<span class="sd">    Prepare output for sixtrack run.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        energy (float): beam energy in GeV.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Preparing outputs for SixTrack&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Powering RF cavities&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;VRF400&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">energy</span> <span class="o">&lt;</span> <span class="mi">5000</span> <span class="k">else</span> <span class="mi">16</span>  <span class="c1"># is 6 at injection for protons iirc?</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;LAGRF400.B1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># cavity phase difference in units of 2pi</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;LAGRF400.B2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing TWISS and SIXTRACK commands&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">twiss</span><span class="p">()</span>  <span class="c1"># used by sixtrack</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">sixtrack</span><span class="p">(</span><span class="n">cavall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.017</span><span class="p">)</span>  <span class="c1"># this value is only ok for HL(LHC) magnet radius</span>

<span class="c1"># ----- Miscellaneous Utilities ----- #</span>

<span class="k">def</span> <span class="nf">make_lhc_thin</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">slicefactor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Makethin for the LHC sequence as previously done in MAD-X macros. This will use the `teapot` style and</span>

<span class="sd">    will enforce `makedipedge`.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (Madx): an instantiated cpymad.madx.Madx object.</span>

<span class="sd">        sequence (str): the sequence to use for the MAKETHIN command.</span>

<span class="sd">        slicefactor (int): the slice factor to apply in makethin. Defaults to 1.</span>

<span class="sd">    Keyword Args:</span>

<span class="sd">        The keyword arguments for the MAD-X MAKETHN commands, namely `style` (will default to `teapot`) and</span>

<span class="sd">        the `makedipedge` flag (will default to True).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slicing sequence &#39;</span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">four_slices_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;mbx\.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;mbrb\.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;mbrc\.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;mbrs\.&quot;</span><span class="p">]</span>

    <span class="n">four_slicefactor_patterns</span> <span class="o">=</span> <span class="p">[</span>

        <span class="sa">r</span><span class="s2">&quot;mqwa\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqwb\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqy\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqm\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqmc\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqml\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqtlh\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqtli\.&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="s2">&quot;mqt\.&quot;</span><span class="p">,</span>

    <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for general MB and MQ elements&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;MQ&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for triplets&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;mqxa&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">16</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;mqxb&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">16</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for various specifc mb elements&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">four_slices_patterns</span><span class="p">:</span>

        <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for varous specifc mq elements&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">four_slicefactor_patterns</span><span class="p">:</span>

        <span class="n">madx</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;teapot&quot;</span><span class="p">)</span>

    <span class="n">makedipedge</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;makedipedge&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># defaults to False to compensate default TEAPOT style</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">makethin</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">makedipedge</span><span class="o">=</span><span class="n">makedipedge</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">re_cycle_sequence</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lhcb1&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IP3&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Re-cycle the provided sequence from a different starting point.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (Madx): an instantiated cpymad.madx.Madx object.</span>

<span class="sd">        sequence (str): the sequence to re cycle.</span>

<span class="sd">        start (str): element to start the new cycle from.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Re-cycling sequence &#39;</span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">flatten</span><span class="p">()</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">endedit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">match_no_coupling_through_ripkens</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vary_knobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Matching routine to get cross-term Ripken parameters beta_12 and beta_21 to be 0 at a given location.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        sequence (str): name of the sequence to activate for the matching.</span>

<span class="sd">        location (str): the name of the element at which one wants the cross-term Ripkens to be 0.</span>

<span class="sd">        vary_knobs (Sequence[str]): the variables names to &#39;vary&#39; in the MADX routine.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matching Ripken parameters for no coupling at location </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating macro tu update Ripkens&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;do_ripken: macro = {twiss, ripken=True;}&quot;</span><span class="p">)</span>  <span class="c1"># cpymad needs .input for macros</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Matching Parameters&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">use_macro</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chrom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">knob</span> <span class="ow">in</span> <span class="n">vary_knobs</span><span class="p">:</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">knob</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">use_macro</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;do_ripken&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constraint, expr=table(twiss, </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">, beta12)=0&quot;</span><span class="p">)</span>  <span class="c1"># need input else includes &quot; and fails</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constraint, expr=table(twiss, </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">, beta21)=0&quot;</span><span class="p">)</span>  <span class="c1"># need input else includes &quot; and fails</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">lmdif</span><span class="p">(</span><span class="n">calls</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-21</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">endmatch</span><span class="p">()</span>

<span class="c1"># ----- Helpers ----- #</span>

<span class="k">def</span> <span class="nf">_all_lhc_arcs</span><span class="p">(</span><span class="n">beam</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    INITIAL IMPLEMENTATION CREDITS GO TO JOSCHUA DILLY (@JoschD).</span>

<span class="sd">    Names of all LHC arcs for a given beam.</span>

<span class="sd">    Args:</span>

<span class="sd">        beam (int): beam to get names for.</span>

<span class="sd">    Returns:</span>

<span class="sd">        The list of names.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;A</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}{</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">B</span><span class="si">{</span><span class="n">beam</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">_get_k_strings</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    INITIAL IMPLEMENTATION CREDITS GO TO JOSCHUA DILLY (@JoschD).</span>

<span class="sd">    Returns the list of K-strings for various magnets and orders (K1L, K2SL etc strings).</span>

<span class="sd">    Args:</span>

<span class="sd">        start (int): the starting order, defaults to 0.</span>

<span class="sd">        stop (int): the order to go up to, defaults to 8.</span>

<span class="sd">        orientation (str): magnet orientation, can be &#39;straight&#39;, &#39;skew&#39; or &#39;both&#39;. Defaults to &#39;both&#39;.</span>

<span class="sd">    Returns:</span>

<span class="sd">        The list of names as strings.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;straight&quot;</span><span class="p">,</span> <span class="s2">&quot;skew&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">,):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>

            <span class="sa">f</span><span class="s2">&quot;Orientation &#39;</span><span class="si">{</span><span class="n">orientation</span><span class="si">}</span><span class="s2">&#39; is not accepted, should be one of &#39;straight&#39;, &#39;skew&#39;, &#39;both&#39;.&quot;</span>

        <span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;orientation&#39; parameter&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;straight&quot;</span><span class="p">:</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,)</span>

    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;skew&quot;</span><span class="p">:</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># both</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;K</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">d</span><span class="si">}{</span><span class="n">s</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">L&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">orientation</span><span class="p">]</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="highlight"><pre><span></span><code><span class="n">LHC_ANGLE_FLAGS</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">LHC_CROSSING_ANGLE_FLAGS</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">LHC_EXPERIMENT_STATE_FLAGS</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">LHC_IP2_SPECIAL_FLAG</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">LHC_IP_OFFSET_FLAGS</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">LHC_PARALLEL_SEPARATION_FLAGS</span>
</code></pre></div>
<h2 id="functions">Functions</h2>
<h3 id="apply_lhc_colinearity_knob">apply_lhc_colinearity_knob</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_lhc_colinearity_knob</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">colinearity_knob_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ir</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Applies the LHC colinearity knob. If you don't know what this is, you should not be using this</p>
<p>function.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>colinearity_knob_value</td>
<td>float</td>
<td>Units of the colinearity knob to apply. Defaults to 0 so users</td>
<td></td>
</tr>
<tr>
<td>don't mess up local coupling by mistake. This should be a positive integer, normally between 1</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>and 10.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ir</td>
<td>int</td>
<td>The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</td>
<td></td>
</tr>
<tr>
<td>Classically 1 or 5.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">apply_lhc_colinearity_knob</span><span class="p">(</span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="nl">colinearity_knob_value</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">ir</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Applies the LHC colinearity knob. If you don&#39;t know what this is, you should not be using this</span>

<span class="ss">    function.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        colinearity_knob_value (float): Units of the colinearity knob to apply. Defaults to 0 so users</span>

<span class="ss">            don&#39;t mess up local coupling by mistake. This should be a positive integer, normally between 1</span>

<span class="ss">            and 10.</span>

<span class="ss">        ir (int): The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</span>

<span class="ss">            Classically 1 or 5.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Applying Colinearity knob with a unit setting of {colinearity_knob_value}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="ss">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">knob_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;KQSX3.R{ir:d}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;KQSX3.L{ir:d}&quot;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">MQSX</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">coupling</span><span class="w"> </span><span class="n">correctors</span><span class="w"></span>

<span class="w">    </span><span class="n">right_knob</span><span class="p">,</span><span class="w"> </span><span class="n">left_knob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">knob_variables</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">right_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colinearity_knob_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Set &#39;{right_knob}&#39; to {madx.globals[right_knob]}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">left_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">colinearity_knob_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e-4</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Set &#39;{left_knob}&#39; to {madx.globals[left_knob]}&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="apply_lhc_coupling_knob">apply_lhc_coupling_knob</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_lhc_coupling_knob</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">coupling_knob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">telescopic_squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Applies the LHC coupling knob to reach the desired C- value.</p>
<p>Args:
    madx (cpymad.madx.Madx): an instanciated cpymad Madx object.
    coupling_knob (float): Desired value for the Cminus, typically a few units of 1E-3. Defaults to 0
    so users don't mess up coupling by mistake
    beam (int): beam to apply the knob to, defaults to beam 1.
    telescopic_squeeze (bool): if set to True, uses the knobs for Telescopic Squeeze configuration.
        Defaults to <code>True</code>.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">apply_lhc_coupling_knob</span><span class="p">(</span><span class="w"></span>

<span class="w">    </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="nl">coupling_knob</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">beam</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">telescopic_squeeze</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Applies the LHC coupling knob to reach the desired C- value.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        coupling_knob (float): Desired value for the Cminus, typically a few units of 1E-3. Defaults to 0</span>

<span class="ss">        so users don&#39;t mess up coupling by mistake</span>

<span class="ss">        beam (int): beam to apply the knob to, defaults to beam 1.</span>

<span class="ss">        telescopic_squeeze (bool): if set to True, uses the knobs for Telescopic Squeeze configuration.</span>

<span class="ss">            Defaults to `True`.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Applying coupling knob&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="ss">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;_sq&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">telescopic_squeeze</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">knob_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;CMRS.b{beam:d}{suffix}&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Knob &#39;{knob_name}&#39; is {madx.globals[knob_name]} before implementation&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">knob_name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coupling_knob</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Set &#39;{knob_name}&#39; to {madx.globals[knob_name]}&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="apply_lhc_rigidity_waist_shift_knob">apply_lhc_rigidity_waist_shift_knob</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_lhc_rigidity_waist_shift_knob</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">rigidty_waist_shift_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ir</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Applies the LHC rigidity waist shift knob, moving the waist left or right of IP. If you don't know what</p>
<p>this is, you should not be using this function. The waist shift is done by unbalancing the
triplet powering knob of the left and right-hand sides of the IP.</p>
<p>Warning: Applying the shift will modify your tunes and most likely flip them, making a subsequent
matching impossible if your lattice has coupling. To avoid this, match to tunes split further apart
before applying the waist shift knob, and then match to the desired working point. For instance for
the LHC, matching to (62.27, 60.36) before applying and afterwards rematching to (62.31, 60.32) usually
works well.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>rigidty_waist_shift_value</td>
<td>float</td>
<td>Units of the rigidity waist shift knob (positive values only).</td>
<td>None</td>
</tr>
<tr>
<td>ir</td>
<td>int</td>
<td>The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</td>
<td></td>
</tr>
<tr>
<td>Classically 1 or 5.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>side</td>
<td>str</td>
<td>Which side of the IP to move the waist to, determines a sign in the calculation.</td>
<td></td>
</tr>
<tr>
<td>Defaults to 'left', which means s_waist &lt; s_ip (and setting it to 'right' would move the waist</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>to s_waist &gt; s_ip).</td>
<td>None</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">apply_lhc_rigidity_waist_shift_knob</span><span class="p">(</span><span class="w"></span>

<span class="w">    </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="nl">rigidty_waist_shift_value</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">ir</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">side</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;left&quot;</span><span class="w"></span>

<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Applies the LHC rigidity waist shift knob, moving the waist left or right of IP. If you don&#39;t know what</span>

<span class="ss">    this is, you should not be using this function. The waist shift is done by unbalancing the</span>

<span class="ss">    triplet powering knob of the left and right-hand sides of the IP.</span>

<span class="ss">    Warning: Applying the shift will modify your tunes and most likely flip them, making a subsequent</span>

<span class="ss">    matching impossible if your lattice has coupling. To avoid this, match to tunes split further apart</span>

<span class="ss">    before applying the waist shift knob, and then match to the desired working point. For instance for</span>

<span class="ss">    the LHC, matching to (62.27, 60.36) before applying and afterwards rematching to (62.31, 60.32) usually</span>

<span class="ss">    works well.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        rigidty_waist_shift_value (float): Units of the rigidity waist shift knob (positive values only).</span>

<span class="ss">        ir (int): The Interaction Region to apply the knob to, should be one of [1, 2, 5, 8].</span>

<span class="ss">            Classically 1 or 5.</span>

<span class="ss">        side (str): Which side of the IP to move the waist to, determines a sign in the calculation.</span>

<span class="ss">            Defaults to &#39;left&#39;, which means s_waist &lt; s_ip (and setting it to &#39;right&#39; would move the waist</span>

<span class="ss">            to s_waist &gt; s_ip).</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Applying Rigidity Waist Shift knob with a unit setting of {rigidty_waist_shift_value}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="ss">&quot;You should re-match tunes &amp; chromaticities after this&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">right_knob</span><span class="p">,</span><span class="w"> </span><span class="n">left_knob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;kqx.r{ir:d}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;kqx.l{ir:d}&quot;</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">triplet</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">knob</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="n">trims</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">current_right_knob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">right_knob</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="n">current_left_knob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">left_knob</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">side</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;left&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">right_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rigidty_waist_shift_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.005</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current_right_knob</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">left_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rigidty_waist_shift_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.005</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current_left_knob</span><span class="w"></span>

<span class="w">    </span><span class="n">elif</span><span class="w"> </span><span class="n">side</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;right&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">right_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rigidty_waist_shift_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.005</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current_right_knob</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">left_knob</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rigidty_waist_shift_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.005</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current_left_knob</span><span class="w"></span>

<span class="w">    </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Given side &#39;{side}&#39; invalid, only &#39;left&#39; and &#39;right&#39; are accepted values.&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid value for parameter &#39;side&#39;.&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Set &#39;{right_knob}&#39; to {madx.globals[right_knob]}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Set &#39;{left_knob}&#39; to {madx.globals[left_knob]}&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="deactivate_lhc_arc_sextupoles">deactivate_lhc_arc_sextupoles</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">deactivate_lhc_arc_sextupoles</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Deactivate all arc sextupoles in the (HL)LHC.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>beam</td>
<td>int</td>
<td>beam to use.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">deactivate_lhc_arc_sextupoles</span><span class="p">(</span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="nl">beam</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Deactivate all arc sextupoles in the (HL)LHC.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        beam (int): beam to use.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">KSF1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">KSD2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Strong</span><span class="w"> </span><span class="n">sextupoles</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">sectors</span><span class="w"> </span><span class="mi">81</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">45</span><span class="o">/</span><span class="mi">56</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">KSF2</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">KSD1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Weak</span><span class="w"> </span><span class="n">sextupoles</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">sectors</span><span class="w"> </span><span class="mi">81</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">45</span><span class="o">/</span><span class="mi">56</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nl">Rest</span><span class="p">:</span><span class="w"> </span><span class="n">Weak</span><span class="w"> </span><span class="n">sextupoles</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sectors</span><span class="w"> </span><span class="mi">78</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">34</span><span class="o">/</span><span class="mi">67</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Deactivating all arc sextupoles for beam {beam}.&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">beam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">beam</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">beam</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">arc</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_all_lhc_arcs</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="ss">&quot;FD&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">sextupole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;KS{fd}{i:d}.{arc}&quot;</span><span class="w"></span>

<span class="w">                </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;De-powering element &#39;{sextupole}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">sextupole</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="install_ac_dipole_as_kicker">install_ac_dipole_as_kicker</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">install_ac_dipole_as_kicker</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">deltaqx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">deltaqy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">start_turn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">ramp_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">top_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6600</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Installs an AC dipole for (HL)LHC BEAM 1 OR 2 ONLY.</p>
<p>The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in
MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a
kicker element so that its effect can be seen on particle orbit in tracking. It DOES NOT affect TWISS
functions. See <a href="https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002">https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002</a> (part III).</p>
<p>This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or
<code>make_lhc_beams</code> function), matched to your desired working point and made a TWISS.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>deltaqx</td>
<td>float</td>
<td>the deltaQx (horizontal tune excitation) used by the AC dipole.</td>
<td>None</td>
</tr>
<tr>
<td>deltaqy</td>
<td>float</td>
<td>the deltaQy (vertical tune excitation) used by the AC dipole.</td>
<td>None</td>
</tr>
<tr>
<td>sigma_x</td>
<td>float</td>
<td>the horizontal amplitude to drive the beam to, in bunch sigma.</td>
<td>None</td>
</tr>
<tr>
<td>sigma_y</td>
<td>float</td>
<td>the vertical amplitude to drive the beam to, in bunch sigma.</td>
<td>None</td>
</tr>
<tr>
<td>beam</td>
<td>int</td>
<td>the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</td>
<td>1</td>
</tr>
<tr>
<td>start_turn</td>
<td>int</td>
<td>the turn at which to start ramping up the AC dipole. Defaults to 100.</td>
<td>100</td>
</tr>
<tr>
<td>ramp_turns</td>
<td>int</td>
<td>the number of turns to use for the ramp-up and the ramp-down of the AC dipole.</td>
<td></td>
</tr>
<tr>
<td>This number is important in order to preserve the adiabaticity of the cycle. Defaults to 2000</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>as in the LHC.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>top_turns</td>
<td>int</td>
<td>the number of turns to drive the beam for. Defaults to 6600 as in the LHC.</td>
<td>6600 as in the LHC</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">install_ac_dipole_as_kicker</span><span class="p">(</span>

    <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

    <span class="n">deltaqx</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span>

    <span class="n">deltaqy</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span>

    <span class="n">sigma_x</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span>

    <span class="n">sigma_y</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span>

    <span class="n">beam</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

    <span class="n">start_turn</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>

    <span class="n">ramp_turns</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>

    <span class="n">top_turns</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">6600</span><span class="p">,</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Installs an AC dipole for (HL)LHC BEAM 1 OR 2 ONLY.</span>

<span class="s2">    The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in</span>

<span class="s2">    MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a</span>

<span class="s2">    kicker element so that its effect can be seen on particle orbit in tracking. It DOES NOT affect TWISS</span>

<span class="s2">    functions. See https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002 (part III).</span>

<span class="s2">    This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or</span>

<span class="s2">    `make_lhc_beams` function), matched to your desired working point and made a TWISS.</span>

<span class="s2">    Args:</span>

<span class="s2">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">        deltaqx (float): the deltaQx (horizontal tune excitation) used by the AC dipole.</span>

<span class="s2">        deltaqy (float): the deltaQy (vertical tune excitation) used by the AC dipole.</span>

<span class="s2">        sigma_x (float): the horizontal amplitude to drive the beam to, in bunch sigma.</span>

<span class="s2">        sigma_y (float): the vertical amplitude to drive the beam to, in bunch sigma.</span>

<span class="s2">        beam (int): the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</span>

<span class="s2">        start_turn (int): the turn at which to start ramping up the AC dipole. Defaults to 100.</span>

<span class="s2">        ramp_turns (int): the number of turns to use for the ramp-up and the ramp-down of the AC dipole.</span>

<span class="s2">            This number is important in order to preserve the adiabaticity of the cycle. Defaults to 2000</span>

<span class="s2">            as in the LHC.</span>

<span class="s2">        top_turns (int): the number of turns to drive the beam for. Defaults to 6600 as in the LHC.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This AC Dipole is implemented as a kicker and will not affect TWISS functions!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This routine should be done after &#39;match&#39;, &#39;twiss&#39; and &#39;makethin&#39; for the appropriate beam&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">top_turns</span> <span class="o">&gt;</span> <span class="mi">6600</span><span class="o">:</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Configuring the AC Dipole for {top_turns:d} of driving is fine for MAD-X but is &quot;</span>

            <span class="s2">&quot;higher than what the device can do in the (HL)LHC! Beware.&quot;</span>

        <span class="p">)</span>

    <span class="n">ramp1</span><span class="p">,</span> <span class="n">ramp2</span> <span class="o">=</span> <span class="n">start_turn</span><span class="p">,</span> <span class="n">start_turn</span> <span class="o">+</span> <span class="n">ramp_turns</span>

    <span class="n">ramp3</span> <span class="o">=</span> <span class="n">ramp2</span> <span class="o">+</span> <span class="n">top_turns</span>

    <span class="n">ramp4</span> <span class="o">=</span> <span class="n">ramp3</span> <span class="o">+</span> <span class="n">ramp_turns</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving tunes from internal tables&quot;</span><span class="p">)</span>

    <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">summ</span><span class="p">.</span><span class="n">q1</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">summ</span><span class="p">.</span><span class="n">q2</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Retrieved values are q1 = {q1:.5f}, q2 = {q2:.5f}&quot;</span><span class="p">)</span>

    <span class="n">q1_dipole</span><span class="p">,</span> <span class="n">q2_dipole</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">deltaqx</span><span class="p">,</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">deltaqy</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Querying BETX and BETY at AC Dipole location&quot;</span><span class="p">)</span>

    <span class="c1"># All below is done as model_creator macros with `.input()` calls</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pbeam = beam%lhcb{beam:d}-&gt;pc;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;betxac = table(twiss, MKQA.6L4.B{beam:d}, BEAM, betx);&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;betyac = table(twiss, MKQA.6L4.B{beam:d}, BEAM, bety);&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Calculating AC Dipole voltage values&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;voltx = 0.042 * pbeam * ABS({deltaqx}) / SQRT(180.0 * betxac) * {sigma_x}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;volty = 0.042 * pbeam * ABS({deltaqy}) / SQRT(177.0 * betyac) * {sigma_y}&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining kicker elements for transverse planes&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;MKACH.6L4.B{beam:d}: hacdipole, l=0, freq:={q1_dipole}, lag=0, volt=voltx, ramp1={ramp1}, &quot;</span>

        <span class="n">f</span><span class="s2">&quot;ramp2={ramp2}, ramp3={ramp3}, ramp4={ramp4};&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;MKACV.6L4.B{beam:d}: vacdipole, l=0, freq:={q2_dipole}, lag=0, volt=volty, ramp1={ramp1}, &quot;</span>

        <span class="n">f</span><span class="s2">&quot;ramp2={ramp2}, ramp3={ramp3}, ramp4={ramp4};&quot;</span>

    <span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;Installing AC Dipole kicker with driven tunes of Qx_D = {q1_dipole:.5f}  |  Qy_D = {q2_dipole:.5f}&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;lhcb{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># The kicker version is meant for a thin lattice and is installed a right at MKQA.6L4.B[12] (at=0)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKACH.6L4.B{beam:d}&quot;</span><span class="p">,</span> <span class="k">at</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKQA.6L4.B{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKACV.6L4.B{beam:d}&quot;</span><span class="p">,</span> <span class="k">at</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKQA.6L4.B{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">endedit</span><span class="p">()</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;Sequence LHCB{beam:d} is now re-used for changes to take effect. Beware that this will reset it, &quot;</span>

        <span class="s2">&quot;remove errors etc.&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;lhcb{beam:d}&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h3 id="install_ac_dipole_as_matrix">install_ac_dipole_as_matrix</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">install_ac_dipole_as_matrix</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">deltaqx</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">deltaqy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Installs an AC dipole as a matrix element for (HL)LHC BEAM 1 OR 2 ONLY.</p>
<p>The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in
MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a
matrix element so that its effect can be seen on the TWISS functions. It DOES NOT affect tracking.
See <a href="https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002">https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002</a> (part III).</p>
<p>This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or
<code>make_lhc_beams</code> function), matched to your desired working point and made a TWISS.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>deltaqx</td>
<td>float</td>
<td>the deltaQx (horizontal tune excitation) used by the AC dipole.</td>
<td>None</td>
</tr>
<tr>
<td>deltaqy</td>
<td>float</td>
<td>the deltaQy (vertical tune excitation) used by the AC dipole.</td>
<td>None</td>
</tr>
<tr>
<td>beam</td>
<td>int</td>
<td>the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</td>
<td>1</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">install_ac_dipole_as_matrix</span><span class="p">(</span><span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">deltaqx</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">deltaqy</span><span class="o">:</span> <span class="kt">float</span><span class="p">,</span> <span class="n">beam</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Installs an AC dipole as a matrix element for (HL)LHC BEAM 1 OR 2 ONLY.</span>

<span class="s2">    The AC Dipole does impact the orbit as well as the betatron functions when turned on. Unfortunately in</span>

<span class="s2">    MAD-X, it cannot be modeled to do both at the same time. This routine introduces an AC Dipole as a</span>

<span class="s2">    matrix element so that its effect can be seen on the TWISS functions. It DOES NOT affect tracking.</span>

<span class="s2">    See https://journals.aps.org/prab/abstract/10.1103/PhysRevSTAB.11.084002 (part III).</span>

<span class="s2">    This function assumes that you have already defined lhcb1/lhcb2, made a beam for it (BEAM command or</span>

<span class="s2">    `make_lhc_beams` function), matched to your desired working point and made a TWISS.</span>

<span class="s2">    Args:</span>

<span class="s2">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">        deltaqx (float): the deltaQx (horizontal tune excitation) used by the AC dipole.</span>

<span class="s2">        deltaqy (float): the deltaQy (vertical tune excitation) used by the AC dipole.</span>

<span class="s2">        beam (int): the LHC beam to install the AC Dipole into, either 1 or 2. Defaults to 1.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This AC Dipole is implemented as a matrix and will not affect particle tracking!&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This routine should be done after &#39;match&#39;, &#39;twiss&#39; and &#39;makethin&#39; for the appropriate beam.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving tunes from internal tables&quot;</span><span class="p">)</span>

    <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">summ</span><span class="p">.</span><span class="n">q1</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">summ</span><span class="p">.</span><span class="n">q2</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Retrieved values are q1 = {q1:.5f}, q2 = {q2:.5f}&quot;</span><span class="p">)</span>

    <span class="n">q1_dipole</span><span class="p">,</span> <span class="n">q2_dipole</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="n">deltaqx</span><span class="p">,</span> <span class="n">q2</span> <span class="o">+</span> <span class="n">deltaqy</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Querying BETX and BETY at AC Dipole location&quot;</span><span class="p">)</span>

    <span class="c1"># All below is done as model_creator macros with `.input()` calls</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;betxac = table(twiss, MKQA.6L4.B{beam:d}, BEAM, betx);&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;betyac = table(twiss, MKQA.6L4.B{beam:d}, BEAM, bety);&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Calculating AC Dipole matrix terms&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;hacmap21 = 2 * (cos(2*pi*{q1_dipole}) - cos(2*pi*{q1})) / (betxac * sin(2*pi*{q1}));&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;vacmap43 = 2 * (cos(2*pi*{q2_dipole}) - cos(2*pi*{q2})) / (betyac * sin(2*pi*{q2}));&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining matrix elements for transverse planes&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;hacmap: matrix, l=0, rm21=hacmap21;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;vacmap: matrix, l=0, rm43=vacmap43;&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;Installing AC Dipole matrix with driven tunes of Qx_D = {q1_dipole:.5f}  |  Qy_D = {q2_dipole:.5f}&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;lhcb{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># The matrix version is meant for a thick lattice and is installed a little after MKQA.6L4.B[12]</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="s2">&quot;hacmap&quot;</span><span class="p">,</span> <span class="k">at</span><span class="o">=</span><span class="s2">&quot;1.583 / 2&quot;</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKQA.6L4.B{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">install</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="s2">&quot;vacmap&quot;</span><span class="p">,</span> <span class="k">at</span><span class="o">=</span><span class="s2">&quot;1.583 / 2&quot;</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;MKQA.6L4.B{beam:d}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">endedit</span><span class="p">()</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;Sequence LHCB{beam:d} is now re-used for changes to take effect. Beware that this will reset it, &quot;</span>

        <span class="s2">&quot;remove errors etc.&quot;</span>

    <span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;lhcb{beam:d}&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h3 id="make_lhc_beams">make_lhc_beams</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_lhc_beams</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">7000</span><span class="p">,</span>
    <span class="n">emittance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.75e-06</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Define beams with default configuratons for <code>LHCB1</code> and <code>LHCB2</code> sequences.</p>
<p>Args:
    madx (cpymad.madx.Madx): an instanciated cpymad Madx object.
    energy (float): beam energy in GeV. Defaults to 6500.
    emittance (float): emittance in meters, which will be used to calculate geometric emittance,
        then fed to the BEAM command.</p>
<p>Keyword Args:
    Any keyword argument that can be given to the MAD-X BEAM command.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">make_lhc_beams</span><span class="p">(</span><span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">energy</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">7000</span><span class="p">,</span> <span class="n">emittance</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mf">3.75e-6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Define beams with default configuratons for `LHCB1` and `LHCB2` sequences.</span>

<span class="s2">    Args:</span>

<span class="s2">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">        energy (float): beam energy in GeV. Defaults to 6500.</span>

<span class="s2">        emittance (float): emittance in meters, which will be used to calculate geometric emittance,</span>

<span class="s2">            then fed to the BEAM command.</span>

<span class="s2">    Keyword Args:</span>

<span class="s2">        Any keyword argument that can be given to the MAD-X BEAM command.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Making default beams for &#39;lhcb1&#39; and &#39;lhbc2&#39; sequences&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="err">[</span><span class="s2">&quot;NRJ&quot;</span><span class="err">]</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="err">[</span><span class="s2">&quot;brho&quot;</span><span class="err">]</span> <span class="o">=</span> <span class="n">energy</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="p">.</span><span class="n">clight</span>

    <span class="n">geometric_emit</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="err">[</span><span class="s2">&quot;geometric_emit&quot;</span><span class="err">]</span> <span class="o">=</span> <span class="n">emittance</span> <span class="o">/</span> <span class="p">(</span><span class="n">energy</span> <span class="o">/</span> <span class="mf">0.938</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">beam</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">:</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Defining beam for sequence &#39;lhcb{beam:d}&#39;&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">beam</span><span class="p">(</span>

            <span class="n">sequence</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;lhcb{beam:d}&quot;</span><span class="p">,</span>

            <span class="n">particle</span><span class="o">=</span><span class="s2">&quot;proton&quot;</span><span class="p">,</span>

            <span class="n">bv</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

            <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>

            <span class="n">npart</span><span class="o">=</span><span class="mf">1.15e11</span><span class="p">,</span>

            <span class="n">ex</span><span class="o">=</span><span class="n">geometric_emit</span><span class="p">,</span>

            <span class="n">ey</span><span class="o">=</span><span class="n">geometric_emit</span><span class="p">,</span>

            <span class="n">sige</span><span class="o">=</span><span class="mf">4.5e-4</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>
</code></pre></div>

</details>
<h3 id="make_lhc_thin">make_lhc_thin</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_lhc_thin</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">slicefactor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Makethin for the LHC sequence as previously done in MAD-X macros. This will use the <code>teapot</code> style and
will enforce <code>makedipedge</code>.</p>
<p>Args:
    madx (Madx): an instantiated cpymad.madx.Madx object.
    sequence (str): the sequence to use for the MAKETHIN command.
    slicefactor (int): the slice factor to apply in makethin. Defaults to 1.</p>
<p>Keyword Args:
    The keyword arguments for the MAD-X MAKETHN commands, namely <code>style</code> (will default to <code>teapot</code>) and
    the <code>makedipedge</code> flag (will default to True).</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">make_lhc_thin</span><span class="p">(</span><span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">sequence</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span> <span class="n">slicefactor</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    Makethin for the LHC sequence as previously done in MAD-X macros. This will use the `teapot` style and</span>

<span class="s2">    will enforce `makedipedge`.</span>

<span class="s2">    Args:</span>

<span class="s2">        madx (Madx): an instantiated cpymad.madx.Madx object.</span>

<span class="s2">        sequence (str): the sequence to use for the MAKETHIN command.</span>

<span class="s2">        slicefactor (int): the slice factor to apply in makethin. Defaults to 1.</span>

<span class="s2">    Keyword Args:</span>

<span class="s2">        The keyword arguments for the MAD-X MAKETHN commands, namely `style` (will default to `teapot`) and</span>

<span class="s2">        the `makedipedge` flag (will default to True).</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Slicing sequence &#39;{sequence}&#39;&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

    <span class="n">four_slices_patterns</span> <span class="o">=</span> <span class="err">[</span><span class="n">r</span><span class="s2">&quot;mbx</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">r</span><span class="s2">&quot;mbrb</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">r</span><span class="s2">&quot;mbrc</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">r</span><span class="s2">&quot;mbrs</span><span class="err">\</span><span class="s2">.&quot;</span><span class="err">]</span>

    <span class="n">four_slicefactor_patterns</span> <span class="o">=</span> <span class="err">[</span>

        <span class="n">r</span><span class="s2">&quot;mqwa</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqwb</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqy</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqm</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqmc</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqml</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqtlh</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqtli</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

        <span class="n">r</span><span class="s2">&quot;mqt</span><span class="err">\</span><span class="s2">.&quot;</span><span class="p">,</span>

    <span class="err">]</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for general MB and MQ elements&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;MQ&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for triplets&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;mqxa&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">16</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;mqxb&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">16</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for various specifc mb elements&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="k">in</span> <span class="n">four_slices_patterns</span><span class="o">:</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Defining slices for varous specifc mq elements&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="k">in</span> <span class="n">four_slicefactor_patterns</span><span class="o">:</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;makethin&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">slicefactor</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;teapot&quot;</span><span class="p">)</span>

    <span class="n">makedipedge</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s2">&quot;makedipedge&quot;</span><span class="p">,</span> <span class="no">False</span><span class="p">)</span>  <span class="c1"># defaults to False to compensate default TEAPOT style</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">makethin</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">makedipedge</span><span class="o">=</span><span class="n">makedipedge</span><span class="p">)</span>
</code></pre></div>

</details>
<h3 id="make_sixtrack_output">make_sixtrack_output</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_sixtrack_output</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>INITIAL IMPLEMENTATION CREDITS GO TO JOSCHUA DILLY (@JoschD).</p>
<p>Prepare output for sixtrack run.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>energy</td>
<td>float</td>
<td>beam energy in GeV.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">make_sixtrack_output</span><span class="p">(</span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="nl">energy</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    INITIAL IMPLEMENTATION CREDITS GO TO JOSCHUA DILLY (@JoschD).</span>

<span class="ss">    Prepare output for sixtrack run.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        energy (float): beam energy in GeV.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Preparing outputs for SixTrack&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Powering RF cavities&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">&quot;VRF400&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">16</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">injection</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">protons</span><span class="w"> </span><span class="n">iirc</span><span class="vm">?</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">&quot;LAGRF400.B1&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">cavity</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="nf">difference</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">2</span><span class="nf">pi</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="o">[</span><span class="n">&quot;LAGRF400.B2&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Executing TWISS and SIXTRACK commands&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">twiss</span><span class="p">()</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sixtrack</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">sixtrack</span><span class="p">(</span><span class="n">cavall</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="o">=</span><span class="mf">0.017</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HL</span><span class="p">(</span><span class="n">LHC</span><span class="p">)</span><span class="w"> </span><span class="n">magnet</span><span class="w"> </span><span class="n">radius</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="match_no_coupling_through_ripkens">match_no_coupling_through_ripkens</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">match_no_coupling_through_ripkens</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vary_knobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Matching routine to get cross-term Ripken parameters beta_12 and beta_21 to be 0 at a given location.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>sequence</td>
<td>str</td>
<td>name of the sequence to activate for the matching.</td>
<td>None</td>
</tr>
<tr>
<td>location</td>
<td>str</td>
<td>the name of the element at which one wants the cross-term Ripkens to be 0.</td>
<td>None</td>
</tr>
<tr>
<td>vary_knobs</td>
<td>Sequence[str]</td>
<td>the variables names to 'vary' in the MADX routine.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">match_no_coupling_through_ripkens</span><span class="p">(</span><span class="w"></span>

<span class="w">    </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"> </span><span class="k">sequence</span><span class="err">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">location</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="nl">vary_knobs</span><span class="p">:</span><span class="w"> </span><span class="k">Sequence</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Matching routine to get cross-term Ripken parameters beta_12 and beta_21 to be 0 at a given location.</span>

<span class="ss">    Args:</span>

<span class="ss">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">        sequence (str): name of the sequence to activate for the matching.</span>

<span class="ss">        location (str): the name of the element at which one wants the cross-term Ripkens to be 0.</span>

<span class="ss">        vary_knobs (Sequence[str]): the variables names to &#39;vary&#39; in the MADX routine.</span>

<span class="ss">    &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Matching Ripken parameters for no coupling at location {location}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Creating macro tu update Ripkens&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="k">input</span><span class="p">(</span><span class="ss">&quot;do_ripken: macro = {twiss, ripken=True;}&quot;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">cpymad</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="p">.</span><span class="k">input</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">macros</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Matching Parameters&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">match</span><span class="p">(</span><span class="k">sequence</span><span class="o">=</span><span class="k">sequence</span><span class="p">,</span><span class="w"> </span><span class="n">use_macro</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">chrom</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">knob</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">vary_knobs</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">vary</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">knob</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">use_macro</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;do_ripken&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="k">input</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;constraint, expr=table(twiss, {location}, beta12)=0&quot;</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">includes</span><span class="w"> </span><span class="ss">&quot; and fails</span>

<span class="ss">    madx.input(f&quot;</span><span class="k">constraint</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="o">=</span><span class="nc">table</span><span class="p">(</span><span class="n">twiss</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="n">location</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">beta21</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="ss">&quot;)  # need input else includes &quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">fails</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">lmdif</span><span class="p">(</span><span class="n">calls</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-21</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">endmatch</span><span class="p">()</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="power_landau_octupoles">power_landau_octupoles</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">power_landau_octupoles</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">mo_current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">defective_arc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Power the Landau octupoles in the (HL)LHC.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>mo_current</td>
<td>float</td>
<td>MO powering in Amps.</td>
<td>None</td>
</tr>
<tr>
<td>beam</td>
<td>int</td>
<td>beam to use.</td>
<td>None</td>
</tr>
<tr>
<td>defective_arc</td>
<td>None</td>
<td>If set to <code>True</code>, the KOD in Arc 56 are powered for less Imax.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">power_landau_octupoles</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">mo_current</span><span class="p">:</span> <span class="nb nb-Type">float</span><span class="p">,</span> <span class="n">beam</span><span class="p">:</span> <span class="nb nb-Type">int</span><span class="p">,</span> <span class="n">defective_arc</span><span class="p">:</span> <span class="nb nb-Type">bool</span> <span class="o">=</span> <span class="n">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Power the Landau octupoles in the (HL)LHC.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        mo_current (float): MO powering in Amps.</span>

<span class="sd">        beam (int): beam to use.</span>

<span class="sd">        defective_arc: If set to `True`, the KOD in Arc 56 are powered for less Imax.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">try</span><span class="p">:</span>

        <span class="n">brho</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">nrj</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">clight</span>  <span class="c1"># clight is MAD-X constant</span>

    <span class="n">except</span> <span class="n">AttributeError</span> <span class="k">as</span> <span class="n">madx_error</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>

            <span class="s2">&quot;The global MAD-X variable &#39;NRJ&#39; should have been set in the optics files but is not defined.&quot;</span>

        <span class="p">)</span>

        <span class="n">raise</span> <span class="n">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;No &#39;NRJ&#39; variable found in scripts&quot;</span><span class="p">)</span> <span class="n">from</span> <span class="n">madx_error</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Powering Landau Octupoles, beam {beam} @ {madx.globals.nrj} GeV with {mo_current} A.&quot;</span><span class="p">)</span>

    <span class="n">strength</span> <span class="o">=</span> <span class="n">mo_current</span> <span class="o">/</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Imax_MO</span> <span class="o">*</span> <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Kmax_MO</span> <span class="o">/</span> <span class="n">brho</span>

    <span class="n">beam</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">beam</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">beam</span>

    <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">_all_lhc_arcs</span><span class="p">(</span><span class="n">beam</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="s2">&quot;FD&quot;</span><span class="p">:</span>

            <span class="n">octupole</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;KO{fd}.{arc}&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Powering element &#39;{octupole}&#39; at {strength} Amps&quot;</span><span class="p">)</span>

            <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">octupole</span><span class="p">]</span> <span class="o">=</span> <span class="n">strength</span>

    <span class="k">if</span> <span class="n">defective_arc</span> <span class="ow">and</span> <span class="p">(</span><span class="n">beam</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s2">&quot;KOD.A56B1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strength</span> <span class="o">*</span> <span class="mf">4.65</span> <span class="o">/</span> <span class="mi">6</span>  <span class="c1"># defective MO group</span>
</code></pre></div>

</details>
<h3 id="re_cycle_sequence">re_cycle_sequence</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">re_cycle_sequence</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">sequence</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lhcb1&#39;</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;IP3&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Re-cycle the provided sequence from a different starting point.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>Madx</td>
<td>an instantiated cpymad.madx.Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>sequence</td>
<td>str</td>
<td>the sequence to re cycle.</td>
<td>None</td>
</tr>
<tr>
<td>start</td>
<td>str</td>
<td>element to start the new cycle from.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">re_cycle_sequence</span><span class="p">(</span><span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">sequence</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&quot;lhcb1&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&quot;IP3&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="o">:</span>

    <span class="s">&quot;&quot;&quot;</span>

<span class="s">    Re-cycle the provided sequence from a different starting point.</span>

<span class="s">    Args:</span>

<span class="s">        madx (Madx): an instantiated cpymad.madx.Madx object.</span>

<span class="s">        sequence (str): the sequence to re cycle.</span>

<span class="s">        start (str): element to start the new cycle from.</span>

<span class="s">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;Re-cycling sequence &#39;</span><span class="p">{</span><span class="n">sequence</span><span class="p">}</span><span class="s">&#39; from {start}&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">seqedit</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>

    <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="kd">ende</span><span class="n">dit</span><span class="p">()</span>
</code></pre></div>

</details>
<h3 id="reset_lhc_bump_flags">reset_lhc_bump_flags</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_lhc_bump_flags</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Resets all LHC IP bump flags to 0.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">reset_lhc_bump_flags</span><span class="p">(</span><span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="o">:</span>

    <span class="s">&quot;&quot;&quot;</span>

<span class="s">    Resets all LHC IP bump flags to 0.</span>

<span class="s">    Args:</span>

<span class="s">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Resetting all LHC IP bump flags&quot;</span><span class="p">)</span>

    <span class="n">ALL_BUMPS</span> <span class="o">=</span> <span class="p">(</span>

        <span class="n">LHC_ANGLE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_CROSSING_ANGLE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_EXPERIMENT_STATE_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_IP2_SPECIAL_FLAG</span>

        <span class="o">+</span> <span class="n">LHC_IP_OFFSET_FLAGS</span>

        <span class="o">+</span> <span class="n">LHC_PARALLEL_SEPARATION_FLAGS</span>

    <span class="p">)</span>

    <span class="n">with</span> <span class="n">madx</span><span class="p">.</span><span class="n">batch</span><span class="p">()</span><span class="o">:</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">globals</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="n">bump</span><span class="o">:</span> <span class="mi">0</span> <span class="n">for</span> <span class="n">bump</span> <span class="kr">in</span> <span class="n">ALL_BUMPS</span><span class="p">})</span>
</code></pre></div>

</details>
<h3 id="vary_independent_ir_quadrupoles">vary_independent_ir_quadrupoles</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">vary_independent_ir_quadrupoles</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">quad_numbers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">),</span>
    <span class="n">beam</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>
<p>Send the <code>vary</code> commands for the desired quadrupoles in the IRs. The independent quadrupoles for which</p>
<p>this is implemented are Q4 to Q13 included. This is useful to setup some specific matching involving
these elements.</p>
<p>It is necessary to have defined a 'brho' variable when creating your beams.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>quad_numbers</td>
<td>Sequence[int]</td>
<td>quadrupoles to be varied, by number (aka position from IP).</td>
<td>None</td>
</tr>
<tr>
<td>ip</td>
<td>int</td>
<td>the IP around which to apply the instructions. Defaults to 1.</td>
<td>1</td>
</tr>
<tr>
<td>sides</td>
<td>Sequence[str]</td>
<td>the sides of IP to act on. Should be <code>R</code> for right and <code>L</code> for left.</td>
<td></td>
</tr>
<tr>
<td>Defaults to both sides of the IP.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>beam</td>
<td>int</td>
<td>the beam for which to apply the instructions. Defaults to 1.</td>
<td>1</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">vary_independent_ir_quadrupoles</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span> <span class="n">quad_numbers</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb nb-Type">int</span><span class="p">],</span> <span class="n">ip</span><span class="p">:</span> <span class="nb nb-Type">int</span><span class="p">,</span> <span class="n">sides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span> <span class="n">beam</span><span class="p">:</span> <span class="nb nb-Type">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Send the `vary` commands for the desired quadrupoles in the IRs. The independent quadrupoles for which</span>

<span class="sd">    this is implemented are Q4 to Q13 included. This is useful to setup some specific matching involving</span>

<span class="sd">    these elements.</span>

<span class="sd">    It is necessary to have defined a &#39;brho&#39; variable when creating your beams.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        quad_numbers (Sequence[int]): quadrupoles to be varied, by number (aka position from IP).</span>

<span class="sd">        ip (int): the IP around which to apply the instructions. Defaults to 1.</span>

<span class="sd">        sides (Sequence[str]): the sides of IP to act on. Should be `R` for right and `L` for left.</span>

<span class="sd">            Defaults to both sides of the IP.</span>

<span class="sd">        beam (int): the beam for which to apply the instructions. Defaults to 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span>

        <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="ow">or</span> <span class="n">any</span><span class="p">(</span><span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">)</span>

        <span class="ow">or</span> <span class="n">any</span><span class="p">(</span><span class="n">quad</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">quad_numbers</span><span class="p">)</span>

    <span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Either the IP number of the side provided are invalid, not applying any error.&quot;</span><span class="p">)</span>

        <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;quad_numbers&#39;, &#39;ip&#39;, &#39;sides&#39; argument&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Preparing a knob involving quadrupoles {quad_numbers}&quot;</span><span class="p">)</span>

    <span class="c1"># Each quad has a specific power circuit used for their k1 boundaries</span>

    <span class="n">power_circuits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb nb-Type">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;mqy&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;mqm&quot;</span><span class="p">,</span>

        <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;mqm&quot;</span><span class="p">,</span>

        <span class="mi">10</span><span class="p">:</span> <span class="s2">&quot;mqml&quot;</span><span class="p">,</span>

        <span class="mi">11</span><span class="p">:</span> <span class="s2">&quot;mqtli&quot;</span><span class="p">,</span>

        <span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;mqt&quot;</span><span class="p">,</span>

        <span class="mi">13</span><span class="p">:</span> <span class="s2">&quot;mqt&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="k">for</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">quad_numbers</span><span class="p">:</span>

        <span class="n">circuit</span> <span class="o">=</span> <span class="n">power_circuits</span><span class="p">[</span><span class="n">quad</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Sending vary command for Q{quad}{side.upper()}{ip}&quot;</span><span class="p">)</span>

            <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span>

                <span class="n">name</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;kq{&#39;t&#39; if quad &gt;= 11 else &#39;&#39;}{&#39;l&#39; if quad == 11 else &#39;&#39;}{quad}.{side}{ip}b{beam}&quot;</span><span class="p">,</span>

                <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>

                <span class="n">lower</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;-{circuit}.{&#39;b&#39; if quad == 7 else &#39;&#39;}{quad}{side}{ip}.b{beam}-&gt;kmax/brho&quot;</span><span class="p">,</span>

                <span class="n">upper</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;+{circuit}.{&#39;b&#39; if quad == 7 else &#39;&#39;}{quad}{side}{ip}.b{beam}-&gt;kmax/brho&quot;</span><span class="p">,</span>

            <span class="p">)</span>
</code></pre></div>

</details>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Index
              </span>
            </div>
          </a>
        
        
          <a href="../matching/" title="Matching" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Matching
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>