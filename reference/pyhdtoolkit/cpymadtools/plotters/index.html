
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.0">
    
    
      
        <title>Plotters - PyhDToolkit</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:300,400,400i,700%7CFira+Code&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu Mono";--md-code-font-family:"Fira Code"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <script>function __prefix(e){return new URL("../../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-pyhdtoolkitcpymadtoolsplotters" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="PyhDToolkit" class="md-header__button md-logo" aria-label="PyhDToolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyhDToolkit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Plotters
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/fsoubelet/PyhDToolkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PyhDToolkit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="PyhDToolkit" class="md-nav__button md-logo" aria-label="PyhDToolkit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PyhDToolkit
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/fsoubelet/PyhDToolkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    PyhDToolkit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/About_PyhDToolkit/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Pyhdtoolkit
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pyhdtoolkit" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Pyhdtoolkit
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_2" type="checkbox" id="__nav_4_1_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_2">
          Cpymadtools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cpymadtools" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpymadtools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        Constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../correctors/" class="md-nav__link">
        Correctors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../generators/" class="md-nav__link">
        Generators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lhc/" class="md-nav__link">
        Lhc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../matching/" class="md-nav__link">
        Matching
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../orbit/" class="md-nav__link">
        Orbit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parameters/" class="md-nav__link">
        Parameters
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Plotters
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Plotters
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apertureplotter" class="md-nav__link">
    AperturePlotter
  </a>
  
    <nav class="md-nav" aria-label="AperturePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_aperture" class="md-nav__link">
    plot_aperture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beamenvelopeplotter" class="md-nav__link">
    BeamEnvelopePlotter
  </a>
  
    <nav class="md-nav" aria-label="BeamEnvelopePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_1" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_envelope" class="md-nav__link">
    plot_envelope
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crossingschemeplotter" class="md-nav__link">
    CrossingSchemePlotter
  </a>
  
    <nav class="md-nav" aria-label="CrossingSchemePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_2" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_two_lhc_ips_crossings" class="md-nav__link">
    plot_two_lhc_ips_crossings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamicapertureplotter" class="md-nav__link">
    DynamicAperturePlotter
  </a>
  
    <nav class="md-nav" aria-label="DynamicAperturePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_3" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_dynamic_aperture" class="md-nav__link">
    plot_dynamic_aperture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#latticeplotter" class="md-nav__link">
    LatticePlotter
  </a>
  
    <nav class="md-nav" aria-label="LatticePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_4" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_latwiss" class="md-nav__link">
    plot_latwiss
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_machine_survey" class="md-nav__link">
    plot_machine_survey
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phasespaceplotter" class="md-nav__link">
    PhaseSpacePlotter
  </a>
  
    <nav class="md-nav" aria-label="PhaseSpacePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_5" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_courant_snyder_phase_space" class="md-nav__link">
    plot_courant_snyder_phase_space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_courant_snyder_phase_space_colored" class="md-nav__link">
    plot_courant_snyder_phase_space_colored
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tunediagramplotter" class="md-nav__link">
    TuneDiagramPlotter
  </a>
  
    <nav class="md-nav" aria-label="TuneDiagramPlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-methods_6" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#farey_sequence" class="md-nav__link">
    farey_sequence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_tune_diagram" class="md-nav__link">
    plot_tune_diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ptc/" class="md-nav__link">
        Ptc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../special/" class="md-nav__link">
        Special
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../track/" class="md-nav__link">
        Track
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tune/" class="md-nav__link">
        Tune
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../twiss/" class="md-nav__link">
        Twiss
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_3" type="checkbox" id="__nav_4_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_3">
          Maths
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Maths" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_3">
          <span class="md-nav__icon md-icon"></span>
          Maths
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/nonconvex_phase_sync/" class="md-nav__link">
        Nonconvex Phase Sync
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/stats_fitting/" class="md-nav__link">
        Stats Fitting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../maths/utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_4" type="checkbox" id="__nav_4_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_4">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Models" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_4">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/beam/" class="md-nav__link">
        Beam
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/htc/" class="md-nav__link">
        Htc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../models/madx/" class="md-nav__link">
        Madx
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_5" type="checkbox" id="__nav_4_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_5">
          Optics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Optics" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_5">
          <span class="md-nav__icon md-icon"></span>
          Optics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/beam/" class="md-nav__link">
        Beam
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/ripken/" class="md-nav__link">
        Ripken
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../optics/twiss/" class="md-nav__link">
        Twiss
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_6" type="checkbox" id="__nav_4_1_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_6">
          Plotting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Plotting" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_6">
          <span class="md-nav__icon md-icon"></span>
          Plotting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plotting/helpers/" class="md-nav__link">
        Helpers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../plotting/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_7" type="checkbox" id="__nav_4_1_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_7">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_7">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/cmdline/" class="md-nav__link">
        Cmdline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/contexts/" class="md-nav__link">
        Contexts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/defaults/" class="md-nav__link">
        Defaults
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/executors/" class="md-nav__link">
        Executors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/htc_monitor/" class="md-nav__link">
        Htc Monitor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/operations/" class="md-nav__link">
        Operations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/printutil/" class="md-nav__link">
        Printutil
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apertureplotter" class="md-nav__link">
    AperturePlotter
  </a>
  
    <nav class="md-nav" aria-label="AperturePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_aperture" class="md-nav__link">
    plot_aperture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beamenvelopeplotter" class="md-nav__link">
    BeamEnvelopePlotter
  </a>
  
    <nav class="md-nav" aria-label="BeamEnvelopePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_1" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_envelope" class="md-nav__link">
    plot_envelope
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crossingschemeplotter" class="md-nav__link">
    CrossingSchemePlotter
  </a>
  
    <nav class="md-nav" aria-label="CrossingSchemePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_2" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_two_lhc_ips_crossings" class="md-nav__link">
    plot_two_lhc_ips_crossings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamicapertureplotter" class="md-nav__link">
    DynamicAperturePlotter
  </a>
  
    <nav class="md-nav" aria-label="DynamicAperturePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_3" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_dynamic_aperture" class="md-nav__link">
    plot_dynamic_aperture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#latticeplotter" class="md-nav__link">
    LatticePlotter
  </a>
  
    <nav class="md-nav" aria-label="LatticePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_4" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_latwiss" class="md-nav__link">
    plot_latwiss
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_machine_survey" class="md-nav__link">
    plot_machine_survey
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phasespaceplotter" class="md-nav__link">
    PhaseSpacePlotter
  </a>
  
    <nav class="md-nav" aria-label="PhaseSpacePlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-methods_5" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_courant_snyder_phase_space" class="md-nav__link">
    plot_courant_snyder_phase_space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_courant_snyder_phase_space_colored" class="md-nav__link">
    plot_courant_snyder_phase_space_colored
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tunediagramplotter" class="md-nav__link">
    TuneDiagramPlotter
  </a>
  
    <nav class="md-nav" aria-label="TuneDiagramPlotter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-methods_6" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#farey_sequence" class="md-nav__link">
    farey_sequence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot_tune_diagram" class="md-nav__link">
    plot_tune_diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/fsoubelet/PyhDToolkit/edit/main/reference/pyhdtoolkit/cpymadtools/plotters.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="module-pyhdtoolkitcpymadtoolsplotters">Module pyhdtoolkit.cpymadtools.plotters</h1>
<p>Module cpymadtools.plotters</p>
<hr />
<p>Created on 2019.12.08</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Module cpymadtools.plotters</span>

<span class="sd">---------------------------</span>

<span class="sd">Created on 2019.12.08</span>

<span class="sd">:author: Felix Soubelet (felix.soubelet@cern.ch)</span>

<span class="sd">A collection of functions to plot different output results from a cpymad.madx.Madx object&#39;s</span>

<span class="sd">simulation results.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="kn">import</span> <span class="nn">matplotlib.axes</span>

<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">tfs</span>

<span class="kn">from</span> <span class="nn">cpymad.madx</span> <span class="kn">import</span> <span class="n">Madx</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span> <span class="k">as</span> <span class="n">mcolors</span>

<span class="kn">from</span> <span class="nn">pyhdtoolkit.models.beam</span> <span class="kn">import</span> <span class="n">BeamParameters</span>

<span class="kn">from</span> <span class="nn">pyhdtoolkit.optics.twiss</span> <span class="kn">import</span> <span class="n">courant_snyder_transform</span>

<span class="kn">from</span> <span class="nn">pyhdtoolkit.utils.defaults</span> <span class="kn">import</span> <span class="n">PLOT_PARAMS</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">PLOT_PARAMS</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;xtick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;ytick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">})</span>  <span class="c1"># need to reiterate these somehow</span>

<span class="n">COLORS_DICT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">BASE_COLORS</span><span class="p">,</span> <span class="o">**</span><span class="n">mcolors</span><span class="o">.</span><span class="n">CSS4_COLORS</span><span class="p">)</span>

<span class="n">BY_HSV</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">rgb_to_hsv</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])),</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">COLORS_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="n">SORTED_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">hsv</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">BY_HSV</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">AperturePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to plot the aperture of your machine as determined by `MAD-X`&#39;s `APERTURE` command.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_aperture</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="n">aperture_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Provided with an active `cpymad` instance after having ran a script, will create a plot representing</span>

<span class="sd">        nicely the lattice layout and the aperture tolerance across the machine. Beware: this function</span>

<span class="sd">        assumes the user has previously made a call to the `APERTURE` command in `MAD-X`.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            title (str): title of your plot.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 1).</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="sd">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="sd">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="sd">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="sd">                not None, using the tuple passed.</span>

<span class="sd">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="sd">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="sd">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="sd">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="sd">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="sd">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="sd">            aperture_ylim (Tuple[float, float]): vertical axis limits for the aperture values. Defaults to</span>

<span class="sd">                `None`, to be determined by matplotlib based on the provided values.</span>

<span class="sd">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="sd">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="sd">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="sd">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="sd">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="sd">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="sd">                height of sextupole patches.</span>

<span class="sd">            color (str): the color argument given to the aperture lines. Defaults to `None`, and should be</span>

<span class="sd">                the first color in your `rcParams`&#39;s cycler.</span>

<span class="sd">        Keyword Args:</span>

<span class="sd">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="sd">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="sd">        WARNING:</span>

<span class="sd">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="sd">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="sd">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="sd">            overlap.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting aperture limits and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">twiss_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">aperture</span><span class="p">))</span>  <span class="c1"># slicing -&gt; issues with .dframe()</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">aperture_df</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="p">[</span><span class="n">aperture_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">aperture_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting aperture values on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting aperture values&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">aperture_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Aperture Limits&quot;</span>

        <span class="p">)</span>

        <span class="n">aperture_axis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">aperture_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">aperture_df</span><span class="o">.</span><span class="n">n1</span><span class="o">.</span><span class="kp">max</span><span class="p">(),</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="o">.</span><span class="n">legend</span>

        <span class="n">aperture_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$n_</span><span class="si">{1}</span><span class="s2"> \ [\sigma]$&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$S \ [m]$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">aperture_ylim</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for aperture plot&quot;</span><span class="p">)</span>

            <span class="n">aperture_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">aperture_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving latwiss plot as </span><span class="si">{</span><span class="n">savefig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">BeamEnvelopePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to plot the estimated beam envelope of your machine.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_envelope</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">beam_params</span><span class="p">:</span> <span class="n">BeamParameters</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>

        <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">hplane_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>

        <span class="n">vplane_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Provided with an active `cpymad` instance after having ran a script, plots an estimation of the beam</span>

<span class="sd">        stay-clear enveloppe in your machine, as well as an estimation of the aperture limits.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            beam_params (BeamParameters): a validated BeamParameters object from</span>

<span class="sd">                `pyhdtoolkit.optics.beam.compute_beam_parameters`.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (13, 20).</span>

<span class="sd">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="sd">                not None, using the tuple passed.</span>

<span class="sd">            hplane_ylim (Tuple[float, float]): the y limits for the horizontal plane plot (so</span>

<span class="sd">                that machine geometry doesn&#39;t make the  plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="sd">            vplane_ylim (Tuple[float, float]): the y limits for the vertical plane plot (so that</span>

<span class="sd">                machine geometry doesn&#39;t make the plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="c1"># We need to interpolate in order to get high resolution along the S direction</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting estimated machine aperture and beam envelope&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running interpolation in MAD-X&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;drift&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="s2">&quot;#s/#e&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;quadrupole&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="s2">&quot;#s/#e&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;sbend&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="s2">&quot;#s/#e&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="kp">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;rbend&quot;</span><span class="p">,</span> <span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="s2">&quot;#s/#e&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dframe from MAD-X&quot;</span><span class="p">)</span>

        <span class="n">twiss_hr</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;betatronic_envelope_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">betx</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">eg_y_m</span><span class="p">)</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;betatronic_envelope_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">bety</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">eg_y_m</span><span class="p">)</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;dispersive_envelope_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">deltap_p</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;dispersive_envelope_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">deltap_p</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;envelope_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span>

            <span class="n">twiss_hr</span><span class="o">.</span><span class="n">betatronic_envelope_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">deltap_p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="p">)</span>

        <span class="n">twiss_hr</span><span class="p">[</span><span class="s2">&quot;envelope_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span>

            <span class="n">twiss_hr</span><span class="o">.</span><span class="n">betatronic_envelope_y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="n">beam_params</span><span class="o">.</span><span class="n">deltap_p</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="p">)</span>

        <span class="n">machine</span> <span class="o">=</span> <span class="n">twiss_hr</span><span class="p">[</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">apertype</span> <span class="o">==</span> <span class="s2">&quot;ellipse&quot;</span><span class="p">]</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting the horizontal aperture&quot;</span><span class="p">)</span>

        <span class="n">axis1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="o">-</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span><span class="p">,</span> <span class="s2">&quot;k.-&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span><span class="p">,</span> <span class="s2">&quot;k.-&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">hplane_ylim</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$S \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">axis1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Horizontal aperture at </span><span class="si">{</span><span class="n">beam_params</span><span class="o">.</span><span class="n">pc_GeV</span><span class="si">}</span><span class="s2"> GeV/c&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting the vertical aperture&quot;</span><span class="p">)</span>

        <span class="n">axis2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="o">-</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="o">-</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">twiss_hr</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span><span class="p">,</span> <span class="s2">&quot;k.-&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span><span class="p">,</span> <span class="s2">&quot;k.-&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">vplane_ylim</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Y \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$S \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">axis2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vertical aperture at </span><span class="si">{</span><span class="n">beam_params</span><span class="o">.</span><span class="n">pc_GeV</span><span class="si">}</span><span class="s2"> GeV/c&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting the stay-clear envelope&quot;</span><span class="p">)</span>

        <span class="n">axis3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_1</span> <span class="o">/</span> <span class="n">machine</span><span class="o">.</span><span class="n">envelope_x</span><span class="p">,</span> <span class="s2">&quot;.-b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Horizontal plane&quot;</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">machine</span><span class="o">.</span><span class="n">aper_2</span> <span class="o">/</span> <span class="n">machine</span><span class="o">.</span><span class="n">envelope_y</span><span class="p">,</span> <span class="s2">&quot;.-r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Vertical plane&quot;</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$n1$&quot;</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$S \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="n">axis3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stay-clear envelope at </span><span class="si">{</span><span class="n">beam_params</span><span class="o">.</span><span class="n">pc_GeV</span><span class="si">}</span><span class="s2"> GeV/c&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving aperture plot at &#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span><span class="o">.</span><span class="kp">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">CrossingSchemePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to plot LHC crossing schemes at provided IPs.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">_highlight_mbx_and_mqx</span><span class="p">(</span>

        <span class="n">axis</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">tfs</span><span class="o">.</span><span class="n">TfsDataFrame</span><span class="p">],</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plot colored pacthes highlighting zones with MBX and MQX elements in a twin of the given axis.</span>

<span class="sd">        Assumes that the plot_df s already centered at 0 on the IP point!</span>

<span class="sd">        Args:</span>

<span class="sd">            axis (matplotlib.axes.Axes): the axis to twin and then on which to add patches.</span>

<span class="sd">            plot_df (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone, centered on 0</span>

<span class="sd">                at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="sd">            ip (int): the IP number of the given IR.</span>

<span class="sd">        Keyword Args:</span>

<span class="sd">            Any keyword argument is given to the `axis.axvspan` method called for each patch.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">left_ir</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;s &lt; 0&quot;</span><span class="p">)</span>  <span class="c1"># no need to copy, we don&#39;t touch data</span>

        <span class="n">right_ir</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;s &gt; 0&quot;</span><span class="p">)</span>  <span class="c1"># no need to copy, we don&#39;t touch data</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Determining MBX areas left and right of IP&quot;</span><span class="p">)</span>

        <span class="n">left_mbx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">left_ir</span><span class="p">[</span><span class="n">left_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span>

            <span class="n">left_ir</span><span class="p">[</span><span class="n">left_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">right_mbx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">right_ir</span><span class="p">[</span><span class="n">right_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span>

            <span class="n">right_ir</span><span class="p">[</span><span class="n">right_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Determining MQX areas left and right of IP&quot;</span><span class="p">)</span>

        <span class="n">left_mqx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">left_ir</span><span class="p">[</span><span class="n">left_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span>

            <span class="n">left_ir</span><span class="p">[</span><span class="n">left_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">right_mqx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">right_ir</span><span class="p">[</span><span class="n">right_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span>

            <span class="n">right_ir</span><span class="p">[</span><span class="n">right_ir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Highlighting MBX and MQX areas on a twin axis&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">left_mbx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MBX&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">left_mqx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MQX&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;IP</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">right_mqx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># no label duplication</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">right_mbx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># no label duplication</span>

        <span class="n">patches_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">_plot_crossing_in_ir</span><span class="p">(</span>

        <span class="n">axis</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>

        <span class="n">plot_df_b1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>

        <span class="n">plot_df_b2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>

        <span class="n">plot_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

        <span class="n">scaling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plot the X or Y orbit for the IR on the given axis. Assumes that the plot_df_b1 and plot_df_b2</span>

<span class="sd">        are already centered at 0 on the IP point!</span>

<span class="sd">        Args:</span>

<span class="sd">            axis (matplotlib.axes.Axes): the axis on which to plot.</span>

<span class="sd">            plot_df_b1 (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone for beam 1</span>

<span class="sd">            of the LHC, centered on 0 at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="sd">            plot_df_b2 (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone for beam 2</span>

<span class="sd">            of the LHC, centered on 0 at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="sd">            plot_column (str): which column (should be `x` or `y`) to plot for the orbit.</span>

<span class="sd">            scaling (float): scaling factor to apply to the plotted data. Defaults to 1 (no change of data).</span>

<span class="sd">            xlabel (str): if given, will be used for the `xlabel` of the axis. Defaults to `None`.</span>

<span class="sd">            ylabel (str): if given, will be used for the `ylabel` of the axis. Defaults to `None`.</span>

<span class="sd">            title (str): if given, will be used for the `title` of the axis. Defaults to `None`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting orbit &#39;</span><span class="si">{</span><span class="n">plot_column</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">plot_df_b1</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>

            <span class="n">plot_df_b1</span><span class="p">[</span><span class="n">plot_column</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span>

            <span class="s2">&quot;bo&quot;</span><span class="p">,</span>

            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>

            <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>

            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>

            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Beam 1&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">plot_df_b2</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>

            <span class="n">plot_df_b2</span><span class="p">[</span><span class="n">plot_column</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span>

            <span class="s2">&quot;ro&quot;</span><span class="p">,</span>

            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>

            <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>

            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>

            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Beam 2&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_two_lhc_ips_crossings</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">first_ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>

        <span class="n">second_ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="n">ir_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">275</span><span class="p">,</span>

        <span class="n">highlight_mqx_and_mbx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Provided with an active `cpymad.madx.Madx` instance after having ran a script, will create a plot</span>

<span class="sd">        representing nicely the crossing schemes at two provided IPs. This assumes the appropriate LHC</span>

<span class="sd">        sequence and opticsfile have been loaded, and both `lhcb1` and `lhcb2` beams are defined. It is</span>

<span class="sd">        very recommended to re-cycle the sequences from a point which is not an IP</span>

<span class="sd">        WARNING: This function will get TWISS tables for both beams, which means it will `USE` both the</span>

<span class="sd">        `lhcb1` and `lhcb2` sequences, erasing previously defined errors or orbit corrections. The second</span>

<span class="sd">        sequence `USE` will be called on is `lhcb2`, which may not be the one you were using before. Please</span>

<span class="sd">        re-`use` your wanted sequence after calling this function!</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            first_ip (int): the first of the two IPs to plot crossing schemes for.</span>

<span class="sd">            second_ip (int): the second of the two IPs to plot crossing schemes for.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 12).</span>

<span class="sd">            ir_limit (float): the amount of meters to keep left and right of the IP point. Will also</span>

<span class="sd">                determine the xlimits of the plots. Defaults to 275.</span>

<span class="sd">            highlight_mqx_and_mbx (bool): if `True`, will add patches highlighting the zones corresponding</span>

<span class="sd">                to MBX and MQX elements. Defaults to `True`.</span>

<span class="sd">            savefig (str): will save the figure if this is not `None`, using the string value passed.</span>

<span class="sd">                Defaults to `None`.</span>

<span class="sd">        Returns:</span>

<span class="sd">            The figure on which the crossing schemes are drawn. One crossing scheme is plotted per IP and</span>

<span class="sd">            per plane (orbit X and orbit Y). The underlying axes can be accessed with &#39;fig.get_axes()&#39;.</span>

<span class="sd">            Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-call the &#39;USE&#39; command on your wanted sequence after this!&quot;</span><span class="p">)</span>

        <span class="c1"># ----- Getting Twiss table dframe for each beam ----- #</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">twiss_df_b1</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">twiss_df_b2</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Determining exact locations of IP points&quot;</span><span class="p">)</span>

        <span class="n">first_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ip</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="n">second_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ip</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="c1"># ----- Plotting figure ----- #</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting crossing schemes for IP</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2"> and IP</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting for IP</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">[</span><span class="n">twiss_df_b1</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)]</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="p">[</span><span class="n">twiss_df_b2</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)]</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">b2_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit X $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;IP</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2"> Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit Y $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Distance to IP</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2"> $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting for IP</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">[</span><span class="n">twiss_df_b1</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)]</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="p">[</span><span class="n">twiss_df_b2</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)]</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">b2_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;IP</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2"> Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Distance to IP</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2"> $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="k">if</span> <span class="n">highlight_mqx_and_mbx</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Highlighting MQX and MBX areas near IPs&quot;</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="o">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving crossing schemes for IP</span><span class="si">{</span><span class="n">first_ip</span><span class="si">}</span><span class="s2"> and IP</span><span class="si">{</span><span class="n">second_ip</span><span class="si">}</span><span class="s2"> plot as &#39;</span><span class="si">{</span><span class="n">savefig</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">DynamicAperturePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;This is currently badly named, and will change in the future.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_dynamic_aperture</span><span class="p">(</span>

        <span class="n">x_coords</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plots a visual aid for the dynamic aperture after a tracking. Initial amplitudes are on the</span>

<span class="sd">        vertical axis, and the turn at which they were lost is in the horizontal axis.</span>

<span class="sd">        Args:</span>

<span class="sd">            x_coords (np.ndarray): numpy array of horizontal coordinates over turns.</span>

<span class="sd">            y_coords (np.ndarray): numpy array of vertical coordinates over turns.</span>

<span class="sd">            n_particles (int): number of particles simulated.</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting the &#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_coords</span><span class="p">)</span><span class="si">}</span><span class="s2"> turns&#39; aperture&quot;</span><span class="p">)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

        <span class="n">turn_lost_at</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">amp_lost</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Determining turns at which particles have been lost&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">):</span>

            <span class="n">amp_lost</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">x_coords</span><span class="p">[</span><span class="n">particle</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y_coords</span><span class="p">[</span><span class="n">particle</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># initial amplitude</span>

            <span class="c1"># this is ok since once coordinates go to `nan` they don&#39;t come back, particle is lost</span>

            <span class="n">turn_lost_at</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span>

                <span class="nb">min</span><span class="p">(</span>

                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x_coords</span><span class="p">[</span><span class="n">particle</span><span class="p">])</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># starts at 0, lost after last valid</span>

                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_coords</span><span class="p">[</span><span class="n">particle</span><span class="p">])</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># starts at 0, lost after last valid</span>

                <span class="p">)</span>

            <span class="p">)</span>

        <span class="n">turn_lost_at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">(</span><span class="n">turn_lost_at</span><span class="p">)</span>

        <span class="n">amp_lost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">(</span><span class="n">amp_lost</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">turn_lost_at</span><span class="p">,</span> <span class="n">amp_lost</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Amplitudes lost over turns&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Turns Survived&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Initial amplitude $[mm]$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving dynamic aperture plot at &#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span><span class="o">.</span><span class="kp">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">LatticePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    A class to elegantly plot the Twiss parameters layout of a machine from a `cpymad.madx.Madx` instance</span>

<span class="sd">    after it has ran, or the machine survey.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_latwiss</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

        <span class="n">plot_dipole_k1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="n">disp_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">125</span><span class="p">),</span>

        <span class="n">beta_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Provided with an active Cpymad class after having ran a script, will create a plot representing nicely</span>

<span class="sd">        the lattice layout and the beta functions along with the horizontal dispertion function. This is very,</span>

<span class="sd">        very heavily reworked code, inspired by code from Guido Sterbini.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            title (str): title of your plot.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 11).</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="sd">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="sd">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="sd">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="sd">                not None, using the tuple passed.</span>

<span class="sd">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="sd">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="sd">            plot_dipole_k1 (bool): if `True`, dipole elements with a quadrupolar gradient will have this</span>

<span class="sd">                gradient plotted as a quadrupole patch. Defaults to `False`.</span>

<span class="sd">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="sd">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="sd">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="sd">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="sd">            disp_ylim (Tuple[float, float]): vertical axis limits for the dispersion values.</span>

<span class="sd">                Defaults to (-10, 125).</span>

<span class="sd">            beta_ylim (Tuple[float, float]): vertical axis limits for the betatron function values.</span>

<span class="sd">                Defaults to None, to be determined by matplotlib based on the provided beta values.</span>

<span class="sd">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="sd">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="sd">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="sd">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="sd">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="sd">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="sd">                height of sextupole patches.</span>

<span class="sd">        Keyword Args:</span>

<span class="sd">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="sd">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="sd">        WARNING:</span>

<span class="sd">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="sd">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="sd">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="sd">            overlap.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting optics functions and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">()</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

        <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="kp">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_dipole_k1</span><span class="o">=</span><span class="n">plot_dipole_k1</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting beta functions on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting beta functions&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">betx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">bety</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_{x,y}$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$S$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting dispersion functions&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span> <span class="o">=</span> <span class="n">betatron_axis</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;sienna&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$D_{x,y}$ $[m]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">beta_ylim</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for betatron functions plot&quot;</span><span class="p">)</span>

            <span class="n">betatron_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">beta_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">disp_ylim</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for dispersion plot&quot;</span><span class="p">)</span>

            <span class="n">dispertion_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">disp_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving latwiss plot as </span><span class="si">{</span><span class="n">savefig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_machine_survey</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Machine Layout&quot;</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">show_elements</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="n">high_orders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Provided with an active Cpymad class after having ran a script, will create a plot</span>

<span class="sd">        representing the machine geometry in 2D. Heavily reworked, original code is from Guido Sterbini.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            title (str): title of your plot.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (16, 11).</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">            show_elements (bool): if True, will try to plot by differentiating elements.</span>

<span class="sd">                Experimental, defaults to False.</span>

<span class="sd">            high_orders (bool): if True, plot sextupoles and octupoles when show_elements is True,</span>

<span class="sd">                otherwise only up to quadrupoles. Defaults to False.</span>

<span class="sd">        Keyword Arguments:</span>

<span class="sd">            Any keyword argument is transmiitted to `matplotlib.pyplot.scatter` calls later on.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting machine survey&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Getting machine survey from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">survey</span><span class="p">()</span>

        <span class="n">survey</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_elements</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting survey with elements differentiation&quot;</span><span class="p">)</span>

            <span class="n">element_dfs</span> <span class="o">=</span> <span class="n">_make_survey_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>

                <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;dipoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>

                <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;dipoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>

                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>

                <span class="n">c</span><span class="o">=</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;dipoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dipoles&quot;</span><span class="p">,</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quad_foc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quad_foc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QF&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quad_defoc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quad_defoc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">high_orders</span><span class="p">:</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting high order magnetic elements (up to octupoles)&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>

                    <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;octupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;octupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MO&quot;</span>

                <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting survey without elements differentiation&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Trying a trick to ensure the colorbar scales values properly up to the max S value and not 1</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Plotting trick invisible data to re-scale colorbar&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">survey</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$S \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Z \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X \ [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving machine survey plot as </span><span class="si">{</span><span class="n">savefig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">PhaseSpacePlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to plot Courant-Snyder coordinates phase space.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_courant_snyder_phase_space</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">u_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>

        <span class="n">pu_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="kp">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>

        <span class="n">plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Horizontal&quot;</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="sd">        and momentum coordinates for a specific plane.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="sd">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="sd">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="sd">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="sd">                and so on.</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="sd">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;HORIZONTAL&quot;</span><span class="p">,</span> <span class="s2">&quot;VERTICAL&quot;</span><span class="p">):</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plane should be either Horizontal or Vertical but &#39;</span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">&#39; was given&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid plane value&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="kp">size</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span>

        <span class="c1"># Getting the twiss parameters for the P matrix to compute Courant-Snyder coordinates</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">alfx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span> <span class="k">else</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">alfy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="kp">beta</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">betx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span> <span class="k">else</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">bety</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting phase space for the </span><span class="si">{</span><span class="n">plane</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2"> plane&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">):</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting and plotting Courant-Snyder coordinates for particle </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="n">u_coordinates</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">pu_coordinates</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>

            <span class="n">u_bar</span> <span class="o">=</span> <span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="kp">beta</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">u_bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{x}</span><span class="s2"> \ [mm]$&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{px}</span><span class="s2"> \ [mrad]$&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{y}</span><span class="s2"> \ [mm]$&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{py}</span><span class="s2"> \ [mrad]$&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;Equal&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving Courant-Snyder phase space plot at &#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span><span class="o">.</span><span class="kp">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_courant_snyder_phase_space_colored</span><span class="p">(</span>

        <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">u_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>

        <span class="n">pu_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>

        <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="kp">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>

        <span class="n">plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Horizontal&quot;</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="sd">        and momentum coordinates for a specific plane. Each particle trajectory has its own color on</span>

<span class="sd">        the plot, within the limit of pyplot&#39;s 156 named colors. The sequence repeats after the</span>

<span class="sd">        156th color.</span>

<span class="sd">        Args:</span>

<span class="sd">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="sd">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="sd">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="sd">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="sd">                and so on.</span>

<span class="sd">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="sd">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="sd">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="sd">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;HORIZONTAL&quot;</span><span class="p">,</span> <span class="s2">&quot;VERTICAL&quot;</span><span class="p">):</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plane should be either horizontal or vertical but &#39;</span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2">&#39; was given&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid plane value&quot;</span><span class="p">)</span>

        <span class="c1"># Getting a sufficiently long array of colors to use</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">SORTED_COLORS</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">):</span>

            <span class="n">colors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="s2">&quot;Plotting colored phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="kp">size</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span>

        <span class="c1"># Getting the twiss parameters for the P matrix to compute Courant-Snyder coordinates</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">alfx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span> <span class="k">else</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">alfy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="kp">beta</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">betx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span> <span class="k">else</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">bety</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting colored phase space for the </span><span class="si">{</span><span class="n">plane</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2"> plane&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">):</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting and plotting Courant-Snyder coordinates for particle </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="n">u_coordinates</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">pu_coordinates</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>

            <span class="n">u_bar</span> <span class="o">=</span> <span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="kp">beta</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">u_bar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HORIZONTAL&quot;</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{x}</span><span class="s2"> \ [mm]$&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{px}</span><span class="s2"> \ [mrad]$&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{y}</span><span class="s2"> \ [mm]$&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\bar</span><span class="si">{py}</span><span class="s2"> \ [mrad]$&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;Equal&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving colored Courant-Snyder phase space plot at &#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span><span class="o">.</span><span class="kp">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="k">class</span> <span class="nc">TuneDiagramPlotter</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to plot a blank tune diagram with Farey sequences, as well as your working points.&quot;&quot;&quot;</span>

    <span class="n">order_to_alpha</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">}</span>

    <span class="n">order_to_rgb</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">152</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">48</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a brown</span>

        <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">57</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">175</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a blue</span>

        <span class="mi">3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">239</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">54</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># an orange</span>

        <span class="mi">4</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">82</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">62</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a green</span>

        <span class="mi">5</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">197</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a red</span>

        <span class="mi">6</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="mi">141</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">184</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a purple</span>

    <span class="p">}</span>

    <span class="n">order_to_linestyle</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="n">order_to_linewidth</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">}</span>

    <span class="n">order_to_label</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;1st order&quot;</span><span class="p">,</span>

        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;2nd order&quot;</span><span class="p">,</span>

        <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;3rd order&quot;</span><span class="p">,</span>

        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;4th order&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;5th order&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;6th order&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">farey_sequence</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Returns the n-th farey_sequence sequence, ascending. Original code from Rogelio Tomás (see Numerical</span>

<span class="sd">        Methods 2018 CAS proceedings: https://arxiv.org/abs/2006.10661).</span>

<span class="sd">        Args:</span>

<span class="sd">            order (int): the order up to which we want to calculate the sequence.</span>

<span class="sd">        Returns:</span>

<span class="sd">            The sequence as a list of plottable 2D points.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing Farey sequence for order </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">order</span>

        <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">:</span>

            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">order</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span>

            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">b</span>

            <span class="n">seq</span><span class="o">.</span><span class="kp">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">seq</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">_plot_resonance_lines_for_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plot resonance lines from farey sequences of the given order on the current figure.</span>

<span class="sd">        Args:</span>

<span class="sd">            order (int): the order of the resonance.</span>

<span class="sd">            axis (matplotlib.axes.Axes): the axis on which to plot the resonance lines.</span>

<span class="sd">        Keyword Args:</span>

<span class="sd">            Any keyword argument is given to plt.plot().</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">order_label</span> <span class="o">=</span> <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_label</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting </span><span class="si">{</span><span class="n">order_label</span><span class="si">}</span><span class="s2"> resonance lines&quot;</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">label</span><span class="o">=</span><span class="n">order_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># to avoid legend duplication in loops below</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="kp">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">farey_sequences</span> <span class="o">=</span> <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">farey_sequence</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="kp">clip</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">clip</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># clip all values to plot to [0, 1]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">farey_sequences</span><span class="p">:</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">node</span>  <span class="c1"># Node h/k on the axes</span>

            <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">farey_sequences</span><span class="p">:</span>

                <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">sequence</span>

                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Resonance line a*Qx + b*Qy = c (linked to p/q)</span>

                <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">p</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kp">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># FN elements below 1/k</span>

                    <span class="k">break</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">plot_tune_diagram</span><span class="p">(</span>

        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

        <span class="n">legend_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">max_order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

        <span class="n">differentiate_orders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Plotting the tune diagram up to the 6th order. Original code from Rogelio Tomás.</span>

<span class="sd">        The first order lines make up the [(0, 0), (0, 1), (1, 1), (1, 0)] square and will only be seen</span>

<span class="sd">        when redefining the limits of the figure, which are by default [0, 1] on each axis.</span>

<span class="sd">        Args:</span>

<span class="sd">            title (str): title of your plot, to be given to the figure. Defaults to an empty string.</span>

<span class="sd">            legend_title (str): if given, will be used as the title of the plot&#39;s legend. If set to `None`,</span>

<span class="sd">                then creating a legend for the figure will not be done by this function and left up to the</span>

<span class="sd">                user&#39;s care (a call to `pyplot.legend` will do). Defaults to `None`.</span>

<span class="sd">            max_order (int): the order up to which to plot resonance lines for, should not exceed 6.</span>

<span class="sd">                Defaults to 6.</span>

<span class="sd">            differentiate_orders (bool): if `True`, the lines for each order will be of a different color.</span>

<span class="sd">                When set to False, there is still minimal differentation through alpha, linewidth and</span>

<span class="sd">                linestyle. Defaults to `False`.</span>

<span class="sd">            figsize (Tuple[int, int]): size of the figure, defaults to (12, 12).</span>

<span class="sd">        Keyword Args:</span>

<span class="sd">            Any keyword argument will be transmitted to the `_plot_resonance_lines_for_order` functino</span>

<span class="sd">            and later on to `pyplot.plot`. Be aware that `alpha`, `ls`, `lw`, `color` and `label` are</span>

<span class="sd">            already set by this function and providing them as kwargs might lead to errors.</span>

<span class="sd">        Returns:</span>

<span class="sd">             The figure on which resonance lines from farey sequences are drawn, up to the specified max</span>

<span class="sd">             order.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">max_order</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">max_order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plotting is not supported outside of 1st-6th order (and not recommended)&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;max_order&#39; argument should be between 1 and 6 included&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting resonance lines up to </span><span class="si">{</span><span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_label</span><span class="p">[</span><span class="n">max_order</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_order</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># high -&gt; low so most importants ones (low) are plotted on top</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span>

                <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_alpha</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>

                <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_linestyle</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>

                <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_linewidth</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>

                <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">order_to_rgb</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="k">if</span> <span class="n">differentiate_orders</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">TuneDiagramPlotter</span><span class="o">.</span><span class="n">_plot_resonance_lines_for_order</span><span class="p">(</span>

                <span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>

            <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$Q_</span><span class="si">{x}</span><span class="s2">$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$Q_</span><span class="si">{y}</span><span class="s2">$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding legend with given title&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">legend_title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

<span class="c1"># ----- Utility plotters ----- #</span>

<span class="k">def</span> <span class="nf">_plot_lattice_series</span><span class="p">(</span>

    <span class="n">ax</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>

    <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>

    <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>

    <span class="n">v_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>

    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>

    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>

    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Plots the layout of your machine as a patch of rectangles for different element types.</span>

<span class="sd">    Original code from Guido Sterbini.</span>

<span class="sd">    Args:</span>

<span class="sd">        ax (matplotlib.axes.Axes): an existing  matplotlib.axis `Axes` object to act on.</span>

<span class="sd">        series (pd.DataFrame): a dataframe with your elements&#39; data.</span>

<span class="sd">        height (float): value to reach for the patch on the y axis.</span>

<span class="sd">        v_offset (float): vertical offset for the patch.</span>

<span class="sd">        color (str): color kwarg to transmit to pyplot.</span>

<span class="sd">        alpha (float): alpha kwarg to transmit to pyplot.</span>

<span class="sd">    Keyword Args:</span>

<span class="sd">        Any kwarg that can be given to matplotlib.patches.Rectangle(), for instance `lw` for the edge line</span>

<span class="sd">        width.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>

        <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>

            <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">series</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">v_offset</span> <span class="o">-</span> <span class="n">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>  <span class="c1"># anchor point</span>

            <span class="n">series</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># width</span>

            <span class="n">height</span><span class="p">,</span>  <span class="c1"># height</span>

            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>

            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_plot_machine_layout</span><span class="p">(</span>

    <span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">,</span>

    <span class="n">quadrupole_patches_axis</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>

    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

    <span class="n">xoffset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

    <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="n">plot_dipoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

    <span class="n">plot_dipole_k1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">plot_quadrupoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

    <span class="n">plot_bpms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">k0l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

    <span class="n">k1l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

    <span class="n">k2l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Provided with an active `cpymad` instance after having ran a script, will plot the lattice layout on a</span>

<span class="sd">    given axis. This is the function that takes care of the machine layout in `LatticePlotter.plot_latwiss`,</span>

<span class="sd">    and is in theory a private function, though if you know what you are doing you may use it individually.</span>

<span class="sd">    The current implementation can take care of dipole, quadrupole and sextupole elements as well as BPMs.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">        quadrupole_patches_axis (matplotlib.axes.Axes): the axis on which to plot. Will also create the</span>

<span class="sd">            appropriate new axes with `twinx()` to plot the element orders asked for.</span>

<span class="sd">        title (str): title of your plot.</span>

<span class="sd">        xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="sd">            to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="sd">            Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="sd">        xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="sd">            not None, using the tuple passed.</span>

<span class="sd">        plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="sd">            the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="sd">        plot_dipole_k1 (bool): if `True`, dipole elements with a quadrupolar gradient will have this</span>

<span class="sd">            gradient plotted as a quadrupole patch. Defaults to `False`.</span>

<span class="sd">        plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="sd">            subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="sd">        plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="sd">            Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="sd">        k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="sd">            height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="sd">        k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="sd">            height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="sd">        k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="sd">            the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="sd">            height of sextupole patches.</span>

<span class="sd">    Keyword Args:</span>

<span class="sd">        Any keyword argument to be transmitted to `_plot_lattice_series`, and later on to</span>

<span class="sd">        `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="sd">    WARNING:</span>

<span class="sd">        Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="sd">        different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="sd">        (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="sd">        overlap.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-arguments</span>

    <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Getting Twiss table from MAD-X&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">()</span>

    <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

    <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

    <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">xlimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlimits</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Extracting element-specific dataframes&quot;</span><span class="p">)</span>

    <span class="n">element_dfs</span> <span class="o">=</span> <span class="n">_make_elements_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">)</span>

    <span class="n">dipoles_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;dipoles&quot;</span><span class="p">]</span>

    <span class="n">quadrupoles_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quadrupoles&quot;</span><span class="p">]</span>

    <span class="n">sextupoles_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="p">]</span>

    <span class="n">bpms_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;bpms&quot;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting machine layout&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting from axis &#39;</span><span class="si">{</span><span class="n">quadrupole_patches_axis</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$1/f=K_</span><span class="si">{1}</span><span class="s2">L$ $[m^{-1}]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>  <span class="c1"># quadrupole in red</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">k1l_lim</span><span class="p">)</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">twiss_df</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>  <span class="c1"># 0-level line</span>

    <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">dipole_patches_axis</span> <span class="o">=</span> <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

    <span class="n">dipole_patches_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta=K_</span><span class="si">{0}</span><span class="s2">L$ $[rad]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">)</span>  <span class="c1"># dipoles in blue</span>

    <span class="n">dipole_patches_axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">)</span>

    <span class="n">dipole_patches_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">k0l_lim</span><span class="p">)</span>

    <span class="n">dipole_patches_axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_dipoles</span><span class="p">:</span>  <span class="c1"># beware &#39;sbend&#39; and &#39;rbend&#39; have an &#39;angle&#39; value and not a &#39;k0l&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Plotting dipole patches&quot;</span><span class="p">)</span>

        <span class="n">plotted_elements</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># will help us not declare a label for legend at every patch</span>

        <span class="k">for</span> <span class="n">dipole_name</span><span class="p">,</span> <span class="n">dipole</span> <span class="ow">in</span> <span class="n">dipoles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting dipole element &#39;</span><span class="si">{</span><span class="n">dipole_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">bend_value</span> <span class="o">=</span> <span class="n">dipole</span><span class="o">.</span><span class="n">k0l</span> <span class="k">if</span> <span class="n">dipole</span><span class="o">.</span><span class="n">k0l</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dipole</span><span class="o">.</span><span class="kp">angle</span>

            <span class="n">_plot_lattice_series</span><span class="p">(</span>

                <span class="n">dipole_patches_axis</span><span class="p">,</span>

                <span class="n">dipole</span><span class="p">,</span>

                <span class="n">height</span><span class="o">=</span><span class="n">bend_value</span><span class="p">,</span>

                <span class="n">v_offset</span><span class="o">=</span><span class="n">bend_value</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>

                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MB&quot;</span> <span class="k">if</span> <span class="n">plotted_elements</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># avoid duplicating legend labels</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="k">if</span> <span class="n">dipole</span><span class="o">.</span><span class="n">k1l</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">plot_dipole_k1</span><span class="p">:</span>  <span class="c1"># plot dipole quadrupolar gradient (with reduced alpha)</span>

                <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting quadrupolar gradient of dipole element &#39;</span><span class="si">{</span><span class="n">dipole_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="n">_plot_lattice_series</span><span class="p">(</span>

                    <span class="n">quadrupole_patches_axis</span><span class="p">,</span>

                    <span class="n">dipole</span><span class="p">,</span>

                    <span class="n">height</span><span class="o">=</span><span class="n">dipole</span><span class="o">.</span><span class="n">k1l</span><span class="p">,</span>

                    <span class="n">v_offset</span><span class="o">=</span><span class="n">dipole</span><span class="o">.</span><span class="n">k1l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>

                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>

                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>

                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

                <span class="p">)</span>

            <span class="n">plotted_elements</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dipole_patches_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_quadrupoles</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Plotting quadrupole patches&quot;</span><span class="p">)</span>

        <span class="n">plotted_elements</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">quadrupole_name</span><span class="p">,</span> <span class="n">quadrupole</span> <span class="ow">in</span> <span class="n">quadrupoles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting quadrupole element &#39;</span><span class="si">{</span><span class="n">quadrupole_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">_plot_lattice_series</span><span class="p">(</span>

                <span class="n">quadrupole_patches_axis</span><span class="p">,</span>

                <span class="n">quadrupole</span><span class="p">,</span>

                <span class="n">height</span><span class="o">=</span><span class="n">quadrupole</span><span class="o">.</span><span class="n">k1l</span><span class="p">,</span>

                <span class="n">v_offset</span><span class="o">=</span><span class="n">quadrupole</span><span class="o">.</span><span class="n">k1l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>

                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MQ&quot;</span> <span class="k">if</span> <span class="n">plotted_elements</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># avoid duplicating legend labels</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">plotted_elements</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">k2l_lim</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Plotting sextupole patches&quot;</span><span class="p">)</span>

        <span class="n">sextupoles_patches_axis</span> <span class="o">=</span> <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$K_</span><span class="si">{2}</span><span class="s2">L$ $[m^{-2}]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkgoldenrod&quot;</span><span class="p">)</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;darkgoldenrod&quot;</span><span class="p">)</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">k2l_lim</span><span class="p">)</span>

        <span class="n">plotted_elements</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">sextupole_name</span><span class="p">,</span> <span class="n">sextupole</span> <span class="ow">in</span> <span class="n">sextupoles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting sextupole element &#39;</span><span class="si">{</span><span class="n">sextupole_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">_plot_lattice_series</span><span class="p">(</span>

                <span class="n">sextupoles_patches_axis</span><span class="p">,</span>

                <span class="n">sextupole</span><span class="p">,</span>

                <span class="n">height</span><span class="o">=</span><span class="n">sextupole</span><span class="o">.</span><span class="n">k2l</span><span class="p">,</span>

                <span class="n">v_offset</span><span class="o">=</span><span class="n">sextupole</span><span class="o">.</span><span class="n">k2l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>

                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;goldenrod&quot;</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span> <span class="k">if</span> <span class="n">plotted_elements</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># avoid duplicating legend labels</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">plotted_elements</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">sextupoles_patches_axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_bpms</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Plotting BPM patches&quot;</span><span class="p">)</span>

        <span class="n">bpm_patches_axis</span> <span class="o">=</span> <span class="n">quadrupole_patches_axis</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">bpm_patches_axis</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>  <span class="c1"># hide yticks, labels etc</span>

        <span class="n">bpm_patches_axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>

        <span class="n">plotted_elements</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">bpm_name</span><span class="p">,</span> <span class="n">bpm</span> <span class="ow">in</span> <span class="n">bpms_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting BPM element &#39;</span><span class="si">{</span><span class="n">bpm_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">_plot_lattice_series</span><span class="p">(</span>

                <span class="n">bpm_patches_axis</span><span class="p">,</span>

                <span class="n">bpm</span><span class="p">,</span>

                <span class="n">height</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>

                <span class="n">v_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>

                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;BPM&quot;</span> <span class="k">if</span> <span class="n">plotted_elements</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># avoid duplicating legend labels</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">plotted_elements</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">bpm_patches_axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">bpm_patches_axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># ----- Helpers ----- #</span>

<span class="k">def</span> <span class="nf">_make_elements_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Provided with an active `cpymad` instance after having ran a script, will returns different portions of</span>

<span class="sd">    the twiss table&#39;s dataframe for different magnetic elements.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">    Returns:</span>

<span class="sd">        A dictionary containing a dataframe for dipoles, focusing quadrupoles, defocusing</span>

<span class="sd">        quadrupoles, sextupoles and octupoles. The keys are self-explanatory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="kp">trace</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table from MAD-X&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">twiss</span><span class="p">()</span>

    <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">twiss</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting different element groups dframes from MAD-X twiss table&quot;</span><span class="p">)</span>

    <span class="c1"># Elements are detected by their keyword being either &#39;multipole&#39; or their specific element type,</span>

    <span class="c1"># and having a non-zero component (knl / knsl) in their given order (or &#39;angle&#39; for dipoles)</span>

    <span class="k">return</span> <span class="p">{</span>

        <span class="s2">&quot;dipoles&quot;</span><span class="p">:</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;multipole&quot;</span><span class="p">,</span> <span class="s2">&quot;rbend&quot;</span><span class="p">,</span> <span class="s2">&quot;sbend&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>

            <span class="s2">&quot;k0l != 0 or k0sl != 0 or angle != 0&quot;</span>

        <span class="p">),</span>

        <span class="s2">&quot;quadrupoles&quot;</span><span class="p">:</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;multipole&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrupole&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;k1l != 0 or k1sl != 0&quot;</span><span class="p">),</span>

        <span class="s2">&quot;sextupoles&quot;</span><span class="p">:</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;multipole&quot;</span><span class="p">,</span> <span class="s2">&quot;sextupole&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;k2l != 0 or k2sl &quot;</span> <span class="s2">&quot;!= 0&quot;</span><span class="p">),</span>

        <span class="s2">&quot;octupoles&quot;</span><span class="p">:</span> <span class="n">twiss_df</span><span class="p">[</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;multipole&quot;</span><span class="p">,</span> <span class="s2">&quot;octupole&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;k3l != 0 or k3sl != &quot;</span> <span class="s2">&quot;0&quot;</span><span class="p">),</span>

        <span class="s2">&quot;bpms&quot;</span><span class="p">:</span> <span class="n">twiss_df</span><span class="p">[(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;monitor&quot;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">twiss_df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;BPM&quot;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">))],</span>

    <span class="p">}</span>

<span class="k">def</span> <span class="nf">_make_survey_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">:</span> <span class="n">Madx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Provided with an active `cpymad` instance after having ran a script, will returns different portions of</span>

<span class="sd">    the survey table&#39;s dataframe for different magnetic elements.</span>

<span class="sd">    Args:</span>

<span class="sd">        madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="sd">    Returns:</span>

<span class="sd">        A dictionary containing a dataframe for dipoles, focusing quadrupoles, defocusing</span>

<span class="sd">        quadrupoles, sextupoles and octupoles. The keys are self-explanatory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">element_dfs</span> <span class="o">=</span> <span class="n">_make_elements_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">)</span>

    <span class="n">quadrupoles_focusing_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quadrupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;k1l &gt; 0&quot;</span><span class="p">)</span>

    <span class="n">quadrupoles_defocusing_df</span> <span class="o">=</span> <span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;quadrupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;k1l &lt; 0&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting different element groups dframes from MAD-X survey&quot;</span><span class="p">)</span>

    <span class="n">madx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">survey</span><span class="p">()</span>

    <span class="n">survey_df</span> <span class="o">=</span> <span class="n">madx</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">dframe</span><span class="p">()</span><span class="o">.</span><span class="kp">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>

        <span class="s2">&quot;dipoles&quot;</span><span class="p">:</span> <span class="n">survey_df</span><span class="p">[</span><span class="n">survey_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;dipoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="kp">tolist</span><span class="p">())],</span>

        <span class="s2">&quot;quad_foc&quot;</span><span class="p">:</span> <span class="n">survey_df</span><span class="p">[</span><span class="n">survey_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">quadrupoles_focusing_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="kp">tolist</span><span class="p">())],</span>

        <span class="s2">&quot;quad_defoc&quot;</span><span class="p">:</span> <span class="n">survey_df</span><span class="p">[</span><span class="n">survey_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">quadrupoles_defocusing_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="kp">tolist</span><span class="p">())],</span>

        <span class="s2">&quot;sextupoles&quot;</span><span class="p">:</span> <span class="n">survey_df</span><span class="p">[</span><span class="n">survey_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="kp">tolist</span><span class="p">())],</span>

        <span class="s2">&quot;octupoles&quot;</span><span class="p">:</span> <span class="n">survey_df</span><span class="p">[</span><span class="n">survey_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">element_dfs</span><span class="p">[</span><span class="s2">&quot;octupoles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="kp">tolist</span><span class="p">())],</span>

    <span class="p">}</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="highlight"><pre><span></span><code><span class="n">BY_HSV</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">COLORS_DICT</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">PLOT_PARAMS</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">SORTED_COLORS</span>
</code></pre></div>
<h2 id="classes">Classes</h2>
<h3 id="apertureplotter">AperturePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AperturePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">class</span> <span class="n">AperturePlotter</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A class to plot the aperture of your machine as determined by `MAD-X`&#39;s `APERTURE` command.</span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_aperture</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">aperture_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">color</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active `cpymad` instance after having ran a script, will create a plot representing</span>

<span class="s2">        nicely the lattice layout and the aperture tolerance across the machine. Beware: this function</span>

<span class="s2">        assumes the user has previously made a call to the `APERTURE` command in `MAD-X`.</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            title (str): title of your plot.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 1).</span>

<span class="s2">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="s2">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="s2">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="s2">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="s2">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="s2">                not None, using the tuple passed.</span>

<span class="s2">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="s2">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="s2">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="s2">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="s2">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="s2">            aperture_ylim (Tuple[float, float]): vertical axis limits for the aperture values. Defaults to</span>

<span class="s2">                `None`, to be determined by matplotlib based on the provided values.</span>

<span class="s2">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="s2">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="s2">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="s2">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="s2">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="s2">                height of sextupole patches.</span>

<span class="s2">            color (str): the color argument given to the aperture lines. Defaults to `None`, and should be</span>

<span class="s2">                the first color in your `rcParams`&#39;s cycler.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="s2">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="s2">        WARNING:</span>

<span class="s2">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="s2">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="s2">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="s2">            overlap.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="s2">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting aperture limits and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df</span><span class="o">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict</span><span class="p">(</span><span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">aperture</span><span class="p">))</span>  <span class="c1"># slicing -&gt; issues with .dframe()</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="err">[</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="err">[</span><span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">aperture_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting aperture values on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting aperture values&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Aperture Limits&quot;</span>

        <span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="n">interpolate</span><span class="o">=</span><span class="no">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">legend</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$n_{1} </span><span class="err">\</span><span class="s2"> [</span><span class="err">\</span><span class="s2">sigma]$&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$S </span><span class="err">\</span><span class="s2"> [m]$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">aperture_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for aperture plot&quot;</span><span class="p">)</span>

            <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">aperture_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving latwiss plot as {savefig}&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods">Static methods</h4>
<h4 id="plot_aperture">plot_aperture</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_aperture</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">xoffset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_dipoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_quadrupoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_bpms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">aperture_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">k0l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
    <span class="n">k1l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>
    <span class="n">k2l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Provided with an active <code>cpymad</code> instance after having ran a script, will create a plot representing
nicely the lattice layout and the aperture tolerance across the machine. Beware: this function
assumes the user has previously made a call to the <code>APERTURE</code> command in <code>MAD-X</code>.</p>
<p>Args:
    madx (cpymad.madx.Madx): an instanciated cpymad Madx object.
    title (str): title of your plot.
    figsize (Tuple[int, int]): size of the figure, defaults to (18, 1).
    savefig (str): will save the figure if this is not None, using the string value passed.
    xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want
        to center a plot around a specific point or element, which would then become located at s = 0.
        Beware this offset is applied before applying the <code>xlimits</code>. Offset defaults to 0 (no change).
    xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is
        not None, using the tuple passed.
    plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of
        the figure. Defaults to True. Dipoles are plotted in blue.
    plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout
        subplot of the figure. Defaults to True. Quadrupoles are plotted in red.
    plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent
        Beam Position Monitors. BPMs are plotted in dark grey.
    aperture_ylim (Tuple[float, float]): vertical axis limits for the aperture values. Defaults to
        <code>None</code>, to be determined by matplotlib based on the provided values.
    k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the
        height of dipole patches. Defaults to (-0.25, 0.25).
    k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the
        height of quadrupole patches. Defaults to (-0.08, 0.08).
    k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of
        the figure, and the provided values act as vertical axis limits for the k2l values used for the
        height of sextupole patches.
    color (str): the color argument given to the aperture lines. Defaults to <code>None</code>, and should be
        the first color in your <code>rcParams</code>'s cycler.</p>
<p>Keyword Args:
    Any keyword argument to be transmitted to <code>_plot_machine_layout</code>, later on to <code>plot_lattice_series</code>
    and then <code>matplotlib.patches.Rectangle</code>, such as lw etc.</p>
<p>WARNING:
    Currently the function tries to plot legends for the different layout patches. The position of the
    different legends has been hardcoded in corners and might require users to tweak the axis limits
    (through <code>k0l_lim</code>, <code>k1l_lim</code> and <code>k2l_lim</code>) to ensure legend labels and plotted elements don't
    overlap.</p>
<p>Returns:
     The figure on which the plots are drawn. The underlying axes can be accessed with
     'fig.get_axes()'. Eventually saves the figure as a file.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_aperture</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">aperture_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">color</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active `cpymad` instance after having ran a script, will create a plot representing</span>

<span class="s2">        nicely the lattice layout and the aperture tolerance across the machine. Beware: this function</span>

<span class="s2">        assumes the user has previously made a call to the `APERTURE` command in `MAD-X`.</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            title (str): title of your plot.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 1).</span>

<span class="s2">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="s2">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="s2">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="s2">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="s2">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="s2">                not None, using the tuple passed.</span>

<span class="s2">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="s2">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="s2">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="s2">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="s2">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="s2">            aperture_ylim (Tuple[float, float]): vertical axis limits for the aperture values. Defaults to</span>

<span class="s2">                `None`, to be determined by matplotlib based on the provided values.</span>

<span class="s2">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="s2">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="s2">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="s2">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="s2">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="s2">                height of sextupole patches.</span>

<span class="s2">            color (str): the color argument given to the aperture lines. Defaults to `None`, and should be</span>

<span class="s2">                the first color in your `rcParams`&#39;s cycler.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="s2">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="s2">        WARNING:</span>

<span class="s2">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="s2">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="s2">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="s2">            overlap.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="s2">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting aperture limits and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df</span><span class="o">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict</span><span class="p">(</span><span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">aperture</span><span class="p">))</span>  <span class="c1"># slicing -&gt; issues with .dframe()</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="err">[</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="n">aperture_df</span> <span class="o">=</span> <span class="n">aperture_df</span><span class="err">[</span><span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">aperture_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting aperture values on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting aperture values&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Aperture Limits&quot;</span>

        <span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">aperture_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">aperture_df</span><span class="p">.</span><span class="n">n1</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="n">interpolate</span><span class="o">=</span><span class="no">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="n">legend</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$n_{1} </span><span class="err">\</span><span class="s2"> [</span><span class="err">\</span><span class="s2">sigma]$&quot;</span><span class="p">)</span>

        <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$S </span><span class="err">\</span><span class="s2"> [m]$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">aperture_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for aperture plot&quot;</span><span class="p">)</span>

            <span class="n">aperture_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">aperture_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving latwiss plot as {savefig}&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<h3 id="beamenvelopeplotter">BeamEnvelopePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BeamEnvelopePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">BeamEnvelopePlotter</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;A class to plot the estimated beam envelope of your machine.&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_envelope</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">beam_params</span><span class="p">:</span><span class="w"> </span><span class="n">BeamParameters</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">figsize</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">xlimits</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">hplane_ylim</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">vplane_ylim</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Provided with an active `cpymad` instance after having ran a script, plots an estimation of the beam</span>

<span class="ss">        stay-clear enveloppe in your machine, as well as an estimation of the aperture limits.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            beam_params (BeamParameters): a validated BeamParameters object from</span>

<span class="ss">                `pyhdtoolkit.optics.beam.compute_beam_parameters`.</span>

<span class="ss">            figsize (Tuple[int, int]): size of the figure, defaults to (13, 20).</span>

<span class="ss">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="ss">                not None, using the tuple passed.</span>

<span class="ss">            hplane_ylim (Tuple[float, float]): the y limits for the horizontal plane plot (so</span>

<span class="ss">                that machine geometry doesn&#39;t make the  plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="ss">            vplane_ylim (Tuple[float, float]): the y limits for the vertical plane plot (so that</span>

<span class="ss">                machine geometry doesn&#39;t make the plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">pylint</span><span class="p">:</span><span class="w"> </span><span class="n">disable</span><span class="o">=</span><span class="n">too</span><span class="o">-</span><span class="n">many</span><span class="o">-</span><span class="n">arguments</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="n">along</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">direction</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting estimated machine aperture and beam envelope&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Running interpolation in MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;drift&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;quadrupole&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;sbend&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;rbend&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Getting Twiss dframe from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="nl">twiss_hr</span><span class="p">:</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;betatronic_envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">eg_y_m</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;betatronic_envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">bety</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">eg_y_m</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;dispersive_envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;dispersive_envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betatronic_envelope_x</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="p">)</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betatronic_envelope_y</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="p">)</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">twiss_hr.apertype == &quot;ellipse&quot;</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the horizontal aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">hplane_ylim</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$X \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Horizontal aperture at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the vertical aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">vplane_ylim</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$Y \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Vertical aperture at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the stay-clear envelope&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;.-b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;Horizontal plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;.-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;Vertical plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="ss">&quot;$n1$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="ss">&quot;best&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Stay-clear envelope at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving aperture plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods_1">Static methods</h4>
<h4 id="plot_envelope">plot_envelope</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_envelope</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">beam_params</span><span class="p">:</span> <span class="n">pyhdtoolkit</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">BeamParameters</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hplane_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>
    <span class="n">vplane_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Provided with an active <code>cpymad</code> instance after having ran a script, plots an estimation of the beam</p>
<p>stay-clear enveloppe in your machine, as well as an estimation of the aperture limits.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>beam_params</td>
<td>BeamParameters</td>
<td>a validated BeamParameters object from</td>
<td></td>
</tr>
<tr>
<td><code>pyhdtoolkit.optics.beam.compute_beam_parameters</code>.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>figsize</td>
<td>Tuple[int, int]</td>
<td>size of the figure, defaults to (13, 20).</td>
<td>None</td>
</tr>
<tr>
<td>xlimits</td>
<td>Tuple[float, float]</td>
<td>will implement xlim (for the s coordinate) if this is</td>
<td></td>
</tr>
<tr>
<td>not None, using the tuple passed.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>hplane_ylim</td>
<td>Tuple[float, float]</td>
<td>the y limits for the horizontal plane plot (so</td>
<td></td>
</tr>
<tr>
<td>that machine geometry doesn't make the  plot look shrinked). Defaults to (-0.12, 0.12).</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>vplane_ylim</td>
<td>Tuple[float, float]</td>
<td>the y limits for the vertical plane plot (so that</td>
<td></td>
</tr>
<tr>
<td>machine geometry doesn't make the plot look shrinked). Defaults to (-0.12, 0.12).</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>savefig</td>
<td>str</td>
<td>will save the figure if this is not None, using the string value passed.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The figure on which the plots are drawn. The underlying axes can be accessed with</td>
</tr>
<tr>
<td>'fig.get_axes()'. Eventually saves the figure as a file.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_envelope</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">beam_params</span><span class="p">:</span><span class="w"> </span><span class="n">BeamParameters</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">figsize</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">xlimits</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">hplane_ylim</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">vplane_ylim</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">float, float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Provided with an active `cpymad` instance after having ran a script, plots an estimation of the beam</span>

<span class="ss">        stay-clear enveloppe in your machine, as well as an estimation of the aperture limits.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            beam_params (BeamParameters): a validated BeamParameters object from</span>

<span class="ss">                `pyhdtoolkit.optics.beam.compute_beam_parameters`.</span>

<span class="ss">            figsize (Tuple[int, int]): size of the figure, defaults to (13, 20).</span>

<span class="ss">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="ss">                not None, using the tuple passed.</span>

<span class="ss">            hplane_ylim (Tuple[float, float]): the y limits for the horizontal plane plot (so</span>

<span class="ss">                that machine geometry doesn&#39;t make the  plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="ss">            vplane_ylim (Tuple[float, float]): the y limits for the vertical plane plot (so that</span>

<span class="ss">                machine geometry doesn&#39;t make the plot look shrinked). Defaults to (-0.12, 0.12).</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nl">pylint</span><span class="p">:</span><span class="w"> </span><span class="n">disable</span><span class="o">=</span><span class="n">too</span><span class="o">-</span><span class="n">many</span><span class="o">-</span><span class="n">arguments</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="n">along</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">direction</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting estimated machine aperture and beam envelope&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Running interpolation in MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;drift&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;quadrupole&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;sbend&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="ss">&quot;interpolate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="o">=</span><span class="ss">&quot;rbend&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">slice_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">range_</span><span class="o">=</span><span class="ss">&quot;#s/#e&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Getting Twiss dframe from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="nl">twiss_hr</span><span class="p">:</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;betatronic_envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">eg_y_m</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;betatronic_envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">bety</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">eg_y_m</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;dispersive_envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;dispersive_envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;envelope_x&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betatronic_envelope_x</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="p">)</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">&quot;envelope_y&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">betatronic_envelope_y</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">beam_params</span><span class="p">.</span><span class="n">deltap_p</span><span class="p">)</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="w">        </span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twiss_hr</span><span class="o">[</span><span class="n">twiss_hr.apertype == &quot;ellipse&quot;</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the horizontal aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">hplane_ylim</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$X \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis1</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Horizontal aperture at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the vertical aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">twiss_hr</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;k.-&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">vplane_ylim</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$Y \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis2</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Vertical aperture at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting the stay-clear envelope&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sharex</span><span class="o">=</span><span class="n">axis1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">envelope_x</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;.-b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;Horizontal plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">aper_2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="n">envelope_y</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;.-r&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;Vertical plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="ss">&quot;$n1$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="ss">&quot;best&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">axis3</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Stay-clear envelope at {beam_params.pc_GeV} GeV/c&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving aperture plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="crossingschemeplotter">CrossingSchemePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossingSchemePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">class</span> <span class="n">CrossingSchemePlotter</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A class to plot LHC crossing schemes at provided IPs.</span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span>

        <span class="n">axis</span><span class="o">:</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">:</span> <span class="k">Union</span><span class="err">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">tfs</span><span class="p">.</span><span class="n">TfsDataFrame</span><span class="err">]</span><span class="p">,</span> <span class="n">ip</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Plot colored pacthes highlighting zones with MBX and MQX elements in a twin of the given axis.</span>

<span class="s2">        Assumes that the plot_df s already centered at 0 on the IP point!</span>

<span class="s2">        Args:</span>

<span class="s2">            axis (matplotlib.axes.Axes): the axis to twin and then on which to add patches.</span>

<span class="s2">            plot_df (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone, centered on 0</span>

<span class="s2">                at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="s2">            ip (int): the IP number of the given IR.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument is given to the `axis.axvspan` method called for each patch.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">left_ir</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">.</span><span class="k">query</span><span class="p">(</span><span class="s2">&quot;s &lt; 0&quot;</span><span class="p">)</span>  <span class="c1"># no need to copy, we don&#39;t touch data</span>

        <span class="n">right_ir</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">.</span><span class="k">query</span><span class="p">(</span><span class="s2">&quot;s &gt; 0&quot;</span><span class="p">)</span>  <span class="c1"># no need to copy, we don&#39;t touch data</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Determining MBX areas left and right of IP&quot;</span><span class="p">)</span>

        <span class="n">left_mbx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">left_ir</span><span class="err">[</span><span class="n">left_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>

            <span class="n">left_ir</span><span class="err">[</span><span class="n">left_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">right_mbx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">right_ir</span><span class="err">[</span><span class="n">right_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>

            <span class="n">right_ir</span><span class="err">[</span><span class="n">right_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mbx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Determining MQX areas left and right of IP&quot;</span><span class="p">)</span>

        <span class="n">left_mqx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">left_ir</span><span class="err">[</span><span class="n">left_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>

            <span class="n">left_ir</span><span class="err">[</span><span class="n">left_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">right_mqx_lim</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">right_ir</span><span class="err">[</span><span class="n">right_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>

            <span class="n">right_ir</span><span class="err">[</span><span class="n">right_ir</span><span class="p">.</span><span class="k">name</span><span class="p">.</span><span class="n">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="s2">&quot;mqx&quot;</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Highlighting MBX and MQX areas on a twin axis&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">get_yaxis</span><span class="p">().</span><span class="k">set</span><span class="n">_visible</span><span class="p">(</span><span class="no">False</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">left_mbx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MBX&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">left_mqx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MQX&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;IP{ip}&quot;</span><span class="p">)</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">right_mqx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># no label duplication</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">right_mbx_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># no label duplication</span>

        <span class="n">patches_axis</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

        <span class="n">axis</span><span class="o">:</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">Axes</span><span class="p">,</span>

        <span class="n">plot_df_b1</span><span class="o">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span>

        <span class="n">plot_df_b2</span><span class="o">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">,</span>

        <span class="n">plot_column</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span>

        <span class="n">scaling</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="n">ylabel</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">xlabel</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Plot the X or Y orbit for the IR on the given axis. Assumes that the plot_df_b1 and plot_df_b2</span>

<span class="s2">        are already centered at 0 on the IP point!</span>

<span class="s2">        Args:</span>

<span class="s2">            axis (matplotlib.axes.Axes): the axis on which to plot.</span>

<span class="s2">            plot_df_b1 (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone for beam 1</span>

<span class="s2">            of the LHC, centered on 0 at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="s2">            plot_df_b2 (Union[pd.DataFrame, tfs.TfsDataFrame]): TWISS dataframe of the IR zone for beam 2</span>

<span class="s2">            of the LHC, centered on 0 at IP position (simply done with `df.s = df.s - ip_s`).</span>

<span class="s2">            plot_column (str): which column (should be `x` or `y`) to plot for the orbit.</span>

<span class="s2">            scaling (float): scaling factor to apply to the plotted data. Defaults to 1 (no change of data).</span>

<span class="s2">            xlabel (str): if given, will be used for the `xlabel` of the axis. Defaults to `None`.</span>

<span class="s2">            ylabel (str): if given, will be used for the `ylabel` of the axis. Defaults to `None`.</span>

<span class="s2">            title (str): if given, will be used for the `title` of the axis. Defaults to `None`.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting orbit &#39;{plot_column}&#39;&quot;</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">plot_df_b1</span><span class="p">.</span><span class="n">s</span><span class="p">,</span>

            <span class="n">plot_df_b1</span><span class="err">[</span><span class="n">plot_column</span><span class="err">]</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span>

            <span class="s2">&quot;bo&quot;</span><span class="p">,</span>

            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>

            <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>

            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>

            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Beam 1&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>

            <span class="n">plot_df_b2</span><span class="p">.</span><span class="n">s</span><span class="p">,</span>

            <span class="n">plot_df_b2</span><span class="err">[</span><span class="n">plot_column</span><span class="err">]</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">,</span>

            <span class="s2">&quot;ro&quot;</span><span class="p">,</span>

            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>

            <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>

            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>

            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Beam 2&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_two_lhc_ips_crossings</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">first_ip</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>

        <span class="n">second_ip</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="n">ir_limit</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">275</span><span class="p">,</span>

        <span class="n">highlight_mqx_and_mbx</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active `cpymad.madx.Madx` instance after having ran a script, will create a plot</span>

<span class="s2">        representing nicely the crossing schemes at two provided IPs. This assumes the appropriate LHC</span>

<span class="s2">        sequence and opticsfile have been loaded, and both `lhcb1` and `lhcb2` beams are defined. It is</span>

<span class="s2">        very recommended to re-cycle the sequences from a point which is not an IP</span>

<span class="s2">        WARNING: This function will get TWISS tables for both beams, which means it will `USE` both the</span>

<span class="s2">        `lhcb1` and `lhcb2` sequences, erasing previously defined errors or orbit corrections. The second</span>

<span class="s2">        sequence `USE` will be called on is `lhcb2`, which may not be the one you were using before. Please</span>

<span class="s2">        re-`use` your wanted sequence after calling this function!</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            first_ip (int): the first of the two IPs to plot crossing schemes for.</span>

<span class="s2">            second_ip (int): the second of the two IPs to plot crossing schemes for.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 12).</span>

<span class="s2">            ir_limit (float): the amount of meters to keep left and right of the IP point. Will also</span>

<span class="s2">                determine the xlimits of the plots. Defaults to 275.</span>

<span class="s2">            highlight_mqx_and_mbx (bool): if `True`, will add patches highlighting the zones corresponding</span>

<span class="s2">                to MBX and MQX elements. Defaults to `True`.</span>

<span class="s2">            savefig (str): will save the figure if this is not `None`, using the string value passed.</span>

<span class="s2">                Defaults to `None`.</span>

<span class="s2">        Returns:</span>

<span class="s2">            The figure on which the crossing schemes are drawn. One crossing scheme is plotted per IP and</span>

<span class="s2">            per plane (orbit X and orbit Y). The underlying axes can be accessed with &#39;fig.get_axes()&#39;.</span>

<span class="s2">            Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-call the &#39;USE&#39; command on your wanted sequence after this!&quot;</span><span class="p">)</span>

        <span class="c1"># ----- Getting Twiss table dframe for each beam ----- #</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df_b1</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df_b2</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Determining exact locations of IP points&quot;</span><span class="p">)</span>

        <span class="n">first_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="err">[</span><span class="n">f</span><span class="s2">&quot;ip{first_ip}&quot;</span><span class="err">]</span>

        <span class="n">second_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="err">[</span><span class="n">f</span><span class="s2">&quot;ip{second_ip}&quot;</span><span class="err">]</span>

        <span class="c1"># ----- Plotting figure ----- #</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting crossing schemes for IP{first_ip} and IP{second_ip}&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting for IP{first_ip}&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="err">[</span><span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="err">[</span><span class="n">twiss_df_b2</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit X $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;IP{first_ip} Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit Y $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Distance to IP{first_ip} $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting for IP{second_ip}&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="err">[</span><span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="err">[</span><span class="n">twiss_df_b2</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;IP{second_ip} Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Distance to IP{second_ip} $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="k">if</span> <span class="n">highlight_mqx_and_mbx</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Highlighting MQX and MBX areas near IPs&quot;</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving crossing schemes for IP{first_ip} and IP{second_ip} plot as &#39;{savefig}&#39;&quot;</span><span class="p">)</span>

            <span class="n">figure</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods_2">Static methods</h4>
<h4 id="plot_two_lhc_ips_crossings">plot_two_lhc_ips_crossings</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_two_lhc_ips_crossings</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">first_ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">second_ip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="n">ir_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">275</span><span class="p">,</span>
    <span class="n">highlight_mqx_and_mbx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Provided with an active <code>cpymad.madx.Madx</code> instance after having ran a script, will create a plot</p>
<p>representing nicely the crossing schemes at two provided IPs. This assumes the appropriate LHC
sequence and opticsfile have been loaded, and both <code>lhcb1</code> and <code>lhcb2</code> beams are defined. It is
very recommended to re-cycle the sequences from a point which is not an IP</p>
<p>WARNING: This function will get TWISS tables for both beams, which means it will <code>USE</code> both the
<code>lhcb1</code> and <code>lhcb2</code> sequences, erasing previously defined errors or orbit corrections. The second
sequence <code>USE</code> will be called on is <code>lhcb2</code>, which may not be the one you were using before. Please
re-<code>use</code> your wanted sequence after calling this function!</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>first_ip</td>
<td>int</td>
<td>the first of the two IPs to plot crossing schemes for.</td>
<td>None</td>
</tr>
<tr>
<td>second_ip</td>
<td>int</td>
<td>the second of the two IPs to plot crossing schemes for.</td>
<td>None</td>
</tr>
<tr>
<td>figsize</td>
<td>Tuple[int, int]</td>
<td>size of the figure, defaults to (18, 12).</td>
<td>None</td>
</tr>
<tr>
<td>ir_limit</td>
<td>float</td>
<td>the amount of meters to keep left and right of the IP point. Will also</td>
<td></td>
</tr>
<tr>
<td>determine the xlimits of the plots. Defaults to 275.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>highlight_mqx_and_mbx</td>
<td>bool</td>
<td>if <code>True</code>, will add patches highlighting the zones corresponding</td>
<td></td>
</tr>
<tr>
<td>to MBX and MQX elements. Defaults to <code>True</code>.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>savefig</td>
<td>str</td>
<td>will save the figure if this is not <code>None</code>, using the string value passed.</td>
<td></td>
</tr>
<tr>
<td>Defaults to <code>None</code>.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The figure on which the crossing schemes are drawn. One crossing scheme is plotted per IP and</td>
</tr>
<tr>
<td>per plane (orbit X and orbit Y). The underlying axes can be accessed with 'fig.get_axes()'.</td>
<td></td>
</tr>
<tr>
<td>Eventually saves the figure as a file.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_two_lhc_ips_crossings</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">first_ip</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>

        <span class="n">second_ip</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="n">ir_limit</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">275</span><span class="p">,</span>

        <span class="n">highlight_mqx_and_mbx</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active `cpymad.madx.Madx` instance after having ran a script, will create a plot</span>

<span class="s2">        representing nicely the crossing schemes at two provided IPs. This assumes the appropriate LHC</span>

<span class="s2">        sequence and opticsfile have been loaded, and both `lhcb1` and `lhcb2` beams are defined. It is</span>

<span class="s2">        very recommended to re-cycle the sequences from a point which is not an IP</span>

<span class="s2">        WARNING: This function will get TWISS tables for both beams, which means it will `USE` both the</span>

<span class="s2">        `lhcb1` and `lhcb2` sequences, erasing previously defined errors or orbit corrections. The second</span>

<span class="s2">        sequence `USE` will be called on is `lhcb2`, which may not be the one you were using before. Please</span>

<span class="s2">        re-`use` your wanted sequence after calling this function!</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            first_ip (int): the first of the two IPs to plot crossing schemes for.</span>

<span class="s2">            second_ip (int): the second of the two IPs to plot crossing schemes for.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 12).</span>

<span class="s2">            ir_limit (float): the amount of meters to keep left and right of the IP point. Will also</span>

<span class="s2">                determine the xlimits of the plots. Defaults to 275.</span>

<span class="s2">            highlight_mqx_and_mbx (bool): if `True`, will add patches highlighting the zones corresponding</span>

<span class="s2">                to MBX and MQX elements. Defaults to `True`.</span>

<span class="s2">            savefig (str): will save the figure if this is not `None`, using the string value passed.</span>

<span class="s2">                Defaults to `None`.</span>

<span class="s2">        Returns:</span>

<span class="s2">            The figure on which the crossing schemes are drawn. One crossing scheme is plotted per IP and</span>

<span class="s2">            per plane (orbit X and orbit Y). The underlying axes can be accessed with &#39;fig.get_axes()&#39;.</span>

<span class="s2">            Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You should re-call the &#39;USE&#39; command on your wanted sequence after this!&quot;</span><span class="p">)</span>

        <span class="c1"># ----- Getting Twiss table dframe for each beam ----- #</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb1&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df_b1</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting TWISS table for LHCB2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="k">use</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="s2">&quot;lhcb2&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="no">True</span><span class="p">)</span>

        <span class="n">twiss_df_b2</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Determining exact locations of IP points&quot;</span><span class="p">)</span>

        <span class="n">first_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="err">[</span><span class="n">f</span><span class="s2">&quot;ip{first_ip}&quot;</span><span class="err">]</span>

        <span class="n">second_ip_s</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="err">[</span><span class="n">f</span><span class="s2">&quot;ip{second_ip}&quot;</span><span class="err">]</span>

        <span class="c1"># ----- Plotting figure ----- #</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting crossing schemes for IP{first_ip} and IP{second_ip}&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting for IP{first_ip}&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="err">[</span><span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="err">[</span><span class="n">twiss_df_b2</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">first_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">first_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">first_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit X $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;IP{first_ip} Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Orbit Y $[mm]$&quot;</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Distance to IP{first_ip} $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting for IP{second_ip}&quot;</span><span class="p">)</span>

        <span class="n">b1_plot</span> <span class="o">=</span> <span class="n">twiss_df_b1</span><span class="err">[</span><span class="n">twiss_df_b1</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b2_plot</span> <span class="o">=</span> <span class="n">twiss_df_b2</span><span class="err">[</span><span class="n">twiss_df_b2</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="n">second_ip_s</span> <span class="o">-</span> <span class="n">ir_limit</span><span class="p">,</span> <span class="n">second_ip_s</span> <span class="o">+</span> <span class="n">ir_limit</span><span class="p">)</span><span class="err">]</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b1_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">b2_plot</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">second_ip_s</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;IP{second_ip} Crossing Schemes&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_plot_crossing_in_ir</span><span class="p">(</span>

            <span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span>

            <span class="n">b1_plot</span><span class="p">,</span>

            <span class="n">b2_plot</span><span class="p">,</span>

            <span class="n">plot_column</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>

            <span class="n">scaling</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>

            <span class="n">xlabel</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Distance to IP{second_ip} $[m]$&quot;</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="k">if</span> <span class="n">highlight_mqx_and_mbx</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Highlighting MQX and MBX areas near IPs&quot;</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">0</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">first_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">0</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

            <span class="n">CrossingSchemePlotter</span><span class="p">.</span><span class="n">_highlight_mbx_and_mqx</span><span class="p">(</span><span class="n">axes</span><span class="err">[</span><span class="mi">1</span><span class="err">][</span><span class="mi">1</span><span class="err">]</span><span class="p">,</span> <span class="n">plot_df</span><span class="o">=</span><span class="n">b1_plot</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">second_ip</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving crossing schemes for IP{first_ip} and IP{second_ip} plot as &#39;{savefig}&#39;&quot;</span><span class="p">)</span>

            <span class="n">figure</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<h3 id="dynamicapertureplotter">DynamicAperturePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicAperturePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">DynamicAperturePlotter</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;This is currently badly named, and will change in the future.&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_dynamic_aperture</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">x_coords</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">y_coords</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">n_particles</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="p">,</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots a visual aid for the dynamic aperture after a tracking. Initial amplitudes are on the</span>

<span class="ss">        vertical axis, and the turn at which they were lost is in the horizontal axis.</span>

<span class="ss">        Args:</span>

<span class="ss">            x_coords (np.ndarray): numpy array of horizontal coordinates over turns.</span>

<span class="ss">            y_coords (np.ndarray): numpy array of vertical coordinates over turns.</span>

<span class="ss">            n_particles (int): number of particles simulated.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting the &#39;{len(x_coords)} turns&#39; aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="n">turn_lost_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">amp_lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Determining turns at which particles have been lost&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">amp_lost</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_coords</span><span class="o">[</span><span class="n">particle</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y_coords</span><span class="o">[</span><span class="n">particle</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">amplitude</span><span class="w"></span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">coordinates</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="err">`</span><span class="n">nan</span><span class="err">`</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t come back, particle is lost</span>

<span class="s1">            turn_lost_at.append(</span>

<span class="s1">                min(</span>

<span class="s1">                    pd.Series(x_coords[particle]).last_valid_index() + 2,  # starts at 0, lost after last valid</span>

<span class="s1">                    pd.Series(y_coords[particle]).last_valid_index() + 2,  # starts at 0, lost after last valid</span>

<span class="s1">                )</span>

<span class="s1">            )</span>

<span class="s1">        turn_lost_at = np.array(turn_lost_at)</span>

<span class="s1">        amp_lost = np.array(amp_lost)</span>

<span class="s1">        plt.scatter(turn_lost_at, amp_lost * 1000, linewidths=0.7, c=&quot;darkblue&quot;, marker=&quot;.&quot;)</span>

<span class="s1">        plt.title(&quot;Amplitudes lost over turns&quot;)</span>

<span class="s1">        plt.xlabel(&quot;Number of Turns Survived&quot;)</span>

<span class="s1">        plt.ylabel(&quot;Initial amplitude $[mm]$&quot;)</span>

<span class="s1">        if savefig:</span>

<span class="s1">            logger.info(f&quot;Saving dynamic aperture plot at &#39;</span><span class="err">{</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">).</span><span class="k">absolute</span><span class="p">()</span><span class="err">}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods_3">Static methods</h4>
<h4 id="plot_dynamic_aperture">plot_dynamic_aperture</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_dynamic_aperture</span><span class="p">(</span>
    <span class="n">x_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_coords</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">n_particles</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Plots a visual aid for the dynamic aperture after a tracking. Initial amplitudes are on the</p>
<p>vertical axis, and the turn at which they were lost is in the horizontal axis.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>x_coords</td>
<td>np.ndarray</td>
<td>numpy array of horizontal coordinates over turns.</td>
<td>None</td>
</tr>
<tr>
<td>y_coords</td>
<td>np.ndarray</td>
<td>numpy array of vertical coordinates over turns.</td>
<td>None</td>
</tr>
<tr>
<td>n_particles</td>
<td>int</td>
<td>number of particles simulated.</td>
<td>None</td>
</tr>
<tr>
<td>savefig</td>
<td>str</td>
<td>will save the figure if this is not None, using the string value passed.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The figure on which the plots are drawn. The underlying axes can be accessed with</td>
</tr>
<tr>
<td>'fig.get_axes()'. Eventually saves the figure as a file.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_dynamic_aperture</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">x_coords</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">y_coords</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">n_particles</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="p">,</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots a visual aid for the dynamic aperture after a tracking. Initial amplitudes are on the</span>

<span class="ss">        vertical axis, and the turn at which they were lost is in the horizontal axis.</span>

<span class="ss">        Args:</span>

<span class="ss">            x_coords (np.ndarray): numpy array of horizontal coordinates over turns.</span>

<span class="ss">            y_coords (np.ndarray): numpy array of vertical coordinates over turns.</span>

<span class="ss">            n_particles (int): number of particles simulated.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting the &#39;{len(x_coords)} turns&#39; aperture&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="n">turn_lost_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">amp_lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Determining turns at which particles have been lost&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">amp_lost</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_coords</span><span class="o">[</span><span class="n">particle</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y_coords</span><span class="o">[</span><span class="n">particle</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">amplitude</span><span class="w"></span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">coordinates</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="err">`</span><span class="n">nan</span><span class="err">`</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t come back, particle is lost</span>

<span class="s1">            turn_lost_at.append(</span>

<span class="s1">                min(</span>

<span class="s1">                    pd.Series(x_coords[particle]).last_valid_index() + 2,  # starts at 0, lost after last valid</span>

<span class="s1">                    pd.Series(y_coords[particle]).last_valid_index() + 2,  # starts at 0, lost after last valid</span>

<span class="s1">                )</span>

<span class="s1">            )</span>

<span class="s1">        turn_lost_at = np.array(turn_lost_at)</span>

<span class="s1">        amp_lost = np.array(amp_lost)</span>

<span class="s1">        plt.scatter(turn_lost_at, amp_lost * 1000, linewidths=0.7, c=&quot;darkblue&quot;, marker=&quot;.&quot;)</span>

<span class="s1">        plt.title(&quot;Amplitudes lost over turns&quot;)</span>

<span class="s1">        plt.xlabel(&quot;Number of Turns Survived&quot;)</span>

<span class="s1">        plt.ylabel(&quot;Initial amplitude $[mm]$&quot;)</span>

<span class="s1">        if savefig:</span>

<span class="s1">            logger.info(f&quot;Saving dynamic aperture plot at &#39;</span><span class="err">{</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">).</span><span class="k">absolute</span><span class="p">()</span><span class="err">}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="latticeplotter">LatticePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LatticePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">class</span> <span class="n">LatticePlotter</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">    A class to elegantly plot the Twiss parameters layout of a machine from a `cpymad.madx.Madx` instance</span>

<span class="s2">    after it has ran, or the machine survey.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_latwiss</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_dipole_k1</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">disp_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">125</span><span class="p">),</span>

        <span class="n">beta_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active Cpymad class after having ran a script, will create a plot representing nicely</span>

<span class="s2">        the lattice layout and the beta functions along with the horizontal dispertion function. This is very,</span>

<span class="s2">        very heavily reworked code, inspired by code from Guido Sterbini.</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            title (str): title of your plot.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 11).</span>

<span class="s2">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="s2">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="s2">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="s2">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="s2">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="s2">                not None, using the tuple passed.</span>

<span class="s2">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="s2">            plot_dipole_k1 (bool): if `True`, dipole elements with a quadrupolar gradient will have this</span>

<span class="s2">                gradient plotted as a quadrupole patch. Defaults to `False`.</span>

<span class="s2">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="s2">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="s2">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="s2">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="s2">            disp_ylim (Tuple[float, float]): vertical axis limits for the dispersion values.</span>

<span class="s2">                Defaults to (-10, 125).</span>

<span class="s2">            beta_ylim (Tuple[float, float]): vertical axis limits for the betatron function values.</span>

<span class="s2">                Defaults to None, to be determined by matplotlib based on the provided beta values.</span>

<span class="s2">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="s2">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="s2">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="s2">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="s2">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="s2">                height of sextupole patches.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="s2">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="s2">        WARNING:</span>

<span class="s2">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="s2">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="s2">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="s2">            overlap.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="s2">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting optics functions and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">()</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="err">[</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_dipole_k1</span><span class="o">=</span><span class="n">plot_dipole_k1</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting beta functions on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting beta functions&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">betx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">bety</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_{x,y}$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlabel</span><span class="p">(</span><span class="s2">&quot;$S$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting dispersion functions&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span> <span class="o">=</span> <span class="n">betatron_axis</span><span class="p">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;sienna&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="s2">&quot;$D_{x,y}$ $[m]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="no">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">beta_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for betatron functions plot&quot;</span><span class="p">)</span>

            <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">beta_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">disp_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for dispersion plot&quot;</span><span class="p">)</span>

            <span class="n">dispertion_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">disp_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving latwiss plot as {savefig}&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_machine_survey</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;Machine Layout&quot;</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">show_elements</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">high_orders</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active Cpymad class after having ran a script, will create a plot</span>

<span class="s2">        representing the machine geometry in 2D. Heavily reworked, original code is from Guido Sterbini.</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            title (str): title of your plot.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (16, 11).</span>

<span class="s2">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="s2">            show_elements (bool): if True, will try to plot by differentiating elements.</span>

<span class="s2">                Experimental, defaults to False.</span>

<span class="s2">            high_orders (bool): if True, plot sextupoles and octupoles when show_elements is True,</span>

<span class="s2">                otherwise only up to quadrupoles. Defaults to False.</span>

<span class="s2">        Keyword Arguments:</span>

<span class="s2">            Any keyword argument is transmiitted to `matplotlib.pyplot.scatter` calls later on.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="s2">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting machine survey&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Getting machine survey from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">survey</span><span class="p">()</span>

        <span class="n">survey</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">survey</span><span class="p">.</span><span class="n">dframe</span><span class="p">()</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_elements</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting survey with elements differentiation&quot;</span><span class="p">)</span>

            <span class="n">element_dfs</span> <span class="o">=</span> <span class="n">_make_survey_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span>

                <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;dipoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>

                <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;dipoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>

                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>

                <span class="n">c</span><span class="o">=</span><span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;dipoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">s</span><span class="p">,</span>

                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dipoles&quot;</span><span class="p">,</span>

                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;quad_foc&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;quad_foc&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QF&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;quad_defoc&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;quad_defoc&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">high_orders</span><span class="o">:</span>

                <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting high order magnetic elements (up to octupoles)&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;sextupoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span>

                    <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;octupoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">element_dfs</span><span class="err">[</span><span class="s2">&quot;octupoles&quot;</span><span class="err">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MO&quot;</span>

                <span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting survey without elements differentiation&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">survey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Trying a trick to ensure the colorbar scales values properly up to the max S value and not 1</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Plotting trick invisible data to re-scale colorbar&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">survey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">r</span><span class="s2">&quot;$S </span><span class="err">\</span><span class="s2"> [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$Z </span><span class="err">\</span><span class="s2"> [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="s2">&quot;$X </span><span class="err">\</span><span class="s2"> [m]$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving machine survey plot as {savefig}&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods_4">Static methods</h4>
<h4 id="plot_latwiss">plot_latwiss</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_latwiss</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">xoffset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">xlimits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_dipoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_dipole_k1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_quadrupoles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_bpms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">disp_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">125</span><span class="p">),</span>
    <span class="n">beta_ylim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">k0l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
    <span class="n">k1l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>
    <span class="n">k2l_lim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Provided with an active Cpymad class after having ran a script, will create a plot representing nicely
the lattice layout and the beta functions along with the horizontal dispertion function. This is very,
very heavily reworked code, inspired by code from Guido Sterbini.</p>
<p>Args:
    madx (cpymad.madx.Madx): an instanciated cpymad Madx object.
    title (str): title of your plot.
    figsize (Tuple[int, int]): size of the figure, defaults to (18, 11).
    savefig (str): will save the figure if this is not None, using the string value passed.
    xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want
        to center a plot around a specific point or element, which would then become located at s = 0.
        Beware this offset is applied before applying the <code>xlimits</code>. Offset defaults to 0 (no change).
    xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is
        not None, using the tuple passed.
    plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of
        the figure. Defaults to True. Dipoles are plotted in blue.
    plot_dipole_k1 (bool): if <code>True</code>, dipole elements with a quadrupolar gradient will have this
        gradient plotted as a quadrupole patch. Defaults to <code>False</code>.
    plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout
        subplot of the figure. Defaults to True. Quadrupoles are plotted in red.
    plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent
        Beam Position Monitors. BPMs are plotted in dark grey.
    disp_ylim (Tuple[float, float]): vertical axis limits for the dispersion values.
        Defaults to (-10, 125).
    beta_ylim (Tuple[float, float]): vertical axis limits for the betatron function values.
        Defaults to None, to be determined by matplotlib based on the provided beta values.
    k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the
        height of dipole patches. Defaults to (-0.25, 0.25).
    k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the
        height of quadrupole patches. Defaults to (-0.08, 0.08).
    k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of
        the figure, and the provided values act as vertical axis limits for the k2l values used for the
        height of sextupole patches.</p>
<p>Keyword Args:
    Any keyword argument to be transmitted to <code>_plot_machine_layout</code>, later on to <code>plot_lattice_series</code>
    and then <code>matplotlib.patches.Rectangle</code>, such as lw etc.</p>
<p>WARNING:
    Currently the function tries to plot legends for the different layout patches. The position of the
    different legends has been hardcoded in corners and might require users to tweak the axis limits
    (through <code>k0l_lim</code>, <code>k1l_lim</code> and <code>k2l_lim</code>) to ensure legend labels and plotted elements don't
    overlap.</p>
<p>Returns:
     The figure on which the plots are drawn. The underlying axes can be accessed with
     'fig.get_axes()'. Eventually saves the figure as a file.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_latwiss</span><span class="p">(</span>

        <span class="n">madx</span><span class="o">:</span> <span class="n">Madx</span><span class="p">,</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>

        <span class="n">savefig</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">xoffset</span><span class="o">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="n">xlimits</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">plot_dipoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_dipole_k1</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">plot_quadrupoles</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">True</span><span class="p">,</span>

        <span class="n">plot_bpms</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">disp_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">125</span><span class="p">),</span>

        <span class="n">beta_ylim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">k0l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>

        <span class="n">k1l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">),</span>

        <span class="n">k2l_lim</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Provided with an active Cpymad class after having ran a script, will create a plot representing nicely</span>

<span class="s2">        the lattice layout and the beta functions along with the horizontal dispertion function. This is very,</span>

<span class="s2">        very heavily reworked code, inspired by code from Guido Sterbini.</span>

<span class="s2">        Args:</span>

<span class="s2">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="s2">            title (str): title of your plot.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (18, 11).</span>

<span class="s2">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="s2">            xoffset (float): An offset applied to the S coordinate before plotting. This is useful is you want</span>

<span class="s2">                to center a plot around a specific point or element, which would then become located at s = 0.</span>

<span class="s2">                Beware this offset is applied before applying the `xlimits`. Offset defaults to 0 (no change).</span>

<span class="s2">            xlimits (Tuple[float, float]): will implement xlim (for the s coordinate) if this is</span>

<span class="s2">                not None, using the tuple passed.</span>

<span class="s2">            plot_dipoles (bool): if True, dipole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure. Defaults to True. Dipoles are plotted in blue.</span>

<span class="s2">            plot_dipole_k1 (bool): if `True`, dipole elements with a quadrupolar gradient will have this</span>

<span class="s2">                gradient plotted as a quadrupole patch. Defaults to `False`.</span>

<span class="s2">            plot_quadrupoles (bool): if True, quadrupole patches will be plotted on the layout</span>

<span class="s2">                subplot of the figure. Defaults to True. Quadrupoles are plotted in red.</span>

<span class="s2">            plot_bpms (bool): if True, additional patches will be plotted on the layout subplot to represent</span>

<span class="s2">                Beam Position Monitors. BPMs are plotted in dark grey.</span>

<span class="s2">            disp_ylim (Tuple[float, float]): vertical axis limits for the dispersion values.</span>

<span class="s2">                Defaults to (-10, 125).</span>

<span class="s2">            beta_ylim (Tuple[float, float]): vertical axis limits for the betatron function values.</span>

<span class="s2">                Defaults to None, to be determined by matplotlib based on the provided beta values.</span>

<span class="s2">            k0l_lim (Tuple[float, float]): vertical axis limits for the k0l values used for the</span>

<span class="s2">                height of dipole patches. Defaults to (-0.25, 0.25).</span>

<span class="s2">            k1l_lim (Tuple[float, float]): vertical axis limits for the k1l values used for the</span>

<span class="s2">                height of quadrupole patches. Defaults to (-0.08, 0.08).</span>

<span class="s2">            k2l_lim (Tuple[float, float]): if given, sextupole patches will be plotted on the layout subplot of</span>

<span class="s2">                the figure, and the provided values act as vertical axis limits for the k2l values used for the</span>

<span class="s2">                height of sextupole patches.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument to be transmitted to `_plot_machine_layout`, later on to `plot_lattice_series`</span>

<span class="s2">            and then `matplotlib.patches.Rectangle`, such as lw etc.</span>

<span class="s2">        WARNING:</span>

<span class="s2">            Currently the function tries to plot legends for the different layout patches. The position of the</span>

<span class="s2">            different legends has been hardcoded in corners and might require users to tweak the axis limits</span>

<span class="s2">            (through `k0l_lim`, `k1l_lim` and `k2l_lim`) to ensure legend labels and plotted elements don&#39;t</span>

<span class="s2">            overlap.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="s2">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="c1"># pylint: disable=too-many-arguments</span>

        <span class="c1"># Restrict the span of twiss_df to avoid plotting all elements then cropping when xlimits is given</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting optics functions and machine layout&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting Twiss dataframe from cpymad&quot;</span><span class="p">)</span>

        <span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">twiss</span><span class="p">()</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">madx</span><span class="p">.</span><span class="k">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">dframe</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">xoffset</span>

        <span class="n">xlimits</span> <span class="o">=</span> <span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">xlimits</span>

        <span class="n">twiss_df</span> <span class="o">=</span> <span class="n">twiss_df</span><span class="err">[</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="k">between</span><span class="p">(</span><span class="o">*</span><span class="n">xlimits</span><span class="p">)</span><span class="err">]</span> <span class="k">if</span> <span class="n">xlimits</span> <span class="k">else</span> <span class="n">twiss_df</span>

        <span class="c1"># Create a subplot for the lattice patches (takes a third of figure)</span>

        <span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">quadrupole_patches_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">_plot_machine_layout</span><span class="p">(</span>

            <span class="n">madx</span><span class="p">,</span>

            <span class="n">quadrupole_patches_axis</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">,</span>

            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>

            <span class="n">xoffset</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span>

            <span class="n">xlimits</span><span class="o">=</span><span class="n">xlimits</span><span class="p">,</span>

            <span class="n">plot_dipoles</span><span class="o">=</span><span class="n">plot_dipoles</span><span class="p">,</span>

            <span class="n">plot_dipole_k1</span><span class="o">=</span><span class="n">plot_dipole_k1</span><span class="p">,</span>

            <span class="n">plot_quadrupoles</span><span class="o">=</span><span class="n">plot_quadrupoles</span><span class="p">,</span>

            <span class="n">plot_bpms</span><span class="o">=</span><span class="n">plot_bpms</span><span class="p">,</span>

            <span class="n">k0l_lim</span><span class="o">=</span><span class="n">k0l_lim</span><span class="p">,</span>

            <span class="n">k1l_lim</span><span class="o">=</span><span class="n">k1l_lim</span><span class="p">,</span>

            <span class="n">k2l_lim</span><span class="o">=</span><span class="n">k2l_lim</span><span class="p">,</span>

            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="c1"># Plotting beta functions on remaining two thirds of the figure</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting beta functions&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">quadrupole_patches_axis</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">betx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">bety</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">beta_{x,y}$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlabel</span><span class="p">(</span><span class="s2">&quot;$S$ $[m]$&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plotting dispersion functions&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span> <span class="o">=</span> <span class="n">betatron_axis</span><span class="p">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_x$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twiss_df</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">twiss_df</span><span class="p">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;sienna&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$D_y$&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylabel</span><span class="p">(</span><span class="s2">&quot;$D_{x,y}$ $[m]$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;brown&quot;</span><span class="p">)</span>

        <span class="n">dispertion_axis</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="no">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">beta_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for betatron functions plot&quot;</span><span class="p">)</span>

            <span class="n">betatron_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">beta_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">disp_ylim</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting ylim for dispersion plot&quot;</span><span class="p">)</span>

            <span class="n">dispertion_axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="n">disp_ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlimits</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting xlim for longitudinal coordinate&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlimits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving latwiss plot as {savefig}&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<h4 id="plot_machine_survey">plot_machine_survey</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_machine_survey</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Machine Layout&#39;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">show_elements</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">high_orders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Provided with an active Cpymad class after having ran a script, will create a plot
representing the machine geometry in 2D. Heavily reworked, original code is from Guido Sterbini.</p>
<p>Args:
    madx (cpymad.madx.Madx): an instanciated cpymad Madx object.
    title (str): title of your plot.
    figsize (Tuple[int, int]): size of the figure, defaults to (16, 11).
    savefig (str): will save the figure if this is not None, using the string value passed.
    show_elements (bool): if True, will try to plot by differentiating elements.
        Experimental, defaults to False.
    high_orders (bool): if True, plot sextupoles and octupoles when show_elements is True,
        otherwise only up to quadrupoles. Defaults to False.</p>
<p>Keyword Arguments:
    Any keyword argument is transmiitted to <code>matplotlib.pyplot.scatter</code> calls later on.</p>
<p>Returns:
     The figure on which the plots are drawn. The underlying axes can be accessed with
     'fig.get_axes()'. Eventually saves the figure as a file.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_machine_survey</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">title</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Machine Layout&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">figsize</span><span class="p">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">show_elements</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">high_orders</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Provided with an active Cpymad class after having ran a script, will create a plot</span>

<span class="ss">        representing the machine geometry in 2D. Heavily reworked, original code is from Guido Sterbini.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            title (str): title of your plot.</span>

<span class="ss">            figsize (Tuple[int, int]): size of the figure, defaults to (16, 11).</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">            show_elements (bool): if True, will try to plot by differentiating elements.</span>

<span class="ss">                Experimental, defaults to False.</span>

<span class="ss">            high_orders (bool): if True, plot sextupoles and octupoles when show_elements is True,</span>

<span class="ss">                otherwise only up to quadrupoles. Defaults to False.</span>

<span class="ss">        Keyword Arguments:</span>

<span class="ss">            Any keyword argument is transmiitted to `matplotlib.pyplot.scatter` calls later on.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting machine survey&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Getting machine survey from cpymad&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">madx</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">survey</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">survey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">survey</span><span class="p">.</span><span class="n">dframe</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">show_elements</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting survey with elements differentiation&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">element_dfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_survey_groups</span><span class="p">(</span><span class="n">madx</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;dipoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;dipoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;.&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">c</span><span class="o">=</span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;dipoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;Dipoles&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;quad_foc&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;quad_foc&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;QF&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;quad_defoc&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;quad_defoc&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;QD&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nl">high_orders</span><span class="p">:</span><span class="w"></span>

<span class="w">                </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting high order magnetic elements (up to octupoles)&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;sextupoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;sextupoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;m&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;MS&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="w"></span>

<span class="w">                    </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;octupoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">element_dfs</span><span class="o">[</span><span class="n">&quot;octupoles&quot;</span><span class="o">]</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">&quot;cyan&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="ss">&quot;MO&quot;</span><span class="w"></span>

<span class="w">                </span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Plotting survey without elements differentiation&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">survey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Trying</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">trick</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">colorbar</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="n">properly</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">max</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="ss">&quot;Plotting trick invisible data to re-scale colorbar&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">survey</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">survey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">survey</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">r</span><span class="ss">&quot;$S \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="ss">&quot;equal&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$Z \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$X \ [m]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving machine survey plot as {savefig}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="phasespaceplotter">PhaseSpacePlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PhaseSpacePlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">PhaseSpacePlotter</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="ss">&quot;&quot;&quot;A class to plot Courant-Snyder coordinates phase space.&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_courant_snyder_phase_space</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">u_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">pu_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">size</span><span class="err">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">plane</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Horizontal&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="ss">        and momentum coordinates for a specific plane.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="ss">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="ss">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="ss">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="ss">                and so on.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="ss">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;VERTICAL&quot;</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plane should be either Horizontal or Vertical but &#39;{plane}&#39; was given&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid plane value&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="k">size</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="ss">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">twiss</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">compute</span><span class="w"> </span><span class="n">Courant</span><span class="o">-</span><span class="n">Snyder</span><span class="w"> </span><span class="n">coordinates</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfy</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">betx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">bety</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting phase space for the {plane.lower()} plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Getting and plotting Courant-Snyder coordinates for particle {index}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">u_coordinates[index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">pu_coordinates</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u_bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="o">[</span><span class="n">0, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">u_bar</span><span class="o">[</span><span class="n">1, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{x} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{px} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{y} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{py} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="ss">&quot;Equal&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving Courant-Snyder phase space plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>

<span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_courant_snyder_phase_space_colored</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">u_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">pu_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">size</span><span class="err">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">plane</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Horizontal&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="ss">        and momentum coordinates for a specific plane. Each particle trajectory has its own color on</span>

<span class="ss">        the plot, within the limit of pyplot&#39;s 156 named colors. The sequence repeats after the</span>

<span class="ss">        156th color.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="ss">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="ss">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="ss">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="ss">                and so on.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="ss">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;VERTICAL&quot;</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plane should be either horizontal or vertical but &#39;{plane}&#39; was given&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid plane value&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sufficiently</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">colors</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"></span>

<span class="w">        </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SORTED_COLORS</span><span class="w"></span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">colors</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting colored phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="k">size</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="ss">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">twiss</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">compute</span><span class="w"> </span><span class="n">Courant</span><span class="o">-</span><span class="n">Snyder</span><span class="w"> </span><span class="n">coordinates</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfy</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">betx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">bety</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting colored phase space for the {plane.lower()} plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Getting and plotting Courant-Snyder coordinates for particle {index}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">u_coordinates[index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">pu_coordinates</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u_bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="o">[</span><span class="n">0, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">u_bar</span><span class="o">[</span><span class="n">1, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{x} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{px} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{y} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{py} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="ss">&quot;Equal&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving colored Courant-Snyder phase space plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<hr />
<h4 id="static-methods_5">Static methods</h4>
<h4 id="plot_courant_snyder_phase_space">plot_courant_snyder_phase_space</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_courant_snyder_phase_space</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">u_coordinates</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pu_coordinates</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Horizontal&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Plots the Courant-Snyder phase space of a particle distribution when provided by position</p>
<p>and momentum coordinates for a specific plane.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>u_coordinates</td>
<td>np.ndarray</td>
<td>numpy array of particles' coordinates for the given plane. Here</td>
<td></td>
</tr>
<tr>
<td>u_coordinates[0] should be all tracked coordinates for the first particle and so on.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>pu_coordinates</td>
<td>np.ndarray</td>
<td>numpy array of particles' momentum coordinates for the</td>
<td></td>
</tr>
<tr>
<td>given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>and so on.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>savefig</td>
<td>str</td>
<td>will save the figure if this is not None, using the string value passed.</td>
<td>None</td>
</tr>
<tr>
<td>size</td>
<td>Tuple[int, int]</td>
<td>the wanted matplotlib figure size. Defaults to (16, 8).</td>
<td>(16, 8)</td>
</tr>
<tr>
<td>plane</td>
<td>str</td>
<td>the physical plane to plot. Defaults to 'Horizontal'.</td>
<td>'Horizontal'</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The figure on which the plots are drawn. The underlying axes can be accessed with</td>
</tr>
<tr>
<td>'fig.get_axes()'. Eventually saves the figure as a file.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_courant_snyder_phase_space</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">u_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">pu_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">size</span><span class="err">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">plane</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Horizontal&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="ss">        and momentum coordinates for a specific plane.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="ss">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="ss">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="ss">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="ss">                and so on.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="ss">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;VERTICAL&quot;</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plane should be either Horizontal or Vertical but &#39;{plane}&#39; was given&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid plane value&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="k">size</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="ss">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">twiss</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">compute</span><span class="w"> </span><span class="n">Courant</span><span class="o">-</span><span class="n">Snyder</span><span class="w"> </span><span class="n">coordinates</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfy</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">betx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">bety</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting phase space for the {plane.lower()} plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Getting and plotting Courant-Snyder coordinates for particle {index}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">u_coordinates[index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">pu_coordinates</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u_bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="o">[</span><span class="n">0, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">u_bar</span><span class="o">[</span><span class="n">1, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{x} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{px} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{y} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{py} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="ss">&quot;Equal&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving Courant-Snyder phase space plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="plot_courant_snyder_phase_space_colored">plot_courant_snyder_phase_space_colored</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_courant_snyder_phase_space_colored</span><span class="p">(</span>
    <span class="n">madx</span><span class="p">:</span> <span class="n">cpymad</span><span class="o">.</span><span class="n">madx</span><span class="o">.</span><span class="n">Madx</span><span class="p">,</span>
    <span class="n">u_coordinates</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pu_coordinates</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">savefig</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Horizontal&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Plots the Courant-Snyder phase space of a particle distribution when provided by position</p>
<p>and momentum coordinates for a specific plane. Each particle trajectory has its own color on
the plot, within the limit of pyplot's 156 named colors. The sequence repeats after the
156<sup>th</sup> color.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>madx</td>
<td>cpymad.madx.Madx</td>
<td>an instanciated cpymad Madx object.</td>
<td>None</td>
</tr>
<tr>
<td>u_coordinates</td>
<td>np.ndarray</td>
<td>numpy array of particles' coordinates for the given plane. Here</td>
<td></td>
</tr>
<tr>
<td>u_coordinates[0] should be all tracked coordinates for the first particle and so on.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>pu_coordinates</td>
<td>np.ndarray</td>
<td>numpy array of particles' momentum coordinates for the</td>
<td></td>
</tr>
<tr>
<td>given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>and so on.</td>
<td>None</td>
<td></td>
<td></td>
</tr>
<tr>
<td>savefig</td>
<td>str</td>
<td>will save the figure if this is not None, using the string value passed.</td>
<td>None</td>
</tr>
<tr>
<td>size</td>
<td>Tuple[int, int]</td>
<td>the wanted matplotlib figure size. Defaults to (16, 8).</td>
<td>(16, 8)</td>
</tr>
<tr>
<td>plane</td>
<td>str</td>
<td>the physical plane to plot. Defaults to 'Horizontal'.</td>
<td>'Horizontal'</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The figure on which the plots are drawn. The underlying axes can be accessed with</td>
</tr>
<tr>
<td>'fig.get_axes()'. Eventually saves the figure as a file.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot_courant_snyder_phase_space_colored</span><span class="p">(</span><span class="w"></span>

<span class="w">        </span><span class="nl">madx</span><span class="p">:</span><span class="w"> </span><span class="n">Madx</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">u_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">pu_coordinates</span><span class="p">:</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nl">savefig</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="k">size</span><span class="err">:</span><span class="w"> </span><span class="n">Tuple</span><span class="o">[</span><span class="n">int, int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="nl">plane</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Horizontal&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="nl">Figure</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Plots the Courant-Snyder phase space of a particle distribution when provided by position</span>

<span class="ss">        and momentum coordinates for a specific plane. Each particle trajectory has its own color on</span>

<span class="ss">        the plot, within the limit of pyplot&#39;s 156 named colors. The sequence repeats after the</span>

<span class="ss">        156th color.</span>

<span class="ss">        Args:</span>

<span class="ss">            madx (cpymad.madx.Madx): an instanciated cpymad Madx object.</span>

<span class="ss">            u_coordinates (np.ndarray): numpy array of particles&#39; coordinates for the given plane. Here</span>

<span class="ss">                u_coordinates[0] should be all tracked coordinates for the first particle and so on.</span>

<span class="ss">            pu_coordinates (np.ndarray): numpy array of particles&#39; momentum coordinates for the</span>

<span class="ss">                given plane.Here pu_coordinates[0] should be all tracked momenta for the first particle</span>

<span class="ss">                and so on.</span>

<span class="ss">            savefig (str): will save the figure if this is not None, using the string value passed.</span>

<span class="ss">            size (Tuple[int, int]): the wanted matplotlib figure size. Defaults to (16, 8).</span>

<span class="ss">            plane (str): the physical plane to plot. Defaults to &#39;Horizontal&#39;.</span>

<span class="ss">        Returns:</span>

<span class="ss">             The figure on which the plots are drawn. The underlying axes can be accessed with</span>

<span class="ss">             &#39;fig.get_axes()&#39;. Eventually saves the figure as a file.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;VERTICAL&quot;</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plane should be either horizontal or vertical but &#39;{plane}&#39; was given&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid plane value&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sufficiently</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">colors</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"></span>

<span class="w">        </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SORTED_COLORS</span><span class="w"></span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">colors</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="ss">&quot;Plotting colored phase space for normalized Courant-Snyder coordinates&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">figure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="k">size</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="ss">&quot;Courant-Snyder Phase Space&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Getting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">twiss</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">compute</span><span class="w"> </span><span class="n">Courant</span><span class="o">-</span><span class="n">Snyder</span><span class="w"> </span><span class="n">coordinates</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="ss">&quot;Getting Twiss functions from MAD-X&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">alfy</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">betx</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">madx</span><span class="p">.</span><span class="nc">table</span><span class="p">.</span><span class="n">twiss</span><span class="p">.</span><span class="n">bety</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Plotting colored phase space for the {plane.lower()} plane&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">u_coordinates</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Getting and plotting Courant-Snyder coordinates for particle {index}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">u_coordinates[index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">pu_coordinates</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="err">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">u_bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">courant_snyder_transform</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u_bar</span><span class="o">[</span><span class="n">0, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">u_bar</span><span class="o">[</span><span class="n">1, :</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">plane</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;HORIZONTAL&quot;</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{x} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{px} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{y} \ [mm]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">r</span><span class="ss">&quot;$\bar{py} \ [mrad]$&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="ss">&quot;Equal&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">savefig</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Saving colored Courant-Snyder phase space plot at &#39;{Path(savefig).absolute()}&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="k">Path</span><span class="p">(</span><span class="n">savefig</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">figure</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="tunediagramplotter">TuneDiagramPlotter</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TuneDiagramPlotter</span><span class="p">(</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">class</span> <span class="n">TuneDiagramPlotter</span><span class="o">:</span>

    <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A class to plot a blank tune diagram with Farey sequences, as well as your working points.</span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

    <span class="n">order_to_alpha</span><span class="o">:</span> <span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="err">{</span><span class="mi">1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">3</span><span class="o">:</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mi">4</span><span class="o">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">5</span><span class="o">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mi">6</span><span class="o">:</span> <span class="mf">0.35</span><span class="err">}</span>

    <span class="n">order_to_rgb</span><span class="o">:</span> <span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="err">]</span> <span class="o">=</span> <span class="err">{</span>

        <span class="mi">1</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">152</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">48</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a brown</span>

        <span class="mi">2</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">57</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">175</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a blue</span>

        <span class="mi">3</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">239</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">54</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># an orange</span>

        <span class="mi">4</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">82</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">62</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a green</span>

        <span class="mi">5</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">197</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">50</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a red</span>

        <span class="mi">6</span><span class="o">:</span> <span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="err">[</span><span class="mi">141</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">184</span><span class="err">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># a purple</span>

    <span class="err">}</span>

    <span class="n">order_to_linestyle</span><span class="o">:</span> <span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="n">str</span><span class="err">]</span> <span class="o">=</span> <span class="err">{</span>

        <span class="mi">1</span><span class="o">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">2</span><span class="o">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">3</span><span class="o">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>

        <span class="mi">4</span><span class="o">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="o">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="o">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span>

    <span class="err">}</span>

    <span class="n">order_to_linewidth</span><span class="o">:</span> <span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="err">{</span><span class="mi">1</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">3</span><span class="o">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">4</span><span class="o">:</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">5</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="o">:</span> <span class="mf">0.75</span><span class="err">}</span>

    <span class="n">order_to_label</span><span class="o">:</span> <span class="n">Dict</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="n">str</span><span class="err">]</span> <span class="o">=</span> <span class="err">{</span>

        <span class="mi">1</span><span class="o">:</span> <span class="s2">&quot;1st order&quot;</span><span class="p">,</span>

        <span class="mi">2</span><span class="o">:</span> <span class="s2">&quot;2nd order&quot;</span><span class="p">,</span>

        <span class="mi">3</span><span class="o">:</span> <span class="s2">&quot;3rd order&quot;</span><span class="p">,</span>

        <span class="mi">4</span><span class="o">:</span> <span class="s2">&quot;4th order&quot;</span><span class="p">,</span>

        <span class="mi">5</span><span class="o">:</span> <span class="s2">&quot;5th order&quot;</span><span class="p">,</span>

        <span class="mi">6</span><span class="o">:</span> <span class="s2">&quot;6th order&quot;</span><span class="p">,</span>

    <span class="err">}</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">farey_sequence</span><span class="p">(</span><span class="k">order</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">List</span><span class="err">[</span><span class="n">Tuple</span><span class="err">[</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="err">]]</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Returns the n-th farey_sequence sequence, ascending. Original code from Rogelio Tomás (see Numerical</span>

<span class="s2">        Methods 2018 CAS proceedings: https://arxiv.org/abs/2006.10661).</span>

<span class="s2">        Args:</span>

<span class="s2">            order (int): the order up to which we want to calculate the sequence.</span>

<span class="s2">        Returns:</span>

<span class="s2">            The sequence as a list of plottable 2D points.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Computing Farey sequence for order {order}&quot;</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="err">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="err">]]</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">order</span>

        <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="k">order</span><span class="o">:</span>

            <span class="n">k</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="k">order</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span>

            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">b</span>

            <span class="n">seq</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">seq</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">_plot_resonance_lines_for_order</span><span class="p">(</span><span class="k">order</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">axis</span><span class="o">:</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">Axes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">None</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Plot resonance lines from farey sequences of the given order on the current figure.</span>

<span class="s2">        Args:</span>

<span class="s2">            order (int): the order of the resonance.</span>

<span class="s2">            axis (matplotlib.axes.Axes): the axis on which to plot the resonance lines.</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument is given to plt.plot().</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="n">order_label</span> <span class="o">=</span> <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_label</span><span class="err">[</span><span class="k">order</span><span class="err">]</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting {order_label} resonance lines&quot;</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="err">[]</span><span class="p">,</span> <span class="err">[]</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">order_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># to avoid legend duplication in loops below</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">farey_sequences</span> <span class="o">=</span> <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">farey_sequence</span><span class="p">(</span><span class="k">order</span><span class="p">)</span>

        <span class="n">clip</span> <span class="o">=</span> <span class="k">partial</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># clip all values to plot to [0, 1]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="k">in</span> <span class="n">farey_sequences</span><span class="o">:</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">node</span>  <span class="c1"># Node h/k on the axes</span>

            <span class="k">for</span> <span class="n">sequence</span> <span class="k">in</span> <span class="n">farey_sequences</span><span class="o">:</span>

                <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">sequence</span>

                <span class="n">a</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Resonance line a*Qx + b*Qy = c (linked to p/q)</span>

                <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">:</span>

                    <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">p</span><span class="p">),</span> <span class="kt">float</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">axis</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="n">k</span> <span class="k">and</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="o">:</span>  <span class="c1"># FN elements below 1/k</span>

                    <span class="n">break</span>

    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_tune_diagram</span><span class="p">(</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

        <span class="n">legend_title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">max_order</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

        <span class="n">differentiate_orders</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Plotting the tune diagram up to the 6th order. Original code from Rogelio Tomás.</span>

<span class="s2">        The first order lines make up the [(0, 0), (0, 1), (1, 1), (1, 0)] square and will only be seen</span>

<span class="s2">        when redefining the limits of the figure, which are by default [0, 1] on each axis.</span>

<span class="s2">        Args:</span>

<span class="s2">            title (str): title of your plot, to be given to the figure. Defaults to an empty string.</span>

<span class="s2">            legend_title (str): if given, will be used as the title of the plot&#39;s legend. If set to `None`,</span>

<span class="s2">                then creating a legend for the figure will not be done by this function and left up to the</span>

<span class="s2">                user&#39;s care (a call to `pyplot.legend` will do). Defaults to `None`.</span>

<span class="s2">            max_order (int): the order up to which to plot resonance lines for, should not exceed 6.</span>

<span class="s2">                Defaults to 6.</span>

<span class="s2">            differentiate_orders (bool): if `True`, the lines for each order will be of a different color.</span>

<span class="s2">                When set to False, there is still minimal differentation through alpha, linewidth and</span>

<span class="s2">                linestyle. Defaults to `False`.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (12, 12).</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument will be transmitted to the `_plot_resonance_lines_for_order` functino</span>

<span class="s2">            and later on to `pyplot.plot`. Be aware that `alpha`, `ls`, `lw`, `color` and `label` are</span>

<span class="s2">            already set by this function and providing them as kwargs might lead to errors.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which resonance lines from farey sequences are drawn, up to the specified max</span>

<span class="s2">             order.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">max_order</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="k">or</span> <span class="n">max_order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="k">error</span><span class="p">(</span><span class="s2">&quot;Plotting is not supported outside of 1st-6th order (and not recommended)&quot;</span><span class="p">)</span>

            <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;max_order&#39; argument should be between 1 and 6 included&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting resonance lines up to {TuneDiagramPlotter.order_to_label[max_order]}&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="k">order</span> <span class="k">in</span> <span class="k">range</span><span class="p">(</span><span class="n">max_order</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>  <span class="c1"># high -&gt; low so most importants ones (low) are plotted on top</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_alpha</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_linestyle</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_linewidth</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_rgb</span><span class="err">[</span><span class="k">order</span><span class="err">]</span> <span class="k">if</span> <span class="n">differentiate_orders</span> <span class="k">is</span> <span class="no">True</span> <span class="k">else</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">_plot_resonance_lines_for_order</span><span class="p">(</span>

                <span class="k">order</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>

            <span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlim</span><span class="p">(</span><span class="err">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="err">]</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="err">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="err">]</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$Q_{x}$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$Q_{y}$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend_title</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding legend with given title&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">legend_title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
<hr />
<h4 id="class-variables">Class variables</h4>
<div class="highlight"><pre><span></span><code><span class="n">order_to_alpha</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">order_to_label</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">order_to_linestyle</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">order_to_linewidth</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">order_to_rgb</span>
</code></pre></div>
<h4 id="static-methods_6">Static methods</h4>
<h4 id="farey_sequence">farey_sequence</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">farey_sequence</span><span class="p">(</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
</code></pre></div>
<p>Returns the n-th farey_sequence sequence, ascending. Original code from Rogelio Tomás (see Numerical</p>
<p>Methods 2018 CAS proceedings: <a href="https://arxiv.org/abs/2006.10661">https://arxiv.org/abs/2006.10661</a>).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>order</td>
<td>int</td>
<td>the order up to which we want to calculate the sequence.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>The sequence as a list of plottable 2D points.</td>
</tr>
</tbody>
</table>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">farey_sequence</span><span class="p">(</span><span class="k">order</span><span class="err">:</span><span class="w"> </span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">List</span><span class="o">[</span><span class="n">Tuple[int, int</span><span class="o">]</span><span class="err">]:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Returns the n-th farey_sequence sequence, ascending. Original code from Rogelio Tomás (see Numerical</span>

<span class="ss">        Methods 2018 CAS proceedings: https://arxiv.org/abs/2006.10661).</span>

<span class="ss">        Args:</span>

<span class="ss">            order (int): the order up to which we want to calculate the sequence.</span>

<span class="ss">        Returns:</span>

<span class="ss">            The sequence as a list of plottable 2D points.</span>

<span class="ss">        &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Computing Farey sequence for order {order}&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">[0, 1</span><span class="o">]</span><span class="err">]</span><span class="w"></span>

<span class="w">        </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">order</span><span class="w"></span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">order</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">int</span><span class="p">((</span><span class="k">order</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="w"></span>

<span class="w">            </span><span class="n">seq</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">seq</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="plot_tune_diagram">plot_tune_diagram</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_tune_diagram</span><span class="p">(</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">legend_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">differentiate_orders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>
</code></pre></div>
<p>Plotting the tune diagram up to the 6<sup>th</sup> order. Original code from Rogelio Tomás.
The first order lines make up the [(0, 0), (0, 1), (1, 1), (1, 0)] square and will only be seen
when redefining the limits of the figure, which are by default [0, 1] on each axis.</p>
<p>Args:
    title (str): title of your plot, to be given to the figure. Defaults to an empty string.
    legend_title (str): if given, will be used as the title of the plot's legend. If set to <code>None</code>,
        then creating a legend for the figure will not be done by this function and left up to the
        user's care (a call to <code>pyplot.legend</code> will do). Defaults to <code>None</code>.
    max_order (int): the order up to which to plot resonance lines for, should not exceed 6.
        Defaults to 6.
    differentiate_orders (bool): if <code>True</code>, the lines for each order will be of a different color.
        When set to False, there is still minimal differentation through alpha, linewidth and
        linestyle. Defaults to <code>False</code>.
    figsize (Tuple[int, int]): size of the figure, defaults to (12, 12).</p>
<p>Keyword Args:
    Any keyword argument will be transmitted to the <code>_plot_resonance_lines_for_order</code> functino
    and later on to <code>pyplot.plot</code>. Be aware that <code>alpha</code>, <code>ls</code>, <code>lw</code>, <code>color</code> and <code>label</code> are
    already set by this function and providing them as kwargs might lead to errors.</p>
<p>Returns:
     The figure on which resonance lines from farey sequences are drawn, up to the specified max
     order.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">@staticmethod</span>

    <span class="n">def</span> <span class="n">plot_tune_diagram</span><span class="p">(</span>

        <span class="n">title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>

        <span class="n">legend_title</span><span class="o">:</span> <span class="n">str</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span>

        <span class="n">max_order</span><span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

        <span class="n">differentiate_orders</span><span class="o">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="no">False</span><span class="p">,</span>

        <span class="n">figsize</span><span class="o">:</span> <span class="n">Tuple</span><span class="err">[</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="err">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>

        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">Figure</span><span class="o">:</span>

        <span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"></span>

<span class="s2">        Plotting the tune diagram up to the 6th order. Original code from Rogelio Tomás.</span>

<span class="s2">        The first order lines make up the [(0, 0), (0, 1), (1, 1), (1, 0)] square and will only be seen</span>

<span class="s2">        when redefining the limits of the figure, which are by default [0, 1] on each axis.</span>

<span class="s2">        Args:</span>

<span class="s2">            title (str): title of your plot, to be given to the figure. Defaults to an empty string.</span>

<span class="s2">            legend_title (str): if given, will be used as the title of the plot&#39;s legend. If set to `None`,</span>

<span class="s2">                then creating a legend for the figure will not be done by this function and left up to the</span>

<span class="s2">                user&#39;s care (a call to `pyplot.legend` will do). Defaults to `None`.</span>

<span class="s2">            max_order (int): the order up to which to plot resonance lines for, should not exceed 6.</span>

<span class="s2">                Defaults to 6.</span>

<span class="s2">            differentiate_orders (bool): if `True`, the lines for each order will be of a different color.</span>

<span class="s2">                When set to False, there is still minimal differentation through alpha, linewidth and</span>

<span class="s2">                linestyle. Defaults to `False`.</span>

<span class="s2">            figsize (Tuple[int, int]): size of the figure, defaults to (12, 12).</span>

<span class="s2">        Keyword Args:</span>

<span class="s2">            Any keyword argument will be transmitted to the `_plot_resonance_lines_for_order` functino</span>

<span class="s2">            and later on to `pyplot.plot`. Be aware that `alpha`, `ls`, `lw`, `color` and `label` are</span>

<span class="s2">            already set by this function and providing them as kwargs might lead to errors.</span>

<span class="s2">        Returns:</span>

<span class="s2">             The figure on which resonance lines from farey sequences are drawn, up to the specified max</span>

<span class="s2">             order.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">max_order</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="k">or</span> <span class="n">max_order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="k">error</span><span class="p">(</span><span class="s2">&quot;Plotting is not supported outside of 1st-6th order (and not recommended)&quot;</span><span class="p">)</span>

            <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;max_order&#39; argument should be between 1 and 6 included&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Plotting resonance lines up to {TuneDiagramPlotter.order_to_label[max_order]}&quot;</span><span class="p">)</span>

        <span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="k">order</span> <span class="k">in</span> <span class="k">range</span><span class="p">(</span><span class="n">max_order</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>  <span class="c1"># high -&gt; low so most importants ones (low) are plotted on top</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_alpha</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_linestyle</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_linewidth</span><span class="err">[</span><span class="k">order</span><span class="err">]</span><span class="p">,</span>

                <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">order_to_rgb</span><span class="err">[</span><span class="k">order</span><span class="err">]</span> <span class="k">if</span> <span class="n">differentiate_orders</span> <span class="k">is</span> <span class="no">True</span> <span class="k">else</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>

            <span class="p">)</span>

            <span class="n">TuneDiagramPlotter</span><span class="p">.</span><span class="n">_plot_resonance_lines_for_order</span><span class="p">(</span>

                <span class="k">order</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>

            <span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_xlim</span><span class="p">(</span><span class="err">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="err">]</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">.</span><span class="k">set</span><span class="n">_ylim</span><span class="p">(</span><span class="err">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="err">]</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$Q_{x}$&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$Q_{y}$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend_title</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="o">:</span>

            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding legend with given title&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">legend_title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure</span>
</code></pre></div>

</details>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../parameters/" title="Parameters" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Parameters
              </span>
            </div>
          </a>
        
        
          <a href="../ptc/" title="Ptc" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Ptc
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>